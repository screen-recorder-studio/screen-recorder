<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OPFS Drive åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: #f9f9f9;
        }
        button {
            padding: 8px 16px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007bff;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #0056b3;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª OPFS Drive åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>ğŸ“ åˆ›å»ºæµ‹è¯•å½•åˆ¶æ•°æ®</h3>
        <p>åˆ›å»ºä¸€äº›æ¨¡æ‹Ÿçš„å½•åˆ¶æ•°æ®æ¥æµ‹è¯•å…¨éƒ¨åˆ é™¤åŠŸèƒ½</p>
        <button onclick="createTestRecordings()">åˆ›å»ºæµ‹è¯•æ•°æ®</button>
        <button onclick="checkOPFS()">æ£€æŸ¥ OPFS çŠ¶æ€</button>
    </div>

    <div class="test-section">
        <h3>ğŸ—‘ï¸ æµ‹è¯•åˆ é™¤åŠŸèƒ½</h3>
        <p>æµ‹è¯•å•ä¸ªåˆ é™¤å’Œæ‰¹é‡åˆ é™¤åŠŸèƒ½</p>
        <button onclick="listRecordings()">åˆ—å‡ºå½•åˆ¶</button>
        <button onclick="deleteFirstRecording()">åˆ é™¤ç¬¬ä¸€ä¸ª</button>
        <button class="danger" onclick="deleteAllRecordings()">åˆ é™¤å…¨éƒ¨</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š OPFS Drive é¡µé¢</h3>
        <p>æ‰“å¼€å®é™…çš„ OPFS Drive è°ƒè¯•é¡µé¢</p>
        <button onclick="openOPFSDrive()">æ‰“å¼€ OPFS Drive</button>
    </div>

    <div class="log" id="log"></div>

    <script>
        function log(message) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logEl.textContent += `[${timestamp}] ${message}\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function checkOPFS() {
            try {
                if (!navigator.storage?.getDirectory) {
                    log('âŒ OPFS ä¸å¯ç”¨');
                    return;
                }
                
                const root = await navigator.storage.getDirectory();
                log('âœ… OPFS å¯ç”¨');
                
                const estimate = await navigator.storage.estimate();
                log(`ğŸ“Š å­˜å‚¨ç”¨é‡: ${Math.round(estimate.usage / 1024)} KB / ${Math.round(estimate.quota / 1024 / 1024)} MB`);
                
                // åˆ—å‡ºç°æœ‰ç›®å½•
                let count = 0;
                for await (const [name, handle] of root.entries()) {
                    if (name.startsWith('rec_')) {
                        count++;
                    }
                }
                log(`ğŸ“ ç°æœ‰å½•åˆ¶ç›®å½•: ${count} ä¸ª`);
                
            } catch (error) {
                log(`âŒ æ£€æŸ¥ OPFS å¤±è´¥: ${error.message}`);
            }
        }

        async function createTestRecordings() {
            try {
                const root = await navigator.storage.getDirectory();
                
                for (let i = 1; i <= 3; i++) {
                    const dirName = `rec_test_${Date.now()}_${i}`;
                    const recDir = await root.getDirectoryHandle(dirName, { create: true });
                    
                    // åˆ›å»º meta.json
                    const metaHandle = await recDir.getFileHandle('meta.json', { create: true });
                    const metaWritable = await metaHandle.createWritable();
                    await metaWritable.write(JSON.stringify({
                        id: `test_${Date.now()}_${i}`,
                        createdAt: Date.now(),
                        completed: true,
                        codec: 'vp9',
                        width: 1920,
                        height: 1080,
                        fps: 30
                    }, null, 2));
                    await metaWritable.close();
                    
                    // åˆ›å»º data.bin (æ¨¡æ‹Ÿæ•°æ®)
                    const dataHandle = await recDir.getFileHandle('data.bin', { create: true });
                    const dataWritable = await dataHandle.createWritable();
                    const testData = new Uint8Array(1024 * (i * 10)); // ä¸åŒå¤§å°çš„æµ‹è¯•æ•°æ®
                    testData.fill(i * 50); // å¡«å……ä¸åŒçš„å€¼
                    await dataWritable.write(testData);
                    await dataWritable.close();
                    
                    // åˆ›å»º index.jsonl
                    const indexHandle = await recDir.getFileHandle('index.jsonl', { create: true });
                    const indexWritable = await indexHandle.createWritable();
                    await indexWritable.write(`{"offset":0,"size":${testData.length},"timestamp":${Date.now()},"type":"key"}\n`);
                    await indexWritable.close();
                    
                    log(`âœ… åˆ›å»ºæµ‹è¯•å½•åˆ¶: ${dirName}`);
                }
                
                log('ğŸ‰ æµ‹è¯•æ•°æ®åˆ›å»ºå®Œæˆ');
                
            } catch (error) {
                log(`âŒ åˆ›å»ºæµ‹è¯•æ•°æ®å¤±è´¥: ${error.message}`);
            }
        }

        async function listRecordings() {
            try {
                const root = await navigator.storage.getDirectory();
                const recordings = [];
                
                for await (const [name, handle] of root.entries()) {
                    if (name.startsWith('rec_') && handle.kind === 'directory') {
                        recordings.push(name);
                    }
                }
                
                log(`ğŸ“‹ æ‰¾åˆ° ${recordings.length} ä¸ªå½•åˆ¶:`);
                recordings.forEach(name => log(`  - ${name}`));
                
            } catch (error) {
                log(`âŒ åˆ—å‡ºå½•åˆ¶å¤±è´¥: ${error.message}`);
            }
        }

        async function deleteFirstRecording() {
            try {
                const root = await navigator.storage.getDirectory();
                
                for await (const [name, handle] of root.entries()) {
                    if (name.startsWith('rec_') && handle.kind === 'directory') {
                        await root.removeEntry(name, { recursive: true });
                        log(`ğŸ—‘ï¸ åˆ é™¤å½•åˆ¶: ${name}`);
                        return;
                    }
                }
                
                log('â„¹ï¸ æ²¡æœ‰æ‰¾åˆ°å¯åˆ é™¤çš„å½•åˆ¶');
                
            } catch (error) {
                log(`âŒ åˆ é™¤å½•åˆ¶å¤±è´¥: ${error.message}`);
            }
        }

        async function deleteAllRecordings() {
            if (!confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰æµ‹è¯•å½•åˆ¶æ•°æ®å—ï¼Ÿ')) {
                return;
            }
            
            try {
                const root = await navigator.storage.getDirectory();
                const recordings = [];
                
                for await (const [name, handle] of root.entries()) {
                    if (name.startsWith('rec_') && handle.kind === 'directory') {
                        recordings.push(name);
                    }
                }
                
                log(`ğŸ—‘ï¸ å¼€å§‹åˆ é™¤ ${recordings.length} ä¸ªå½•åˆ¶...`);
                
                for (const name of recordings) {
                    await root.removeEntry(name, { recursive: true });
                    log(`  âœ… åˆ é™¤: ${name}`);
                }
                
                log('ğŸ‰ æ‰€æœ‰å½•åˆ¶å·²åˆ é™¤');
                
            } catch (error) {
                log(`âŒ æ‰¹é‡åˆ é™¤å¤±è´¥: ${error.message}`);
            }
        }

        function openOPFSDrive() {
            window.open('/opfs-drive', '_blank');
        }

        // åˆå§‹åŒ–
        log('ğŸš€ OPFS Drive æµ‹è¯•å·¥å…·å·²åŠ è½½');
        checkOPFS();
    </script>
</body>
</html>
