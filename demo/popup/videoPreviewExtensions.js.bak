// Video Preview Extensions for Popup Controller
// 扩展功能：视频预览、实时背景预览、padding选择、尺寸选择

console.log('[VideoPreviewExtensions] Script loaded at:', new Date().toISOString());

// 等待 PopupController 定义后再添加扩展
function waitForPopupController(callback, maxAttempts = 100) {
  let attempts = 0;
  
  function check() {
    attempts++;
    console.log(`[VideoPreviewExtensions] Checking for PopupController, attempt ${attempts}`);
    
    if (window.PopupController && window.PopupController.prototype) {
      console.log('[VideoPreviewExtensions] PopupController found!');
      callback();
    } else if (attempts < maxAttempts) {
      setTimeout(check, 50);
    } else {
      console.error('[VideoPreviewExtensions] PopupController not found after', maxAttempts, 'attempts');
    }
  }
  
  check();
}

// 添加扩展方法到 PopupController
function addExtensionMethods() {
  console.log('[VideoPreviewExtensions] Adding extension methods to PopupController.prototype');
  
  // 直接添加扩展方法
  
  // 选择 Padding
  PopupController.prototype.selectPadding = function(selectedOption) {
    // 移除其他选项的选中状态
    this.elements.paddingOptions.forEach(option => {
      option.classList.remove('active');
    });
    
    // 设置当前选项为选中状态
    selectedOption.classList.add('active');
    
    // 更新设置
    this.settings.padding = parseInt(selectedOption.dataset.padding);
    
    // 更新设置信息显示
    this.updateSettingsInfo();
    
    console.log('Padding selected:', this.settings.padding);
  };
  
  // 选择输出尺寸
  PopupController.prototype.selectSize = function(selectedOption) {
    // 移除其他选项的选中状态
    this.elements.sizeOptions.forEach(option => {
      option.classList.remove('active');
    });
    
    // 设置当前选项为选中状态
    selectedOption.classList.add('active');
    
    // 更新设置
    this.settings.outputRatio = selectedOption.dataset.ratio;
    
    // 显示/隐藏自定义尺寸输入
    if (this.settings.outputRatio === 'custom') {
      this.elements.customSizeInput.classList.remove('hidden');
    } else {
      this.elements.customSizeInput.classList.add('hidden');
    }
    
    // 更新设置信息显示
    this.updateSettingsInfo();
    
    console.log('Size ratio selected:', this.settings.outputRatio);
  };
  
  // 更新设置信息显示
  PopupController.prototype.updateSettingsInfo = function() {
    if (this.elements.selectedSettings) {
      const paddingText = `边距: ${this.settings.padding}px`;
      const sizeText = this.settings.outputRatio === 'custom' 
        ? `尺寸: ${this.settings.customWidth}×${this.settings.customHeight}`
        : `尺寸: ${this.settings.outputRatio}`;
      
      this.elements.selectedSettings.textContent = `${paddingText} | ${sizeText}`;
    }
  };
  
  // 加载视频预览
  PopupController.prototype.loadVideoPreview = function() {
    console.log('loadVideoPreview called');
    console.log('recordedVideo exists:', !!this.state.recordedVideo);
    console.log('videoPreview element exists:', !!this.elements.videoPreview);
    
    if (this.state.recordedVideo && this.elements.videoPreview) {
      console.log('Creating video URL from blob, size:', this.state.recordedVideo.size);
      
      // 先清理之前的视频源
      if (this.elements.videoPreview.src) {
        this.elements.videoPreview.pause();
        this.elements.videoPreview.src = '';
        this.elements.videoPreview.load();
      }
      
      const videoUrl = URL.createObjectURL(this.state.recordedVideo);
      
      // 确保视频预览区域可见
      const previewSection = document.querySelector('.video-preview-section');
      if (previewSection) {
        previewSection.style.display = 'block';
      }
      
      // 先显示视频元素
      this.elements.videoPreview.style.display = 'block';
      if (this.elements.previewCanvas) {
        this.elements.previewCanvas.style.display = 'none';
      }
      
      // 设置所有必要的事件监听器
      this.elements.videoPreview.onloadstart = () => {
        console.log('Video preview load started');
      };
      
      this.elements.videoPreview.onloadeddata = () => {
        console.log('Video preview data loaded');
      };
      
      // 视频加载完成后的处理
      this.elements.videoPreview.onloadedmetadata = () => {
        console.log('Video preview metadata loaded:', {
          duration: this.elements.videoPreview.duration,
          width: this.elements.videoPreview.videoWidth,
          height: this.elements.videoPreview.videoHeight,
          readyState: this.elements.videoPreview.readyState
        });
        
        // 尝试自动播放
        this.elements.videoPreview.play().then(() => {
          console.log('Video preview playing');
        }).catch(err => {
          console.log('Auto-play prevented, user can manually play:', err);
          // 如果自动播放失败，至少显示第一帧
          this.elements.videoPreview.currentTime = 0.1;
        });
        
        // 延迟清理 URL
        setTimeout(() => {
          URL.revokeObjectURL(videoUrl);
        }, 30000); // 增加到30秒，确保视频有足够时间加载
      };
      
      // 错误处理
      this.elements.videoPreview.onerror = (error) => {
        console.error('Video preview load error:', error);
        console.error('Video element state:', {
          src: this.elements.videoPreview.src,
          readyState: this.elements.videoPreview.readyState,
          networkState: this.elements.videoPreview.networkState,
          error: this.elements.videoPreview.error
        });
        
        // 显示错误提示
        if (this.showErrorMessage) {
          this.showErrorMessage('视频预览加载失败，但您仍可以下载视频');
        }
      };
      
      // 设置视频源
      this.elements.videoPreview.src = videoUrl;
      
      // 强制加载视频
      this.elements.videoPreview.load();
      
      console.log('Video preview src set to:', videoUrl);
    } else {
      console.warn('Cannot load video preview:', {
        hasRecordedVideo: !!this.state.recordedVideo,
        hasVideoPreviewElement: !!this.elements.videoPreview,
        recordedVideoSize: this.state.recordedVideo ? this.state.recordedVideo.size : 0
      });
      
      // 尝试重新获取元素
      if (this.state.recordedVideo && !this.elements.videoPreview) {
        this.elements.videoPreview = document.getElementById('video-preview');
        if (this.elements.videoPreview) {
          console.log('Found video preview element after retry, attempting to load');
          this.loadVideoPreview(); // 递归调用
        }
      }
    }
  };
  
  // 实时更新背景预览
  PopupController.prototype.updateRealtimePreview = function() {
    if (!this.state.recordedVideo || !this.elements.previewCanvas) {
      return;
    }
    
    // 显示 canvas，隐藏视频播放器
    this.elements.videoPreview.style.display = 'none';
    this.elements.previewCanvas.style.display = 'block';
    
    const canvas = this.elements.previewCanvas;
    const ctx = canvas.getContext('2d');
    const video = this.elements.videoPreview;
    
    // 如果没有选择背景色，不显示预览
    if (!this.state.selectedBackground) {
      return;
    }
    
    // 计算输出尺寸
    const outputSize = this.calculateOutputSize();
    canvas.width = outputSize.width;
    canvas.height = outputSize.height;
    
    // 计算视频在画布中的位置和大小
    const padding = this.settings.padding;
    const videoLayout = this.calculateVideoLayout(
      video.videoWidth,
      video.videoHeight,
      outputSize.width,
      outputSize.height,
      padding
    );
    
    // 绘制背景
    ctx.fillStyle = this.state.selectedBackground;
    ctx.fillRect(0, 0, canvas.width, canvas.height);
    
    // 绘制视频帧
    if (video.readyState >= 2) {
      ctx.drawImage(
        video,
        videoLayout.x,
        videoLayout.y,
        videoLayout.width,
        videoLayout.height
      );
    }
    
    // 添加水印或文字说明
    ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
    ctx.font = '12px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('实时预览', canvas.width / 2, canvas.height - 10);
  };
  
  // 计算输出尺寸
  PopupController.prototype.calculateOutputSize = function() {
    let width, height;
    
    if (this.settings.outputRatio === 'custom') {
      width = this.settings.customWidth;
      height = this.settings.customHeight;
    } else {
      // 基于比例计算尺寸
      const ratios = {
        '16:9': { w: 1920, h: 1080 },
        '1:1': { w: 1080, h: 1080 },
        '9:16': { w: 1080, h: 1920 },
        '4:5': { w: 1080, h: 1350 }
      };
      
      const ratio = ratios[this.settings.outputRatio] || ratios['16:9'];
      width = ratio.w;
      height = ratio.h;
    }
    
    // 限制预览尺寸
    const maxWidth = 360;
    const scale = Math.min(1, maxWidth / width);
    
    return {
      width: Math.floor(width * scale),
      height: Math.floor(height * scale),
      originalWidth: width,
      originalHeight: height
    };
  };
  
  // 计算视频布局
  PopupController.prototype.calculateVideoLayout = function(videoWidth, videoHeight, canvasWidth, canvasHeight, padding) {
    // 计算可用空间
    const availableWidth = canvasWidth - padding * 2;
    const availableHeight = canvasHeight - padding * 2;
    
    // 计算缩放比例（保持宽高比）
    const scaleX = availableWidth / videoWidth;
    const scaleY = availableHeight / videoHeight;
    const scale = Math.min(scaleX, scaleY);
    
    // 计算实际尺寸
    const actualWidth = videoWidth * scale;
    const actualHeight = videoHeight * scale;
    
    // 计算居中位置
    const x = (canvasWidth - actualWidth) / 2;
    const y = (canvasHeight - actualHeight) / 2;
    
    return {
      x: x,
      y: y,
      width: actualWidth,
      height: actualHeight
    };
  };
  
  // 重写显示区域方法，添加视频预览加载
  const originalShowSection = PopupController.prototype.showSection;
  PopupController.prototype.showSection = function(step) {
    console.log('[VideoPreviewExt] showSection called with step:', step);
    originalShowSection.call(this, step);
    
    // 当显示完成区域时，加载视频预览
    if (step === 'complete' && this.state.recordedVideo) {
      console.log('[VideoPreviewExt] Complete section detected with video, will load video preview');
      console.log('[VideoPreviewExt] Recorded video size:', this.state.recordedVideo.size);
      
      // 确保DOM已经更新
      requestAnimationFrame(() => {
        console.log('[VideoPreviewExt] Loading video preview now...');
        if (this.loadVideoPreview) {
          this.loadVideoPreview();
        } else {
          console.error('[VideoPreviewExt] loadVideoPreview method not found on this:', this);
        }
        if (this.updateSettingsInfo) {
          this.updateSettingsInfo();
        } else {
          console.error('[VideoPreviewExt] updateSettingsInfo method not found on this:', this);
        }
      });
    }
  };
  
  // 重写应用背景方法，使用新的设置
  const originalApplyBackground = PopupController.prototype.applyBackground;
  PopupController.prototype.applyBackground = async function() {
    try {
      if (!this.state.recordedVideo) {
        throw new Error('没有可处理的视频文件');
      }

      if (!this.state.selectedBackground) {
        throw new Error('请先选择背景颜色');
      }

      // 显示处理状态
      this.transitionToStep('processing');
      this.updateProgress(10, '准备处理视频...');

      // 添加按钮加载状态
      this.elements.applyBgBtn.classList.add('loading');

      // 计算输出尺寸
      const outputSize = this.calculateOutputSize();

      // 创建背景配置
      const backgroundConfig = {
        type: 'solid-color',
        color: this.state.selectedBackground,
        padding: this.settings.padding,
        videoPosition: 'center',
        outputWidth: outputSize.originalWidth,
        outputHeight: outputSize.originalHeight,
        aspectRatio: this.settings.outputRatio
      };

      this.updateProgress(30, '正在应用背景...');

      // 处理视频背景，传递进度回调
      const processedVideoBlob = await this.backgroundProcessor.applyBackground(
        this.state.recordedVideo,
        backgroundConfig,
        (progress, message) => {
          this.updateProgress(progress, message);
        }
      );

      this.updateProgress(80, '正在准备下载...');

      // 生成文件名
      const backgroundName = this.getBackgroundName(this.state.selectedBackground);
      const sizeLabel = this.settings.outputRatio.replace(':', 'x');
      const filename = this.fileManager.generateDateFilename(
        `saas-recording-${backgroundName}-${sizeLabel}`,
        'webm'
      );

      this.updateProgress(90, '正在下载文件...');

      // 下载处理后的视频
      await this.fileManager.downloadBlob(processedVideoBlob, filename);

      this.updateProgress(100, '处理完成');

      // 显示成功消息
      this.showSuccessMessage(`视频已处理并保存为: ${filename}`);

      // 显示下载完成指导和反馈请求
      this.showGuidance('download-ready');

      // 延迟显示反馈请求
      setTimeout(() => {
        this.showFeedbackRequest();
      }, 3000);

      // 重置状态
      setTimeout(() => {
        this.reset();
      }, 2000);

      console.log('Background applied and video downloaded:', filename);

    } catch (error) {
      console.error('Failed to apply background:', error);
      this.handleError('背景处理失败: ' + error.message, error);
    } finally {
      // 移除按钮加载状态
      this.elements.applyBgBtn.classList.remove('loading');
    }
  };
  
  console.log('Video preview extensions loaded and methods attached');
  
  // 验证方法是否被正确添加
  const proto = PopupController.prototype;
  console.log('Methods added to PopupController.prototype:');
  console.log('- loadVideoPreview:', typeof proto.loadVideoPreview);
  console.log('- selectPadding:', typeof proto.selectPadding);
  console.log('- selectSize:', typeof proto.selectSize);
  console.log('- updateRealtimePreview:', typeof proto.updateRealtimePreview);
  
  // 标记扩展已加载
  window.videoPreviewExtensionsLoaded = true;
  
    // 通知所有已创建的 PopupController 实例
    if (window.popupController) {
      console.log('PopupController instance found, methods should be available now');
      
      // 如果 popupController 已经存在并且有录制的视频，尝试加载预览
      if (window.popupController.state && window.popupController.state.recordedVideo) {
        console.log('Found existing recorded video, attempting to load preview');
        setTimeout(() => {
          if (window.popupController.loadVideoPreview) {
            window.popupController.loadVideoPreview();
          }
        }, 100);
      }
    }
  }
  
  // 根据 DOM 状态决定何时初始化
  if (document.readyState === 'loading') {
    // DOM 还在加载中，等待 DOMContentLoaded
    document.addEventListener('DOMContentLoaded', tryInit);
  } else {
    // DOM 已加载完成，直接尝试初始化
    tryInit();
  }
})();
