<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediabunny ç®€å•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .warning { background-color: #fff3cd; color: #856404; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ğŸ§ª Mediabunny ç®€å•æµ‹è¯•</h1>
    <div id="status">æ­£åœ¨åŠ è½½...</div>
    <div id="results"></div>

    <!-- ç¬¬ä¸‰æ–¹åº“ -->
    <script type="module">
        // åŠ¨æ€å¯¼å…¥ Mediabunny å¹¶è®¾ç½®ä¸ºå…¨å±€å˜é‡
        try {
            console.log('ğŸ”„ å¼€å§‹åŠ è½½ Mediabunny...');
            const Mediabunny = await import('./libs/mediabunny.js');
            window.Mediabunny = Mediabunny;
            console.log('âœ… Mediabunny åº“å·²åŠ è½½ä¸ºå…¨å±€å˜é‡', Object.keys(Mediabunny));
            
            // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥å…¶ä»–è„šæœ¬
            window.dispatchEvent(new CustomEvent('mediabunnyLoaded', { 
                detail: { Mediabunny } 
            }));
            
            updateStatus('âœ… Mediabunny åº“åŠ è½½æˆåŠŸ', 'success');
        } catch (error) {
            console.error('âŒ Mediabunny åº“åŠ è½½å¤±è´¥:', error);
            window.dispatchEvent(new CustomEvent('mediabunnyLoadError', { 
                detail: { error } 
            }));
            
            updateStatus(`âŒ Mediabunny åº“åŠ è½½å¤±è´¥: ${error.message}`, 'error');
        }
    </script>

    <!-- Mediabunny MP4 å¯¼å‡ºå™¨ -->
    <script src="popup/mediabunny-mp4-exporter.js"></script>

    <script>
        function updateStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function addResult(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            const div = document.createElement('div');
            div.textContent = message;
            div.className = `status ${type}`;
            resultsDiv.appendChild(div);
        }

        // ç›‘å¬ Mediabunny åŠ è½½äº‹ä»¶
        window.addEventListener('mediabunnyLoaded', async () => {
            console.log('ğŸ“¢ æ”¶åˆ° Mediabunny åŠ è½½äº‹ä»¶');
            addResult('ğŸ“¢ æ”¶åˆ° Mediabunny åŠ è½½äº‹ä»¶', 'info');
            
            // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
            await testBasicFunctionality();
        });

        window.addEventListener('mediabunnyLoadError', (event) => {
            console.error('ğŸ“¢ æ”¶åˆ° Mediabunny åŠ è½½é”™è¯¯äº‹ä»¶:', event.detail.error);
            addResult(`ğŸ“¢ Mediabunny åŠ è½½é”™è¯¯: ${event.detail.error.message}`, 'error');
        });

        async function testBasicFunctionality() {
            addResult('ğŸ” å¼€å§‹æµ‹è¯•åŸºæœ¬åŠŸèƒ½...', 'info');
            
            // æµ‹è¯• Mediabunny åº“
            if (typeof window.Mediabunny !== 'undefined') {
                addResult('âœ… Mediabunny å…¨å±€å˜é‡å¯ç”¨', 'success');
                
                // æµ‹è¯•å…³é”®ç±»
                const requiredClasses = ['Input', 'Output', 'Conversion', 'BlobSource', 'Mp4OutputFormat', 'BufferTarget'];
                let allClassesAvailable = true;
                
                for (const className of requiredClasses) {
                    if (window.Mediabunny[className]) {
                        addResult(`âœ… Mediabunny.${className} å¯ç”¨`, 'success');
                    } else {
                        addResult(`âŒ Mediabunny.${className} ä¸å¯ç”¨`, 'error');
                        allClassesAvailable = false;
                    }
                }
                
                if (allClassesAvailable) {
                    addResult('ğŸ‰ Mediabunny æ‰€æœ‰å¿…éœ€ç±»éƒ½å¯ç”¨ï¼', 'success');
                }
            } else {
                addResult('âŒ Mediabunny å…¨å±€å˜é‡ä¸å¯ç”¨', 'error');
            }
            
            // æµ‹è¯• MediabunnyMp4Exporter
            if (typeof window.MediabunnyMp4Exporter !== 'undefined') {
                addResult('âœ… MediabunnyMp4Exporter ç±»å¯ç”¨', 'success');
                
                try {
                    const exporter = new MediabunnyMp4Exporter();
                    addResult('âœ… MediabunnyMp4Exporter å®ä¾‹åŒ–æˆåŠŸ', 'success');
                    addResult(`ğŸ“Š åˆå§‹æ”¯æŒçŠ¶æ€: ${exporter.isSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, 'info');
                    
                    // å°è¯•åˆå§‹åŒ–
                    try {
                        await exporter.initialize();
                        addResult('âœ… MediabunnyMp4Exporter åˆå§‹åŒ–æˆåŠŸ', 'success');
                        addResult(`ğŸ“Š åˆå§‹åŒ–åæ”¯æŒçŠ¶æ€: ${exporter.isSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, 'info');
                    } catch (initError) {
                        addResult(`âš ï¸ MediabunnyMp4Exporter åˆå§‹åŒ–å¤±è´¥: ${initError.message}`, 'warning');
                    }
                } catch (error) {
                    addResult(`âŒ MediabunnyMp4Exporter å®ä¾‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
            } else {
                addResult('âŒ MediabunnyMp4Exporter ç±»ä¸å¯ç”¨', 'error');
            }
            
            updateStatus('ğŸ æµ‹è¯•å®Œæˆ', 'info');
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹çŠ¶æ€
        window.addEventListener('load', () => {
            updateStatus('â³ ç­‰å¾… Mediabunny åº“åŠ è½½...', 'info');
            
            // å¦‚æœ 5 ç§’åè¿˜æ²¡æœ‰åŠ è½½äº‹ä»¶ï¼Œæ˜¾ç¤ºè­¦å‘Š
            setTimeout(() => {
                if (typeof window.Mediabunny === 'undefined') {
                    addResult('âš ï¸ 5ç§’åä»æœªæ”¶åˆ° Mediabunny åŠ è½½äº‹ä»¶', 'warning');
                }
            }, 5000);
        });
    </script>
</body>
</html>
