<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•æ–‡å­—æ¸…æ™°åº¦æ”¹è¿›</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin: 5px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .status {
            padding: 10px;
            border-radius: 6px;
            margin: 10px 0;
            font-size: 14px;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            font-weight: 600;
            color: #333;
        }
        
        video {
            max-width: 100%;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .test-content {
            background: white;
            border: 2px solid #007bff;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            font-family: 'Courier New', monospace;
        }
        
        .test-content h2 {
            color: #007bff;
            margin: 0 0 15px 0;
        }
        
        .test-content .code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            margin: 10px 0;
        }
        
        .test-content .small-text {
            font-size: 10px;
            color: #666;
        }
        
        .comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin: 20px 0;
        }
        
        .comparison-item {
            text-align: center;
        }
        
        .comparison-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        
        .settings-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }
        
        .setting-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }
        
        .setting-item h4 {
            margin: 0 0 10px 0;
            color: #495057;
            font-size: 14px;
        }
        
        select, input[type="range"] {
            width: 100%;
            padding: 5px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            margin: 5px 0;
        }
        
        .improvement-note {
            background: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            color: #0066cc;
        }
        
        .improvement-note h4 {
            margin: 0 0 10px 0;
            color: #0066cc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ–‡å­—æ¸…æ™°åº¦æ”¹è¿›æµ‹è¯•</h1>
        <p class="subtitle">æµ‹è¯•ä¼˜åŒ–åçš„MP4å¯¼å‡ºå¯¹æ–‡å­—æ¸…æ™°åº¦çš„æ”¹è¿›æ•ˆæœ</p>
        
        <div class="improvement-note">
            <h4>ğŸ”§ å·²å®æ–½çš„æ”¹è¿›æªæ–½</h4>
            <ul>
                <li><strong>æ™ºèƒ½æ¸²æŸ“è®¾ç½®</strong>ï¼šæ ¹æ®ç¼©æ”¾æ¯”ä¾‹è‡ªåŠ¨é€‰æ‹©æœ€ä½³çš„å›¾åƒå¹³æ»‘è®¾ç½®</li>
                <li><strong>ä¼˜åŒ–Canvaså°ºå¯¸</strong>ï¼šå‡å°‘ä¸å¿…è¦çš„ç¼©æ”¾ï¼Œä¿æŒæ¥è¿‘åŸå§‹åˆ†è¾¨ç‡</li>
                <li><strong>æé«˜æ¯”ç‰¹ç‡</strong>ï¼šä¸ºæ–‡å­—å†…å®¹æä¾›æ›´é«˜çš„ç¼–ç è´¨é‡</li>
                <li><strong>æ™ºèƒ½è¾¹è·è°ƒæ•´</strong>ï¼šå½“å®½é«˜æ¯”ç›¸è¿‘æ—¶è‡ªåŠ¨å‡å°‘è¾¹è·</li>
            </ul>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“„ 1. åˆ›å»ºæ–‡å­—æµ‹è¯•å†…å®¹</h3>
            <p>ä»¥ä¸‹æ˜¯ä¸“é—¨è®¾è®¡çš„æ–‡å­—æ¸…æ™°åº¦æµ‹è¯•å†…å®¹ï¼ŒåŒ…å«ä¸åŒå¤§å°å’Œç±»å‹çš„æ–‡å­—ï¼š</p>
            
            <div class="test-content" id="testContent">
                <h2>æ–‡å­—æ¸…æ™°åº¦æµ‹è¯•é¡µé¢</h2>
                <p><strong>å¤§å·æ–‡å­—æµ‹è¯•</strong> - è¿™æ˜¯16pxçš„æ ‡å‡†æ–‡å­—ï¼Œåº”è¯¥æ¸…æ™°å¯è¯»</p>
                <p style="font-size: 14px;"><strong>ä¸­å·æ–‡å­—æµ‹è¯•</strong> - è¿™æ˜¯14pxçš„ä¸­ç­‰æ–‡å­—ï¼Œæµ‹è¯•ä¸­ç­‰å°ºå¯¸çš„æ¸…æ™°åº¦</p>
                <p class="small-text"><strong>å°å·æ–‡å­—æµ‹è¯•</strong> - è¿™æ˜¯10pxçš„å°å·æ–‡å­—ï¼Œæµ‹è¯•å°å­—ä½“çš„æ¸…æ™°åº¦</p>
                
                <div class="code">
                    // ä»£ç æ–‡å­—æµ‹è¯•
                    function testTextClarity() {
                        const message = "Hello, World!";
                        console.log(message);
                        return true;
                    }
                </div>
                
                <p style="font-family: Arial, sans-serif;">Arialå­—ä½“ï¼šThe quick brown fox jumps over the lazy dog</p>
                <p style="font-family: 'Times New Roman', serif;">Timeså­—ä½“ï¼šThe quick brown fox jumps over the lazy dog</p>
                <p style="font-family: 'Courier New', monospace;">Courierå­—ä½“ï¼šThe quick brown fox jumps over the lazy dog</p>
                
                <table border="1" style="border-collapse: collapse; margin: 10px 0;">
                    <tr><th>åˆ—1</th><th>åˆ—2</th><th>åˆ—3</th></tr>
                    <tr><td>æ•°æ®1</td><td>æ•°æ®2</td><td>æ•°æ®3</td></tr>
                    <tr><td>æµ‹è¯•A</td><td>æµ‹è¯•B</td><td>æµ‹è¯•C</td></tr>
                </table>
            </div>
            
            <button id="captureTestContent">å½•åˆ¶æµ‹è¯•å†…å®¹</button>
            <div id="captureStatus"></div>
            <video id="recordedVideo" controls style="display: none;"></video>
        </div>
        
        <div class="test-section">
            <h3>âš™ï¸ 2. å¯¼å‡ºè®¾ç½®</h3>
            <div class="settings-grid">
                <div class="setting-item">
                    <h4>è¾“å‡ºæ¯”ä¾‹</h4>
                    <select id="outputRatio">
                        <option value="16:9">16:9 æ¨ªå±</option>
                        <option value="1:1">1:1 æ­£æ–¹å½¢</option>
                        <option value="9:16">9:16 ç«–å±</option>
                        <option value="4:5">4:5 Instagram</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <h4>è´¨é‡è®¾ç½®</h4>
                    <select id="qualitySelect">
                        <option value="medium">ä¸­ç­‰è´¨é‡</option>
                        <option value="high" selected>é«˜è´¨é‡</option>
                        <option value="ultra">è¶…é«˜è´¨é‡</option>
                    </select>
                </div>
                
                <div class="setting-item">
                    <h4>è¾¹è·: <span id="paddingValue">60</span>px</h4>
                    <input type="range" id="paddingSlider" min="0" max="100" value="60" step="10">
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ”§ 3. åˆå§‹åŒ–å¯¼å‡ºå™¨</h3>
            <button id="initExporter">åˆå§‹åŒ–æ”¹è¿›çš„MP4å¯¼å‡ºå™¨</button>
            <div id="initStatus"></div>
        </div>
        
        <div class="test-section">
            <h3>ğŸš€ 4. æµ‹è¯•æ”¹è¿›åçš„MP4å¯¼å‡º</h3>
            <button id="testImprovedExport" disabled>æµ‹è¯•æ”¹è¿›åçš„MP4å¯¼å‡º</button>
            <div id="exportStatus"></div>
            
            <div class="progress-container" id="progressContainer">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
                </div>
            </div>
            
            <div class="comparison" id="comparisonResults" style="display: none;">
                <div class="comparison-item">
                    <h4>åŸå§‹å½•åˆ¶</h4>
                    <video id="originalVideo" controls></video>
                </div>
                <div class="comparison-item">
                    <h4>æ”¹è¿›åå¯¼å‡º</h4>
                    <video id="improvedVideo" controls></video>
                </div>
            </div>
        </div>
        
        <div class="test-section">
            <h3>ğŸ“Š 5. æ”¹è¿›æ•ˆæœåˆ†æ</h3>
            <div id="improvementAnalysis"></div>
        </div>
    </div>

    <!-- å¼•å…¥å¿…è¦çš„è„šæœ¬ -->
    <script src="mediabunny-loader.js"></script>
    <script src="popup/mediabunny-mp4-exporter.js"></script>
    
    <script>
        class TextClarityImprovementTester {
            constructor() {
                this.mediaRecorder = null;
                this.recordedBlob = null;
                this.mp4Exporter = null;
                this.recordedChunks = [];
                this.settings = {
                    outputRatio: '16:9',
                    quality: 'high',
                    padding: 60
                };
                
                this.initializeElements();
                this.bindEvents();
            }
            
            initializeElements() {
                this.elements = {
                    captureTestContent: document.getElementById('captureTestContent'),
                    captureStatus: document.getElementById('captureStatus'),
                    recordedVideo: document.getElementById('recordedVideo'),
                    
                    outputRatio: document.getElementById('outputRatio'),
                    qualitySelect: document.getElementById('qualitySelect'),
                    paddingSlider: document.getElementById('paddingSlider'),
                    paddingValue: document.getElementById('paddingValue'),
                    
                    initExporter: document.getElementById('initExporter'),
                    initStatus: document.getElementById('initStatus'),
                    
                    testImprovedExport: document.getElementById('testImprovedExport'),
                    exportStatus: document.getElementById('exportStatus'),
                    progressContainer: document.getElementById('progressContainer'),
                    progressFill: document.getElementById('progressFill'),
                    progressText: document.getElementById('progressText'),
                    
                    comparisonResults: document.getElementById('comparisonResults'),
                    originalVideo: document.getElementById('originalVideo'),
                    improvedVideo: document.getElementById('improvedVideo'),
                    
                    improvementAnalysis: document.getElementById('improvementAnalysis')
                };
            }
            
            bindEvents() {
                this.elements.captureTestContent.addEventListener('click', () => this.captureTestContent());
                this.elements.initExporter.addEventListener('click', () => this.initializeExporter());
                this.elements.testImprovedExport.addEventListener('click', () => this.testImprovedExport());
                
                // è®¾ç½®æ§ä»¶äº‹ä»¶
                this.elements.outputRatio.addEventListener('change', (e) => {
                    this.settings.outputRatio = e.target.value;
                });
                
                this.elements.qualitySelect.addEventListener('change', (e) => {
                    this.settings.quality = e.target.value;
                });
                
                this.elements.paddingSlider.addEventListener('input', (e) => {
                    this.settings.padding = parseInt(e.target.value);
                    this.elements.paddingValue.textContent = e.target.value;
                });
            }
            
            showStatus(element, message, type = 'info') {
                element.innerHTML = `<div class="status ${type}">${message}</div>`;
            }
            
            async captureTestContent() {
                try {
                    // æ»šåŠ¨åˆ°æµ‹è¯•å†…å®¹åŒºåŸŸ
                    document.getElementById('testContent').scrollIntoView({ behavior: 'smooth' });
                    
                    await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…æ»šåŠ¨å®Œæˆ
                    
                    const stream = await navigator.mediaDevices.getDisplayMedia({
                        video: { 
                            mediaSource: 'screen',
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        }
                    });
                    
                    this.recordedChunks = [];
                    this.mediaRecorder = new MediaRecorder(stream, {
                        mimeType: 'video/webm;codecs=vp9',
                        videoBitsPerSecond: 8000000
                    });
                    
                    this.mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            this.recordedChunks.push(event.data);
                        }
                    };
                    
                    this.mediaRecorder.onstop = () => {
                        this.recordedBlob = new Blob(this.recordedChunks, { type: 'video/webm' });
                        this.elements.recordedVideo.src = URL.createObjectURL(this.recordedBlob);
                        this.elements.recordedVideo.style.display = 'block';
                        this.showStatus(this.elements.captureStatus, 'âœ… æµ‹è¯•å†…å®¹å½•åˆ¶å®Œæˆï¼', 'success');
                    };
                    
                    this.mediaRecorder.start();
                    this.showStatus(this.elements.captureStatus, 'ğŸ”´ æ­£åœ¨å½•åˆ¶æµ‹è¯•å†…å®¹...è¯·ç¡®ä¿æ–‡å­—æ¸…æ™°å¯è§', 'info');
                    
                    // 5ç§’åè‡ªåŠ¨åœæ­¢
                    setTimeout(() => {
                        if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
                            this.mediaRecorder.stop();
                        }
                    }, 5000);
                    
                } catch (error) {
                    this.showStatus(this.elements.captureStatus, `âŒ å½•åˆ¶å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            async initializeExporter() {
                try {
                    this.showStatus(this.elements.initStatus, 'ğŸ”„ æ­£åœ¨åˆå§‹åŒ–æ”¹è¿›çš„MP4å¯¼å‡ºå™¨...', 'info');
                    
                    this.mp4Exporter = new MediabunnyMp4Exporter();
                    await this.mp4Exporter.initialize();
                    
                    this.elements.testImprovedExport.disabled = false;
                    this.showStatus(this.elements.initStatus, 'âœ… æ”¹è¿›çš„MP4å¯¼å‡ºå™¨åˆå§‹åŒ–æˆåŠŸï¼', 'success');
                    
                } catch (error) {
                    this.showStatus(this.elements.initStatus, `âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            async testImprovedExport() {
                if (!this.recordedBlob) {
                    this.showStatus(this.elements.exportStatus, 'âŒ è¯·å…ˆå½•åˆ¶æµ‹è¯•å†…å®¹', 'error');
                    return;
                }
                
                if (!this.mp4Exporter) {
                    this.showStatus(this.elements.exportStatus, 'âŒ è¯·å…ˆåˆå§‹åŒ–å¯¼å‡ºå™¨', 'error');
                    return;
                }
                
                try {
                    this.elements.progressContainer.style.display = 'block';
                    this.showStatus(this.elements.exportStatus, 'ğŸš€ å¼€å§‹æ”¹è¿›åçš„MP4å¯¼å‡º...', 'info');
                    
                    const backgroundConfig = {
                        type: 'solid-color',
                        color: '#ffffff',
                        backgroundColor: '#ffffff',
                        padding: this.settings.padding,
                        videoPosition: 'center',
                        outputRatio: this.settings.outputRatio
                    };
                    
                    console.log('ä½¿ç”¨æ”¹è¿›çš„å¯¼å‡ºè®¾ç½®:', { ...this.settings, backgroundConfig });
                    
                    const result = await this.mp4Exporter.exportToMp4(this.recordedBlob, {
                        quality: this.settings.quality,
                        backgroundConfig: backgroundConfig,
                        frameRate: 30,
                        progressCallback: (progress, message) => {
                            this.updateProgress(progress, message);
                        }
                    });
                    
                    // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
                    this.elements.originalVideo.src = URL.createObjectURL(this.recordedBlob);
                    this.elements.improvedVideo.src = URL.createObjectURL(result.blob);
                    this.elements.comparisonResults.style.display = 'grid';
                    
                    this.showStatus(this.elements.exportStatus, 'âœ… æ”¹è¿›åMP4å¯¼å‡ºæˆåŠŸï¼', 'success');
                    
                    // åˆ†ææ”¹è¿›æ•ˆæœ
                    this.analyzeImprovements(result, backgroundConfig);
                    
                } catch (error) {
                    this.showStatus(this.elements.exportStatus, `âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
                    console.error('å¯¼å‡ºé”™è¯¯è¯¦æƒ…:', error);
                } finally {
                    this.elements.progressContainer.style.display = 'none';
                }
            }
            
            updateProgress(progress, message) {
                this.elements.progressFill.style.width = `${progress * 100}%`;
                this.elements.progressText.textContent = message;
            }
            
            analyzeImprovements(result, config) {
                const html = `
                    <div class="status success">
                        <h4>ğŸ‰ æ–‡å­—æ¸…æ™°åº¦æ”¹è¿›åˆ†æ</h4>
                        
                        <h5>ğŸ“Š å¯¼å‡ºç»“æœ</h5>
                        <ul>
                            <li><strong>åŸå§‹å¤§å°:</strong> ${(result.originalSize / 1024 / 1024).toFixed(2)} MB</li>
                            <li><strong>å¯¼å‡ºå¤§å°:</strong> ${(result.finalSize / 1024 / 1024).toFixed(2)} MB</li>
                            <li><strong>å‹ç¼©ç‡:</strong> ${result.compression.toFixed(1)}%</li>
                            <li><strong>æ ¼å¼:</strong> ${result.format.toUpperCase()}</li>
                        </ul>
                        
                        <h5>ğŸ”§ åº”ç”¨çš„æ”¹è¿›æªæ–½</h5>
                        <ul>
                            <li><strong>æ™ºèƒ½æ¸²æŸ“è®¾ç½®:</strong> æ ¹æ®ç¼©æ”¾æ¯”ä¾‹è‡ªåŠ¨ä¼˜åŒ–å›¾åƒå¹³æ»‘</li>
                            <li><strong>æé«˜æ¯”ç‰¹ç‡:</strong> ä¸ºæ–‡å­—å†…å®¹æä¾›æ›´é«˜çš„ç¼–ç è´¨é‡</li>
                            <li><strong>ä¼˜åŒ–Canvaså°ºå¯¸:</strong> å‡å°‘ä¸å¿…è¦çš„ç¼©æ”¾</li>
                            <li><strong>æ™ºèƒ½è¾¹è·è°ƒæ•´:</strong> å½“å®½é«˜æ¯”ç›¸è¿‘æ—¶è‡ªåŠ¨å‡å°‘è¾¹è·</li>
                        </ul>
                        
                        <h5>âš™ï¸ å½“å‰è®¾ç½®</h5>
                        <ul>
                            <li><strong>è¾“å‡ºæ¯”ä¾‹:</strong> ${config.outputRatio}</li>
                            <li><strong>è´¨é‡è®¾ç½®:</strong> ${this.settings.quality}</li>
                            <li><strong>è¾¹è·:</strong> ${config.padding}px</li>
                            <li><strong>èƒŒæ™¯è‰²:</strong> ${config.color}</li>
                        </ul>
                        
                        <h5>ğŸ“ ä½¿ç”¨å»ºè®®</h5>
                        <ul>
                            <li>å¯¹æ¯”åŸå§‹å½•åˆ¶å’Œå¯¼å‡ºç»“æœï¼Œè§‚å¯Ÿæ–‡å­—æ¸…æ™°åº¦çš„æ”¹è¿›</li>
                            <li>ç‰¹åˆ«æ³¨æ„å°å·æ–‡å­—å’Œä»£ç å­—ä½“çš„æ¸…æ™°åº¦</li>
                            <li>å¦‚æœæ–‡å­—ä»ä¸å¤Ÿæ¸…æ™°ï¼Œå°è¯•å‡å°‘è¾¹è·æˆ–ä½¿ç”¨æ›´é«˜è´¨é‡è®¾ç½®</li>
                            <li>å»ºè®®ä½¿ç”¨"è¶…é«˜è´¨é‡"è®¾ç½®ä»¥è·å¾—æœ€ä½³æ–‡å­—æ•ˆæœ</li>
                        </ul>
                    </div>
                `;
                
                this.elements.improvementAnalysis.innerHTML = html;
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–æµ‹è¯•å™¨
        document.addEventListener('DOMContentLoaded', () => {
            window.improvementTester = new TextClarityImprovementTester();
        });
    </script>
</body>
</html>
