<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ‹è¯•åŠ è½½å™¨</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
        }
        .success { border-color: #28a745; background-color: #d4edda; }
        .error { border-color: #dc3545; background-color: #f8d7da; }
        .warning { border-color: #ffc107; background-color: #fff3cd; }
        .info { border-color: #17a2b8; background-color: #d1ecf1; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ§ª Mediabunny åŠ è½½å™¨æµ‹è¯•</h1>
        
        <div>
            <button id="test-load" onclick="testLoad()">æµ‹è¯•åŠ è½½</button>
            <button id="test-support" onclick="testSupport()" disabled>æµ‹è¯•æ”¯æŒ</button>
            <button id="test-classes" onclick="testClasses()" disabled>æµ‹è¯•ç±»</button>
            <button id="force-enable" onclick="forceEnableButtons()">å¼ºåˆ¶å¯ç”¨æŒ‰é’®</button>
            <button id="clear-logs" onclick="clearLogs()">æ¸…é™¤æ—¥å¿—</button>
        </div>
        
        <div id="logs"></div>
    </div>

    <!-- Mediabunny åŠ è½½å™¨ -->
    <script src="mediabunny-loader.js"></script>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logsDiv.appendChild(div);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testLoad() {
            log('ğŸ”„ å¼€å§‹æµ‹è¯• Mediabunny åŠ è½½...', 'info');
            
            try {
                if (!window.mediabunnyLoader) {
                    throw new Error('Mediabunny åŠ è½½å™¨ä¸å­˜åœ¨');
                }
                
                log('âœ… Mediabunny åŠ è½½å™¨å­˜åœ¨', 'success');
                
                const mediabunny = await window.mediabunnyLoader.load();
                log('âœ… Mediabunny åŠ è½½æˆåŠŸ', 'success');
                log(`ğŸ“¦ åŠ è½½çš„å¯¹è±¡åŒ…å« ${Object.keys(mediabunny).length} ä¸ªå±æ€§`, 'info');
                
                // å¯ç”¨å…¶ä»–æµ‹è¯•æŒ‰é’®
                document.getElementById('test-support').disabled = false;
                document.getElementById('test-classes').disabled = false;
                
            } catch (error) {
                log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testSupport() {
            log('ğŸ” æµ‹è¯•æ”¯æŒæ£€æŸ¥...', 'info');
            
            try {
                if (!window.mediabunnyLoader) {
                    throw new Error('Mediabunny åŠ è½½å™¨ä¸å­˜åœ¨');
                }
                
                const isSupported = window.mediabunnyLoader.isSupported();
                log(`ğŸ“Š æ”¯æŒçŠ¶æ€: ${isSupported ? 'æ”¯æŒ' : 'ä¸æ”¯æŒ'}`, isSupported ? 'success' : 'warning');
                
                if (typeof window.Mediabunny !== 'undefined') {
                    log('âœ… å…¨å±€ Mediabunny å¯¹è±¡å¯ç”¨', 'success');
                    
                    const requiredClasses = ['Input', 'Output', 'Conversion', 'BlobSource', 'Mp4OutputFormat', 'BufferTarget'];
                    for (const className of requiredClasses) {
                        if (window.Mediabunny[className]) {
                            log(`âœ… ${className} ç±»å¯ç”¨`, 'success');
                        } else {
                            log(`âŒ ${className} ç±»ä¸å¯ç”¨`, 'error');
                        }
                    }
                } else {
                    log('âŒ å…¨å±€ Mediabunny å¯¹è±¡ä¸å¯ç”¨', 'error');
                }
                
            } catch (error) {
                log(`âŒ æ”¯æŒæ£€æŸ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testClasses() {
            log('ğŸ§ª æµ‹è¯•ç±»å®ä¾‹åŒ–...', 'info');
            
            try {
                if (typeof window.Mediabunny === 'undefined') {
                    throw new Error('Mediabunny å¯¹è±¡ä¸å¯ç”¨');
                }
                
                // æµ‹è¯• BlobSource
                try {
                    const testBlob = new Blob(['test'], { type: 'text/plain' });
                    const blobSource = new window.Mediabunny.BlobSource(testBlob);
                    log('âœ… BlobSource å®ä¾‹åŒ–æˆåŠŸ', 'success');
                } catch (error) {
                    log(`âŒ BlobSource å®ä¾‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
                
                // æµ‹è¯• Mp4OutputFormat
                try {
                    const mp4Format = new window.Mediabunny.Mp4OutputFormat();
                    log('âœ… Mp4OutputFormat å®ä¾‹åŒ–æˆåŠŸ', 'success');
                } catch (error) {
                    log(`âŒ Mp4OutputFormat å®ä¾‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
                
                // æµ‹è¯• BufferTarget
                try {
                    const bufferTarget = new window.Mediabunny.BufferTarget();
                    log('âœ… BufferTarget å®ä¾‹åŒ–æˆåŠŸ', 'success');
                } catch (error) {
                    log(`âŒ BufferTarget å®ä¾‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
                
                log('ğŸ‰ ç±»æµ‹è¯•å®Œæˆ', 'success');
                
            } catch (error) {
                log(`âŒ ç±»æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // ç›‘å¬åŠ è½½äº‹ä»¶
        window.addEventListener('mediabunnyLoaded', (event) => {
            log('ğŸ“¢ æ”¶åˆ° mediabunnyLoaded äº‹ä»¶', 'success');
            log(`ğŸ“¦ äº‹ä»¶åŒ…å« ${Object.keys(event.detail.Mediabunny).length} ä¸ªå±æ€§`, 'info');

            // å¯ç”¨æµ‹è¯•æŒ‰é’®
            enableTestButtons();
        });

        function enableTestButtons() {
            document.getElementById('test-support').disabled = false;
            document.getElementById('test-classes').disabled = false;
            log('âœ… æµ‹è¯•æŒ‰é’®å·²å¯ç”¨', 'success');
        }

        function forceEnableButtons() {
            log('ğŸ”§ å¼ºåˆ¶å¯ç”¨æµ‹è¯•æŒ‰é’®...', 'info');
            enableTestButtons();

            // æ£€æŸ¥å½“å‰çŠ¶æ€
            if (typeof window.Mediabunny !== 'undefined') {
                log('âœ… Mediabunny å…¨å±€å¯¹è±¡å¯ç”¨', 'success');
            } else {
                log('âš ï¸ Mediabunny å…¨å±€å¯¹è±¡ä¸å¯ç”¨ï¼Œä½†æŒ‰é’®å·²å¯ç”¨', 'warning');
            }

            if (window.mediabunnyLoader) {
                log(`ğŸ“Š åŠ è½½å™¨çŠ¶æ€: å·²åŠ è½½=${window.mediabunnyLoader.isLoaded}, æ­£åœ¨åŠ è½½=${window.mediabunnyLoader.isLoading}`, 'info');
            }
        }

        window.addEventListener('mediabunnyLoadError', (event) => {
            log(`ğŸ“¢ æ”¶åˆ° mediabunnyLoadError äº‹ä»¶: ${event.detail.error.message}`, 'error');
        });

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹çŠ¶æ€
        window.addEventListener('load', () => {
            log('ğŸ“„ é¡µé¢åŠ è½½å®Œæˆ', 'info');

            if (window.mediabunnyLoader) {
                log('âœ… Mediabunny åŠ è½½å™¨å·²åˆå§‹åŒ–', 'success');

                // æ£€æŸ¥æ˜¯å¦å·²ç»åŠ è½½
                if (window.mediabunnyLoader.isLoaded) {
                    log('âœ… Mediabunny å·²ç»åŠ è½½', 'success');
                    enableTestButtons();
                } else if (window.mediabunnyLoader.isLoading) {
                    log('â³ Mediabunny æ­£åœ¨åŠ è½½ä¸­...', 'info');
                    // ç­‰å¾…åŠ è½½å®Œæˆ
                    window.mediabunnyLoader.waitForLoad().then(() => {
                        log('âœ… Mediabunny åŠ è½½å®Œæˆï¼ˆå»¶è¿Ÿæ£€æŸ¥ï¼‰', 'success');
                        enableTestButtons();
                    }).catch((error) => {
                        log(`âŒ Mediabunny åŠ è½½å¤±è´¥ï¼ˆå»¶è¿Ÿæ£€æŸ¥ï¼‰: ${error.message}`, 'error');
                    });
                } else {
                    log('â³ Mediabunny å°šæœªå¼€å§‹åŠ è½½', 'info');
                }
            } else {
                log('âŒ Mediabunny åŠ è½½å™¨æœªåˆå§‹åŒ–', 'error');
            }

            // é¢å¤–æ£€æŸ¥ï¼šå¦‚æœ Mediabunny å·²ç»å¯ç”¨ï¼Œç›´æ¥å¯ç”¨æŒ‰é’®
            setTimeout(() => {
                if (typeof window.Mediabunny !== 'undefined') {
                    log('âœ… æ£€æµ‹åˆ° Mediabunny å…¨å±€å¯¹è±¡ï¼Œå¯ç”¨æŒ‰é’®', 'success');
                    enableTestButtons();
                }
            }, 1000);
        });
    </script>
</body>
</html>
