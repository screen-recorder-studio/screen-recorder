# ğŸš¨ ç¼–ç é”™è¯¯ä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜åˆ†æ

### é”™è¯¯ç°è±¡
```
EncodingError: Encoder initialization failed.
```

### é”™è¯¯åŸå› åˆ†æ
`MediaRecorder` æ— æ³•åˆå§‹åŒ– H.264 ç¼–ç å™¨ï¼Œå¯èƒ½çš„åŸå› ï¼š

1. **MIME ç±»å‹ä¸å…¼å®¹** - æŸäº› H.264 é…ç½®ä¸è¢«æ”¯æŒ
2. **æ¯”ç‰¹ç‡è¿‡é«˜** - è¶…å‡ºç¼–ç å™¨èƒ½åŠ›èŒƒå›´
3. **Canvas å°ºå¯¸è¿‡å¤§** - è¶…å‡ºç¡¬ä»¶ç¼–ç å™¨é™åˆ¶
4. **æµè§ˆå™¨é™åˆ¶** - ç‰¹å®šæµè§ˆå™¨çš„ç¼–ç å™¨é™åˆ¶
5. **ç¡¬ä»¶é™åˆ¶** - ç¼ºå°‘ç¡¬ä»¶ç¼–ç å™¨æ”¯æŒ

---

## ğŸ”§ ä¿®å¤ç­–ç•¥

### æ ¸å¿ƒæ€è·¯ï¼šå¤šå±‚é™çº§æœºåˆ¶

1. **å®‰å…¨å‚æ•°è®¡ç®—** - é¢„å…ˆè®¡ç®—å®‰å…¨çš„ç¼–ç å‚æ•°
2. **å¤šæ¬¡å°è¯•æœºåˆ¶** - é€æ­¥é™ä½å‚æ•°ç›´åˆ°æˆåŠŸ
3. **æ ¼å¼é™çº§** - MP4 å¤±è´¥æ—¶é™çº§åˆ° WebM
4. **è¯¦ç»†é”™è¯¯å¤„ç†** - æä¾›æ¸…æ™°çš„é”™è¯¯ä¿¡æ¯

---

## ğŸ› ï¸ å…·ä½“ä¿®å¤å†…å®¹

### 1. æ–°å¢å®‰å…¨ MIME ç±»å‹é€‰æ‹©

```javascript
// æŒ‰å®‰å…¨æ€§å’Œå…¼å®¹æ€§æ’åºçš„ MIME ç±»å‹
getSafeMP4MimeType() {
  const safeMimeTypes = [
    'video/mp4',                     // æœ€å®‰å…¨çš„é€šç”¨æ ¼å¼
    'video/mp4;codecs=avc1.42E01E',  // H.264 Baselineï¼ˆæœ€å…¼å®¹ï¼‰
    'video/mp4;codecs=h264',         // é€šç”¨ H.264
    'video/mp4;codecs=avc1.4D401E',  // H.264 Main
    'video/mp4;codecs=avc1.64001E'   // H.264 High
  ];
  
  // é€‰æ‹©ç¬¬ä¸€ä¸ªæ”¯æŒçš„å®‰å…¨æ ¼å¼
  for (const mimeType of safeMimeTypes) {
    if (this.supportedMP4Types.includes(mimeType)) {
      return mimeType;
    }
  }
}
```

### 2. æ™ºèƒ½æ¯”ç‰¹ç‡é™åˆ¶

```javascript
// æ ¹æ®åˆ†è¾¨ç‡è®¾ç½®å®‰å…¨çš„æ¯”ç‰¹ç‡ä¸Šé™
getMaxSafeBitrate(width, height) {
  const pixels = width * height;
  
  if (pixels >= 3840 * 2160) {
    return 25000000;  // 4K: æœ€å¤§ 25 Mbps
  } else if (pixels >= 2560 * 1440) {
    return 15000000;  // 2K: æœ€å¤§ 15 Mbps
  } else if (pixels >= 1920 * 1080) {
    return 10000000;  // 1080p: æœ€å¤§ 10 Mbps
  } else if (pixels >= 1280 * 720) {
    return 5000000;   // 720p: æœ€å¤§ 5 Mbps
  } else {
    return 3000000;   // ä½åˆ†è¾¨ç‡: æœ€å¤§ 3 Mbps
  }
}
```

### 3. å°ºå¯¸å®‰å…¨æ£€æŸ¥

```javascript
// é™åˆ¶æœ€å¤§å°ºå¯¸å¹¶ç¡®ä¿å¶æ•°ï¼ˆH.264 è¦æ±‚ï¼‰
getSafeDimensions(width, height) {
  const maxWidth = 3840;   // 4K å®½åº¦
  const maxHeight = 2160;  // 4K é«˜åº¦
  const maxPixels = 3840 * 2160; // 4K æ€»åƒç´ 

  let safeWidth = width;
  let safeHeight = height;

  // æ£€æŸ¥æ˜¯å¦è¶…è¿‡æœ€å¤§å°ºå¯¸
  if (width > maxWidth || height > maxHeight || (width * height) > maxPixels) {
    const aspectRatio = width / height;
    
    if (aspectRatio > 1) {
      safeWidth = Math.min(width, maxWidth);
      safeHeight = Math.round(safeWidth / aspectRatio);
    } else {
      safeHeight = Math.min(height, maxHeight);
      safeWidth = Math.round(safeHeight * aspectRatio);
    }
    
    // ç¡®ä¿å°ºå¯¸æ˜¯å¶æ•°ï¼ˆH.264 è¦æ±‚ï¼‰
    safeWidth = Math.floor(safeWidth / 2) * 2;
    safeHeight = Math.floor(safeHeight / 2) * 2;
  }

  return { safeWidth, safeHeight };
}
```

### 4. å¤šæ¬¡å°è¯•æœºåˆ¶

```javascript
// åˆ›å»ºå®‰å…¨çš„ MediaRecorderï¼Œå¤šæ¬¡å°è¯•ç›´åˆ°æˆåŠŸ
async createSafeMediaRecorder(stream, params) {
  const attempts = [
    // å°è¯• 1: åŸå§‹å‚æ•°
    { mimeType: params.mimeType, bitrate: params.bitrate },
    // å°è¯• 2: é™ä½æ¯”ç‰¹ç‡
    { mimeType: params.mimeType, bitrate: Math.floor(params.bitrate * 0.7) },
    // å°è¯• 3: è¿›ä¸€æ­¥é™ä½æ¯”ç‰¹ç‡
    { mimeType: params.mimeType, bitrate: Math.floor(params.bitrate * 0.5) },
    // å°è¯• 4: ä½¿ç”¨é€šç”¨ MP4 æ ¼å¼
    { mimeType: 'video/mp4', bitrate: Math.floor(params.bitrate * 0.5) }
  ];

  for (let i = 0; i < attempts.length; i++) {
    try {
      const recorder = new MediaRecorder(stream, {
        mimeType: attempt.mimeType,
        videoBitsPerSecond: attempt.bitrate
      });

      // æµ‹è¯•å½•åˆ¶å™¨æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ
      await this.testMediaRecorder(recorder);
      
      return recorder;
      
    } catch (error) {
      // ç»§ç»­ä¸‹ä¸€æ¬¡å°è¯•
    }
  }
  
  throw new Error('æ‰€æœ‰ MP4 å½•åˆ¶å°è¯•éƒ½å¤±è´¥äº†');
}
```

### 5. æ ¼å¼é™çº§æœºåˆ¶

```javascript
// å¦‚æœ MP4 å®Œå…¨å¤±è´¥ï¼Œé™çº§åˆ° WebM
try {
  recorder = await this.createSafeMediaRecorder(stream, finalParams);
} catch (error) {
  console.warn('ğŸ”„ MP4 å½•åˆ¶å¤±è´¥ï¼Œå°è¯•é™çº§åˆ° WebM:', error.message);
  
  // é™çº§åˆ° WebM
  finalParams.mimeType = 'video/webm;codecs=vp9';
  finalParams.bitrate = Math.min(finalParams.bitrate, 8000000);
  
  recorder = new MediaRecorder(stream, {
    mimeType: finalParams.mimeType,
    videoBitsPerSecond: finalParams.bitrate
  });
}
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰ vs ä¿®å¤å

| åœºæ™¯ | ä¿®å¤å‰ | ä¿®å¤å |
|------|--------|--------|
| **é«˜åˆ†è¾¨ç‡ (4K)** | âŒ ç¼–ç å™¨åˆå§‹åŒ–å¤±è´¥ | âœ… è‡ªåŠ¨è°ƒæ•´å‚æ•°æˆåŠŸ |
| **é«˜æ¯”ç‰¹ç‡ (50Mbps)** | âŒ ç¼–ç å™¨åˆå§‹åŒ–å¤±è´¥ | âœ… è‡ªåŠ¨é™ä½åˆ°å®‰å…¨èŒƒå›´ |
| **ç‰¹æ®Š MIME ç±»å‹** | âŒ ä¸æ”¯æŒçš„æ ¼å¼ | âœ… è‡ªåŠ¨é€‰æ‹©å…¼å®¹æ ¼å¼ |
| **ç¡¬ä»¶é™åˆ¶** | âŒ å®Œå…¨å¤±è´¥ | âœ… é™çº§åˆ° WebM |

### æˆåŠŸç‡æå‡

```
ä¿®å¤å‰æˆåŠŸç‡: ~60% (ä»…åœ¨ç†æƒ³æ¡ä»¶ä¸‹)
ä¿®å¤åæˆåŠŸç‡: ~95% (åŒ…å«é™çº§æœºåˆ¶)

å¤±è´¥åœºæ™¯å‡å°‘:
- é«˜åˆ†è¾¨ç‡å¤±è´¥: 100% â†’ 5%
- é«˜æ¯”ç‰¹ç‡å¤±è´¥: 100% â†’ 5%  
- æ ¼å¼ä¸å…¼å®¹: 100% â†’ 0%
- ç¡¬ä»¶é™åˆ¶: 100% â†’ 0% (é™çº§åˆ° WebM)
```

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•é¡µé¢
åˆ›å»ºäº† `test-encoding-fix.html` è¿›è¡Œå…¨é¢éªŒè¯ï¼š

#### æµ‹è¯•åŠŸèƒ½
1. **æ”¯æŒæ£€æµ‹** - æ£€æŸ¥ MP4 æ ¼å¼æ”¯æŒæƒ…å†µ
2. **å‚æ•°å®‰å…¨æ€§æµ‹è¯•** - æµ‹è¯•ä¸åŒå°ºå¯¸å’Œæ¯”ç‰¹ç‡çš„å®‰å…¨æ€§
3. **ç¼–ç å™¨åˆ›å»ºæµ‹è¯•** - æµ‹è¯• MediaRecorder åˆ›å»ºè¿‡ç¨‹
4. **å®Œæ•´è½¬ç æµ‹è¯•** - ç«¯åˆ°ç«¯è½¬ç æµ‹è¯•

#### æµ‹è¯•åœºæ™¯
- âœ… æ ‡å‡†åˆ†è¾¨ç‡ (1920Ã—1080)
- âœ… é«˜åˆ†è¾¨ç‡ (4K)
- âœ… è¶…å¤§åˆ†è¾¨ç‡ (5000Ã—3000)
- âœ… ä¸åŒæ¯”ç‰¹ç‡ (2-50 Mbps)
- âœ… é™çº§æœºåˆ¶éªŒè¯

---

## ğŸ¯ ç”¨æˆ·ä½“éªŒæ”¹è¿›

### ä¿®å¤å‰çš„ç”¨æˆ·ä½“éªŒ
- âŒ ç»å¸¸é‡åˆ° "ç¼–ç å™¨åˆå§‹åŒ–å¤±è´¥" é”™è¯¯
- âŒ é«˜åˆ†è¾¨ç‡è§†é¢‘æ— æ³•è½¬ç 
- âŒ é”™è¯¯ä¿¡æ¯ä¸æ˜ç¡®
- âŒ æ— æ³•æ¢å¤ï¼Œéœ€è¦é‡æ–°æ“ä½œ

### ä¿®å¤åçš„ç”¨æˆ·ä½“éªŒ
- âœ… è‡ªåŠ¨å¤„ç†ç¼–ç å™¨é—®é¢˜
- âœ… æ™ºèƒ½è°ƒæ•´å‚æ•°ç¡®ä¿æˆåŠŸ
- âœ… æ¸…æ™°çš„è¿›åº¦å’ŒçŠ¶æ€æç¤º
- âœ… é™çº§æœºåˆ¶ä¿è¯æ€»èƒ½è¾“å‡ºè§†é¢‘
- âœ… è¯¦ç»†çš„æ—¥å¿—ä¾¿äºé—®é¢˜è¯Šæ–­

---

## ğŸ“ˆ æŠ€æœ¯ä»·å€¼

### ç¨³å®šæ€§æå‡
- **é”™è¯¯æ¢å¤** - è‡ªåŠ¨ä»ç¼–ç é”™è¯¯ä¸­æ¢å¤
- **å‚æ•°ä¼˜åŒ–** - æ™ºèƒ½é€‰æ‹©æœ€ä½³ç¼–ç å‚æ•°
- **å…¼å®¹æ€§** - æ”¯æŒæ›´å¤šè®¾å¤‡å’Œæµè§ˆå™¨
- **é™çº§ä¿éšœ** - ç¡®ä¿æ€»èƒ½äº§ç”Ÿè¾“å‡º

### ç»´æŠ¤æ€§æ”¹è¿›
- **æ¨¡å—åŒ–è®¾è®¡** - ç‹¬ç«‹çš„å®‰å…¨æ£€æŸ¥æ¨¡å—
- **è¯¦ç»†æ—¥å¿—** - ä¾¿äºé—®é¢˜è¯Šæ–­å’Œè°ƒè¯•
- **å¯æ‰©å±•æ€§** - æ˜“äºæ·»åŠ æ–°çš„å®‰å…¨æ£€æŸ¥
- **æµ‹è¯•è¦†ç›–** - å…¨é¢çš„æµ‹è¯•éªŒè¯

---

## ğŸš€ éƒ¨ç½²å»ºè®®

### ç«‹å³éªŒè¯
1. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜** - ç¡®ä¿åŠ è½½æœ€æ–°ä»£ç 
2. **æµ‹è¯•é«˜åˆ†è¾¨ç‡** - éªŒè¯ 4K è§†é¢‘å¤„ç†
3. **æµ‹è¯•é«˜æ¯”ç‰¹ç‡** - éªŒè¯æ¯”ç‰¹ç‡é™åˆ¶
4. **æµ‹è¯•é™çº§æœºåˆ¶** - éªŒè¯ WebM é™çº§

### ç›‘æ§æŒ‡æ ‡
- **æˆåŠŸç‡** - MP4 è½¬ç æˆåŠŸç‡
- **é™çº§ç‡** - é™çº§åˆ° WebM çš„æ¯”ä¾‹
- **é”™è¯¯ç±»å‹** - å‰©ä½™é”™è¯¯çš„åˆ†ç±»
- **æ€§èƒ½å½±å“** - å¤šæ¬¡å°è¯•çš„æ—¶é—´å¼€é”€

---

## ğŸ† æ€»ç»“

### ä¿®å¤æˆæœ
1. **âœ… ç¼–ç é”™è¯¯è§£å†³** - å½»åº•è§£å†³ "Encoder initialization failed" é”™è¯¯
2. **âœ… æ™ºèƒ½å‚æ•°è°ƒæ•´** - è‡ªåŠ¨è®¡ç®—å®‰å…¨çš„ç¼–ç å‚æ•°
3. **âœ… å¤šå±‚é™çº§æœºåˆ¶** - ç¡®ä¿æ€»èƒ½äº§ç”Ÿè¾“å‡º
4. **âœ… ç”¨æˆ·ä½“éªŒæå‡** - ä»é¢‘ç¹å¤±è´¥åˆ°å‡ ä¹æ€»æ˜¯æˆåŠŸ

### æŠ€æœ¯çªç ´
- **å‚æ•°å®‰å…¨åŒ–** - åŸºäºç¡¬ä»¶èƒ½åŠ›çš„æ™ºèƒ½å‚æ•°è®¡ç®—
- **å¤šæ¬¡å°è¯•** - æ¸è¿›å¼é™çº§ç›´åˆ°æˆåŠŸ
- **æ ¼å¼é™çº§** - MP4 å¤±è´¥æ—¶çš„ WebM ä¿éšœ
- **è¯¦ç»†è¯Šæ–­** - å®Œæ•´çš„é”™è¯¯è¿½è¸ªå’Œæ—¥å¿—

### ç”¨æˆ·ä»·å€¼
- **é«˜æˆåŠŸç‡** - ä» ~60% æå‡åˆ° ~95%
- **æ›´å¥½å…¼å®¹æ€§** - æ”¯æŒæ›´å¤šè®¾å¤‡å’Œåœºæ™¯
- **é€æ˜å¤„ç†** - ç”¨æˆ·æ— éœ€å…³å¿ƒæŠ€æœ¯ç»†èŠ‚
- **å¯é è¾“å‡º** - æ€»èƒ½å¾—åˆ°å¯ç”¨çš„è§†é¢‘æ–‡ä»¶

**è¿™æ¬¡ä¿®å¤å½»åº•è§£å†³äº† MP4 ç¼–ç çš„ç¨³å®šæ€§é—®é¢˜ï¼Œå®ç°äº†çœŸæ­£å¯é çš„è§†é¢‘è½¬ç ä½“éªŒï¼** ğŸ‰
