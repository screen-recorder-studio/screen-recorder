# å½“å‰ç¼–ç é…ç½®è¯„ä¼°æŠ¥å‘Š

## ğŸ“Š å½“å‰é…ç½®æ¦‚è§ˆ

### Tab/Window/Screen å½•åˆ¶ï¼ˆOffscreenï¼‰

```typescript
// src/extensions/offscreen-main.ts:259

const width = settings.width || 1920
const height = settings.height || 1080
const framerate = Math.round(settings.frameRate || 30)
const bitrate = options?.bitrate || 8_000_000  // â­ å›ºå®š 8 Mbps

// GOPé…ç½®
const keyEvery = Math.max(1, framerate * 2)  // æ¯2ç§’ä¸€ä¸ªå…³é”®å¸§
```

### Area/Element å½•åˆ¶ï¼ˆContent Scriptï¼‰

```typescript
// src/extensions/content.ts:980

const width = // ä»é€‰åŒºæˆ–å…ƒç´ è®¡ç®—
const height = // ä»é€‰åŒºæˆ–å…ƒç´ è®¡ç®—
const framerate = Math.round(settings.frameRate || 30)
const bitrate = 4_000_000  // â­ å›ºå®š 4 Mbps

// GOPé…ç½®
const keyFrame = frameIndex === 0 || (frameIndex % (framerate * 2) === 0)  // æ¯2ç§’
```

### BPPè®¡ç®—å·¥å…·ï¼ˆæœªä½¿ç”¨ï¼‰

```typescript
// src/lib/utils/webcodecs-config.ts:30

export function computeBitrate(width, height, fps, fallback = 4_000_000) {
  const bpp = 0.09  // â­ å®šä¹‰äº†ä½†æœªè¢«ä½¿ç”¨
  const est = Math.floor(width * height * fps * bpp)
  return Math.max(2_000_000, Math.min(est, 25_000_000)) || fallback
}
```

---

## ğŸ¯ è´¨é‡æ¡£ä½è¯„ä¼°

### 1. Tab/Window/Screen å½•åˆ¶ï¼š**é«˜è´¨é‡æ¡£ä½**

#### å®é™…å‚æ•°

| å‚æ•° | å½“å‰å€¼ | è¯´æ˜ |
|------|--------|------|
| ç ç‡ | 8 Mbps | å›ºå®šå€¼ |
| GOP | 2ç§’ | framerate Ã— 2 |
| ç¼–è§£ç å™¨ | H.264ä¼˜å…ˆ | è‡ªåŠ¨æ¢æµ‹ |
| ç ç‡æ¨¡å¼ | æœªæŒ‡å®š | é»˜è®¤VBR |
| ç¡¬ä»¶åŠ é€Ÿ | æœªæŒ‡å®š | é»˜è®¤ä¼˜å…ˆç¡¬ä»¶ |

#### BPPåˆ†æï¼ˆ1080p@30fpsï¼‰

```typescript
// å½“å‰é…ç½®
bitrate = 8_000_000 bps
pixels = 1920 Ã— 1080 = 2,073,600
fps = 30

// åæ¨BPP
bpp = bitrate / (pixels Ã— fps)
    = 8_000_000 / (2_073_600 Ã— 30)
    = 8_000_000 / 62_208_000
    = 0.1286

// å¯¹æ¯”é¢„è®¾
é¢„è®¾BPP = {
  'èŠ‚çœç©ºé—´': 0.06,
  'å¹³è¡¡': 0.09,
  'é«˜è´¨é‡': 0.15
}

// ç»“è®ºï¼š0.1286 ä»‹äº"å¹³è¡¡"å’Œ"é«˜è´¨é‡"ä¹‹é—´ï¼Œåå‘é«˜è´¨é‡
```

#### ä¸åŒåˆ†è¾¨ç‡çš„BPP

| åˆ†è¾¨ç‡ | å¸§ç‡ | å›ºå®šç ç‡ | å®é™…BPP | æ¡£ä½è¯„ä¼° |
|--------|------|---------|---------|---------|
| 1920Ã—1080 | 30fps | 8 Mbps | **0.129** | ğŸŸ¡ **åé«˜è´¨é‡** |
| 1920Ã—1080 | 60fps | 8 Mbps | **0.064** | ğŸŸ¢ **èŠ‚çœç©ºé—´** |
| 2560Ã—1440 | 30fps | 8 Mbps | **0.072** | ğŸŸ¢ **èŠ‚çœç©ºé—´** |
| 2560Ã—1440 | 60fps | 8 Mbps | **0.036** | ğŸ”´ **è¿‡ä½** |
| 3840Ã—2160 | 30fps | 8 Mbps | **0.032** | ğŸ”´ **ä¸¥é‡ä¸è¶³** |
| 1280Ã—720 | 30fps | 8 Mbps | **0.289** | ğŸ”´ **è¿‡é«˜ï¼ˆæµªè´¹ï¼‰** |

#### é—®é¢˜åˆ†æ

```typescript
// âŒ é—®é¢˜1ï¼šå›ºå®šç ç‡ä¸é€‚åº”åˆ†è¾¨ç‡å˜åŒ–
const bitrate = 8_000_000  // æ€»æ˜¯8 Mbps

// 1080p@30fps: 8 Mbps â†’ BPP 0.129 âœ… åˆé€‚
// 4K@30fps:    8 Mbps â†’ BPP 0.032 âŒ ä¸¥é‡ä¸è¶³ï¼ˆåº”è¯¥20+ Mbpsï¼‰
// 720p@30fps:  8 Mbps â†’ BPP 0.289 âŒ è¿‡é«˜ï¼ˆåº”è¯¥3-4 Mbpsï¼‰

// âœ… åº”è¯¥ä½¿ç”¨åŠ¨æ€è®¡ç®—
const bitrate = computeBitrate(width, height, framerate)
// 1080p@30fps: 5.6 Mbps (BPP 0.09)
// 4K@30fps:    23.3 Mbps (BPP 0.09)
// 720p@30fps:  2.5 Mbps (BPP 0.09)
```

### 2. Area/Element å½•åˆ¶ï¼š**å¹³è¡¡æ¡£ä½**

#### å®é™…å‚æ•°

| å‚æ•° | å½“å‰å€¼ | è¯´æ˜ |
|------|--------|------|
| ç ç‡ | 4 Mbps | å›ºå®šå€¼ |
| GOP | 2ç§’ | framerate Ã— 2 |
| ç¼–è§£ç å™¨ | H.264ä¼˜å…ˆ | è‡ªåŠ¨æ¢æµ‹ |

#### BPPåˆ†æï¼ˆå‡è®¾1080p@30fpsï¼‰

```typescript
// å½“å‰é…ç½®
bitrate = 4_000_000 bps
pixels = 1920 Ã— 1080 = 2,073,600
fps = 30

// åæ¨BPP
bpp = 4_000_000 / (2_073_600 Ã— 30)
    = 4_000_000 / 62_208_000
    = 0.0643

// å¯¹æ¯”é¢„è®¾
é¢„è®¾BPP = {
  'èŠ‚çœç©ºé—´': 0.06,   // â† æ¥è¿‘è¿™ä¸ª
  'å¹³è¡¡': 0.09,
  'é«˜è´¨é‡': 0.15
}

// ç»“è®ºï¼š0.064 æ¥è¿‘"èŠ‚çœç©ºé—´"æ¡£ä½
```

#### ä¸åŒåˆ†è¾¨ç‡çš„BPP

| åˆ†è¾¨ç‡ | å¸§ç‡ | å›ºå®šç ç‡ | å®é™…BPP | æ¡£ä½è¯„ä¼° |
|--------|------|---------|---------|---------|
| 1920Ã—1080 | 30fps | 4 Mbps | **0.064** | ğŸŸ¢ **èŠ‚çœç©ºé—´** |
| 1920Ã—1080 | 60fps | 4 Mbps | **0.032** | ğŸ”´ **è¿‡ä½** |
| 1280Ã—720 | 30fps | 4 Mbps | **0.144** | ğŸŸ¡ **æ¥è¿‘é«˜è´¨é‡** |
| 800Ã—600 | 30fps | 4 Mbps | **0.278** | ğŸ”´ **è¿‡é«˜ï¼ˆæµªè´¹ï¼‰** |

---

## ğŸ“ˆ è´¨é‡æ¡£ä½å¯¹æ¯”

### å½“å‰é…ç½® vs æ¨èé¢„è®¾

#### Tab/Window/Screen (1080p@30fps)

| é¡¹ç›® | å½“å‰é…ç½® | èŠ‚çœç©ºé—´ | å¹³è¡¡ | é«˜è´¨é‡ |
|------|---------|---------|------|--------|
| ç ç‡ | 8 Mbps | 3.7 Mbps | 5.6 Mbps | 9.3 Mbps |
| BPP | 0.129 | 0.06 | 0.09 | 0.15 |
| 10åˆ†é’Ÿæ–‡ä»¶ | 600 MB | 225 MB | 375 MB | 700 MB |
| **æ¡£ä½** | **ğŸŸ¡ åé«˜è´¨é‡** | - | - | - |

#### Area/Element (1080p@30fps)

| é¡¹ç›® | å½“å‰é…ç½® | èŠ‚çœç©ºé—´ | å¹³è¡¡ | é«˜è´¨é‡ |
|------|---------|---------|------|--------|
| ç ç‡ | 4 Mbps | 3.7 Mbps | 5.6 Mbps | 9.3 Mbps |
| BPP | 0.064 | 0.06 | 0.09 | 0.15 |
| 10åˆ†é’Ÿæ–‡ä»¶ | 300 MB | 225 MB | 375 MB | 700 MB |
| **æ¡£ä½** | **ğŸŸ¢ èŠ‚çœç©ºé—´** | - | - | - |

---

## ğŸ¯ æ€»ä½“è¯„ä¼°

### æ¡£ä½å®šä½

```
è´¨é‡æ¡£ä½å…‰è°±ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚çœç©ºé—´    â”‚   å¹³è¡¡      â”‚  åé«˜è´¨é‡   â”‚  é«˜è´¨é‡     â”‚
â”‚ BPP 0.06    â”‚  BPP 0.09   â”‚  BPP 0.13   â”‚  BPP 0.15   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â–²
                            Tab/Window/Screen
                            (8 Mbps @ 1080p)
                            
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ èŠ‚çœç©ºé—´    â”‚   å¹³è¡¡      â”‚  åé«˜è´¨é‡   â”‚  é«˜è´¨é‡     â”‚
â”‚ BPP 0.06    â”‚  BPP 0.09   â”‚  BPP 0.13   â”‚  BPP 0.15   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â–²
Area/Element
(4 Mbps @ 1080p)
```

### è¯„åˆ†

| ç»´åº¦ | Tab/Window/Screen | Area/Element | è¯´æ˜ |
|------|------------------|--------------|------|
| **è´¨é‡æ¡£ä½** | ğŸŸ¡ åé«˜è´¨é‡ (8/10) | ğŸŸ¢ èŠ‚çœç©ºé—´ (6/10) | ä¸ä¸€è‡´ |
| **è‡ªé€‚åº”æ€§** | âŒ å·® (2/10) | âŒ å·® (2/10) | å›ºå®šç ç‡ |
| **èµ„æºåˆ©ç”¨** | âš ï¸ ä¸­ (6/10) | âœ… å¥½ (8/10) | é«˜åˆ†è¾¨ç‡æµªè´¹ |
| **æ–‡ä»¶å¤§å°** | âš ï¸ è¾ƒå¤§ | âœ… é€‚ä¸­ | - |
| **æ€»ä½“è¯„åˆ†** | **6.5/10** | **6.0/10** | éœ€è¦æ”¹è¿› |

---

## âš ï¸ ä¸»è¦é—®é¢˜

### é—®é¢˜1ï¼šå›ºå®šç ç‡å¯¼è‡´è´¨é‡ä¸ä¸€è‡´

```typescript
// âŒ å½“å‰å®ç°
// Tab/Window/Screen
const bitrate = 8_000_000  // æ€»æ˜¯8 Mbps

// Area/Element
const bitrate = 4_000_000  // æ€»æ˜¯4 Mbps

// é—®é¢˜ï¼š
// â€¢ 1080p@30fps: 8 Mbps â†’ è´¨é‡å¥½ âœ…
// â€¢ 4K@30fps:    8 Mbps â†’ è´¨é‡å·® âŒ (åº”è¯¥20+ Mbps)
// â€¢ 720p@30fps:  8 Mbps â†’ æµªè´¹ âŒ (åº”è¯¥3-4 Mbps)
```

### é—®é¢˜2ï¼šä¸¤ç§å½•åˆ¶æ¨¡å¼è´¨é‡ä¸ä¸€è‡´

```typescript
// Tab/Window/Screen: 8 Mbps (åé«˜è´¨é‡)
// Area/Element:      4 Mbps (èŠ‚çœç©ºé—´)

// ç”¨æˆ·å›°æƒ‘ï¼š
// "ä¸ºä»€ä¹ˆå½•åˆ¶æ•´ä¸ªçª—å£æ¯”å½•åˆ¶é€‰åŒºè´¨é‡æ›´å¥½ï¼Ÿ"
// "ä¸ºä»€ä¹ˆå½•åˆ¶é€‰åŒºæ–‡ä»¶æ›´å°ï¼Ÿ"
```

### é—®é¢˜3ï¼šæœªä½¿ç”¨å·²æœ‰çš„BPPè®¡ç®—å·¥å…·

```typescript
// âœ… å·²ç»å®šä¹‰äº†å·¥å…·å‡½æ•°
export function computeBitrate(width, height, fps, fallback = 4_000_000) {
  const bpp = 0.09
  const est = Math.floor(width * height * fps * bpp)
  return Math.max(2_000_000, Math.min(est, 25_000_000)) || fallback
}

// âŒ ä½†æ²¡æœ‰ä½¿ç”¨
const bitrate = 8_000_000  // ç¡¬ç¼–ç 
```

---

## âœ… æ”¹è¿›å»ºè®®

### å»ºè®®1ï¼šä½¿ç”¨åŠ¨æ€ç ç‡è®¡ç®—ï¼ˆç«‹å³å®æ–½ï¼‰

```typescript
// src/extensions/offscreen-main.ts

import { computeBitrate } from '../lib/utils/webcodecs-config'

// âœ… æ”¹ä¸ºåŠ¨æ€è®¡ç®—
const width = settings.width || 1920
const height = settings.height || 1080
const framerate = Math.round(settings.frameRate || 30)
const bitrate = computeBitrate(width, height, framerate)  // åŠ¨æ€è®¡ç®—

// ç»“æœï¼š
// 1080p@30fps: 5.6 Mbps (BPP 0.09) - å¹³è¡¡æ¡£ä½
// 4K@30fps:    23.3 Mbps (BPP 0.09) - å¹³è¡¡æ¡£ä½
// 720p@30fps:  2.5 Mbps (BPP 0.09) - å¹³è¡¡æ¡£ä½
```

```typescript
// src/extensions/content.ts

import { computeBitrate } from '../lib/utils/webcodecs-config'

// âœ… æ”¹ä¸ºåŠ¨æ€è®¡ç®—
const bitrate = computeBitrate(width, height, framerate)  // åŠ¨æ€è®¡ç®—

// æ›¿ä»£ï¼š
// const bitrate = 4_000_000  // âŒ å›ºå®šå€¼
```

### å»ºè®®2ï¼šç»Ÿä¸€è´¨é‡æ¡£ä½

```typescript
// ä¸¤ç§å½•åˆ¶æ¨¡å¼ä½¿ç”¨ç›¸åŒçš„BPP (0.09)
// ç¡®ä¿è´¨é‡ä¸€è‡´æ€§

// Tab/Window/Screen
const bitrate = computeBitrate(width, height, framerate)  // BPP 0.09

// Area/Element
const bitrate = computeBitrate(width, height, framerate)  // BPP 0.09
```

### å»ºè®®3ï¼šæä¾›è´¨é‡é€‰é¡¹ï¼ˆå¯é€‰ï¼‰

```typescript
// å¦‚æœéœ€è¦ä¸åŒè´¨é‡æ¡£ä½ï¼Œå¯ä»¥æ·»åŠ å‚æ•°

export function computeBitrate(
  width: number, 
  height: number, 
  fps: number, 
  quality: 'space-saver' | 'balanced' | 'high-quality' = 'balanced'
): number {
  const bppMap = {
    'space-saver': 0.06,
    'balanced': 0.09,
    'high-quality': 0.15
  }
  
  const bpp = bppMap[quality]
  const est = Math.floor(width * height * fps * bpp)
  return Math.max(2_000_000, Math.min(est, 25_000_000))
}

// ä½¿ç”¨
const bitrate = computeBitrate(width, height, framerate, 'balanced')
```

---

## ğŸ“Š æ”¹è¿›åçš„æ•ˆæœé¢„æµ‹

### ä½¿ç”¨åŠ¨æ€ç ç‡åï¼ˆBPP 0.09ï¼‰

#### Tab/Window/Screen

| åˆ†è¾¨ç‡ | å¸§ç‡ | å½“å‰ç ç‡ | æ”¹è¿›åç ç‡ | æ–‡ä»¶å¤§å°å˜åŒ– |
|--------|------|---------|-----------|-------------|
| 1920Ã—1080 | 30fps | 8 Mbps | 5.6 Mbps | -30% âœ… |
| 1920Ã—1080 | 60fps | 8 Mbps | 11.2 Mbps | +40% âš ï¸ |
| 2560Ã—1440 | 30fps | 8 Mbps | 10.0 Mbps | +25% âš ï¸ |
| 3840Ã—2160 | 30fps | 8 Mbps | 23.3 Mbps | +191% âš ï¸ |
| 1280Ã—720 | 30fps | 8 Mbps | 2.5 Mbps | -69% âœ… |

#### Area/Element

| åˆ†è¾¨ç‡ | å¸§ç‡ | å½“å‰ç ç‡ | æ”¹è¿›åç ç‡ | æ–‡ä»¶å¤§å°å˜åŒ– |
|--------|------|---------|-----------|-------------|
| 1920Ã—1080 | 30fps | 4 Mbps | 5.6 Mbps | +40% âš ï¸ |
| 1280Ã—720 | 30fps | 4 Mbps | 2.5 Mbps | -38% âœ… |
| 800Ã—600 | 30fps | 4 Mbps | 1.3 Mbps | -68% âœ… |

### è´¨é‡ä¸€è‡´æ€§

```
æ”¹è¿›å‰ï¼š
Tab/Window/Screen (1080p): BPP 0.129 (åé«˜è´¨é‡)
Area/Element (1080p):      BPP 0.064 (èŠ‚çœç©ºé—´)
å·®å¼‚ï¼š2å€ âŒ

æ”¹è¿›åï¼š
Tab/Window/Screen (1080p): BPP 0.09 (å¹³è¡¡)
Area/Element (1080p):      BPP 0.09 (å¹³è¡¡)
å·®å¼‚ï¼š0 âœ…
```

---

## ğŸ¯ æœ€ç»ˆç»“è®º

### å½“å‰é…ç½®å®šä½

1. **Tab/Window/Screen (8 Mbps)**
   - æ¡£ä½ï¼š**åé«˜è´¨é‡**ï¼ˆBPP 0.129 @ 1080p@30fpsï¼‰
   - é€‚åˆï¼š1080på½•åˆ¶
   - é—®é¢˜ï¼šé«˜åˆ†è¾¨ç‡ä¸è¶³ï¼Œä½åˆ†è¾¨ç‡æµªè´¹

2. **Area/Element (4 Mbps)**
   - æ¡£ä½ï¼š**èŠ‚çœç©ºé—´**ï¼ˆBPP 0.064 @ 1080p@30fpsï¼‰
   - é€‚åˆï¼šå°å°ºå¯¸é€‰åŒº
   - é—®é¢˜ï¼šå¤§é€‰åŒºè´¨é‡ä¸è¶³

### æ¨èæ”¹è¿›

**ç«‹å³å®æ–½ï¼ˆ5åˆ†é’Ÿï¼‰ï¼š**

```typescript
// 1. ä¿®æ”¹ src/extensions/offscreen-main.ts:259
- const bitrate = options?.bitrate || 8_000_000
+ const bitrate = options?.bitrate || computeBitrate(width, height, framerate)

// 2. ä¿®æ”¹ src/extensions/content.ts:980
- bitrate: 4_000_000
+ bitrate: computeBitrate(width, height, framerate)
```

**é¢„æœŸæ•ˆæœï¼š**
- âœ… è´¨é‡ä¸€è‡´æ€§ï¼šä¸¤ç§æ¨¡å¼ç»Ÿä¸€ä¸º"å¹³è¡¡"æ¡£ä½ï¼ˆBPP 0.09ï¼‰
- âœ… è‡ªé€‚åº”æ€§ï¼šè‡ªåŠ¨é€‚åº”ä¸åŒåˆ†è¾¨ç‡
- âœ… èµ„æºä¼˜åŒ–ï¼šé«˜åˆ†è¾¨ç‡æé«˜è´¨é‡ï¼Œä½åˆ†è¾¨ç‡å‡å°æ–‡ä»¶
- âœ… ç”¨æˆ·ä½“éªŒï¼šè´¨é‡å¯é¢„æµ‹ï¼Œæ–‡ä»¶å¤§å°åˆç†

**è¯„åˆ†æå‡ï¼š**
- Tab/Window/Screen: 6.5/10 â†’ **8.5/10**
- Area/Element: 6.0/10 â†’ **8.5/10**

