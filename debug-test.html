<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>录制调试测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        #log {
            background: #f0f0f0;
            padding: 10px;
            margin-top: 20px;
            height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
    </style>
</head>
<body>
    <h1>Chrome扩展录制调试测试</h1>
    
    <div>
        <button id="testPermission">1. 测试权限请求</button>
        <button id="testStream">2. 测试媒体流获取</button>
        <button id="testRecorder">3. 测试MediaRecorder</button>
        <button id="clearLog">清除日志</button>
    </div>
    
    <div id="log"></div>
    
    <script>
        const log = document.getElementById('log');
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${timestamp}] ${message}`;
            log.appendChild(logEntry);
            log.scrollTop = log.scrollHeight;
        }
        
        // 测试权限请求
        document.getElementById('testPermission').addEventListener('click', async () => {
            addLog('开始测试权限请求...');
            
            try {
                // 模拟扩展的权限请求
                const response = await new Promise((resolve) => {
                    chrome.runtime.sendMessage(
                        { action: 'requestScreenCapture' },
                        (response) => {
                            resolve(response);
                        }
                    );
                });
                
                if (response && response.success) {
                    addLog(`权限请求成功! StreamId: ${response.streamId}`, 'success');
                    window.testStreamId = response.streamId;
                } else {
                    addLog(`权限请求失败: ${response?.error || '未知错误'}`, 'error');
                }
            } catch (error) {
                addLog(`权限请求异常: ${error.message}`, 'error');
            }
        });
        
        // 测试媒体流获取
        document.getElementById('testStream').addEventListener('click', async () => {
            if (!window.testStreamId) {
                addLog('请先执行步骤1: 测试权限请求', 'error');
                return;
            }
            
            addLog('开始测试媒体流获取...');
            
            // 测试不同的约束格式
            const constraintFormats = [
                {
                    name: '格式1: mandatory',
                    constraints: {
                        audio: false,
                        video: {
                            mandatory: {
                                chromeMediaSource: 'desktop',
                                chromeMediaSourceId: window.testStreamId,
                                maxWidth: 1920,
                                maxHeight: 1080
                            }
                        }
                    }
                },
                {
                    name: '格式2: 直接属性',
                    constraints: {
                        audio: false,
                        video: {
                            chromeMediaSource: 'desktop',
                            chromeMediaSourceId: window.testStreamId
                        }
                    }
                },
                {
                    name: '格式3: mediaSource',
                    constraints: {
                        audio: false,
                        video: {
                            mediaSource: 'screen',
                            chromeMediaSourceId: window.testStreamId
                        }
                    }
                }
            ];
            
            for (const format of constraintFormats) {
                addLog('\n尝试 ' + format.name + '...');
                addLog('约束: ' + JSON.stringify(format.constraints, null, 2));
                
                try {
                    const stream = await navigator.mediaDevices.getUserMedia(format.constraints);
                    addLog('✓ ' + format.name + ' 成功!', 'success');
                    addLog('  - Stream ID: ' + stream.id);
                    addLog('  - Active: ' + stream.active);
                    addLog('  - Video tracks: ' + stream.getVideoTracks().length);
                    
                    window.testStream = stream;
                    
                    // 停止流以便测试其他格式
                    setTimeout(() => {
                        stream.getTracks().forEach(track => track.stop());
                    }, 1000);
                    
                    break;
                } catch (error) {
                    addLog('✗ ' + format.name + ' 失败: ' + error.name + ' - ' + error.message, 'error');
                }
            }
        });
        
        // 测试MediaRecorder
        document.getElementById('testRecorder').addEventListener('click', async () => {
            if (!window.testStream || !window.testStream.active) {
                addLog('请先执行步骤2: 测试媒体流获取', 'error');
                return;
            }
            
            addLog('开始测试MediaRecorder...');
            
            const mimeTypes = [
                'video/webm;codecs=vp9',
                'video/webm;codecs=vp8',
                'video/webm',
                'video/mp4'
            ];
            
            // 测试支持的MIME类型
            addLog('\n检查支持的MIME类型:');
            for (const type of mimeTypes) {
                const supported = MediaRecorder.isTypeSupported(type);
                addLog('  ' + type + ': ' + (supported ? '✓ 支持' : '✗ 不支持'), supported ? 'success' : 'info');
            }
            
            // 尝试创建MediaRecorder
            try {
                const options = {
                    mimeType: mimeTypes.find(t => MediaRecorder.isTypeSupported(t)) || 'video/webm',
                    videoBitsPerSecond: 2500000
                };
                
                addLog(`\n创建MediaRecorder，选项: ${JSON.stringify(options)}`);
                const recorder = new MediaRecorder(window.testStream, options);
                
                addLog('MediaRecorder创建成功!', 'success');
                addLog(`初始状态: ${recorder.state}`);
                
                // 设置事件监听
                recorder.onstart = () => {
                    addLog('MediaRecorder.onstart 事件触发!', 'success');
                    addLog(`当前状态: ${recorder.state}`);
                };
                
                recorder.ondataavailable = (event) => {
                    addLog(`收到数据块: ${event.data.size} bytes`);
                };
                
                recorder.onstop = () => {
                    addLog('MediaRecorder.onstop 事件触发');
                };
                
                recorder.onerror = (event) => {
                    addLog(`MediaRecorder错误: ${event.error}`, 'error');
                };
                
                // 开始录制
                addLog('\n调用 recorder.start()...');
                recorder.start(1000);
                addLog(`start()后的状态: ${recorder.state}`);
                
                // 检查状态
                setTimeout(() => {
                    addLog(`\n1秒后的状态: ${recorder.state}`);
                    if (recorder.state === 'recording') {
                        addLog('录制正在进行中!', 'success');
                        
                        // 3秒后停止
                        setTimeout(() => {
                            addLog('\n停止录制...');
                            recorder.stop();
                        }, 3000);
                    }
                }, 1000);
                
            } catch (error) {
                addLog(`MediaRecorder创建失败: ${error.message}`, 'error');
            }
        });
        
        // 清除日志
        document.getElementById('clearLog').addEventListener('click', () => {
            log.innerHTML = '';
            addLog('日志已清除');
        });
        
        // 初始消息
        addLog('调试工具准备就绪。请按顺序点击测试按钮。');
    </script>
</body>
</html>
