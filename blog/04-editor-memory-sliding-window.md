# Web è§†é¢‘å‰ªè¾‘å¼•æ“ (1)ï¼šå†…å­˜è™šæ‹ŸåŒ–ä¸æ»‘åŠ¨çª—å£æœºåˆ¶

æƒ³è±¡ä¸€ä¸‹ï¼Œä½ åˆšå½•åˆ¶å®Œä¸€åœºç²¾å½©çš„ 10 åˆ†é’Ÿ 4K æ¸¸æˆå¯¹å±€ï¼Œå…´å†²å†²åœ°æŠŠè¿™ä¸ª 5GB çš„è§†é¢‘æ–‡ä»¶æ‹–è¿›æµè§ˆå™¨å‡†å¤‡å‰ªè¾‘ã€‚è¿›åº¦æ¡åˆšèµ°åˆ°ä¸€åŠï¼Œå±å¹•çªç„¶ä¸€ç™½ï¼Œå¼¹å‡ºäº†é‚£å¼ ç†Ÿæ‚‰çš„ã€ä»¤äººå¿ƒç¢çš„è„¸â€”â€”**"Aw, Snap!" (å´©æºƒå•¦)**ã€‚

è¿™å°±æ˜¯æˆ‘ä»¬åœ¨å¼€å‘ **Screen Recorder Studio** æ—¶æ’ä¸Šçš„ç¬¬ä¸€å µå¢™ã€‚

åœ¨æµè§ˆå™¨ä¸­åšè§†é¢‘å‰ªè¾‘ï¼Œæœ€å¤§çš„æ•Œäººä¸æ˜¯å¤æ‚çš„ç¼–ç ç®—æ³•ï¼Œè€Œæ˜¯**å†…å­˜ï¼ˆMemoryï¼‰**ã€‚ä¼ ç»Ÿçš„æ¡Œé¢è½¯ä»¶ï¼ˆå¦‚ Premiereï¼‰å¯ä»¥ç›´æ¥è¯»å†™ç¡¬ç›˜ï¼Œä½†åœ¨ Web çš„æ²™ç›’é‡Œï¼Œå¦‚æœæˆ‘ä»¬è¯•å›¾å°†ä¸€ä¸ªå®Œæ•´çš„é•¿è§†é¢‘åŠ è½½è¿›å†…å­˜ï¼ˆRAMï¼‰ï¼ŒV8 å¼•æ“ä¼šæ¯«ä¸ç•™æƒ…åœ°é€šè¿‡ OOMï¼ˆOut of Memoryï¼‰æ•™æˆ‘ä»¬åšäººã€‚

æˆ‘ä»¬è¦å®ç°çš„ç›®æ ‡æ˜¯â€œæ— é™æ—¶é•¿â€å½•åˆ¶ä¸ç¼–è¾‘ã€‚ä¸ºäº†åšåˆ°è¿™ä¸€ç‚¹ï¼Œæˆ‘ä»¬ä¸èƒ½ç¡¬ç¢°ç¡¬ï¼Œè€Œå¿…é¡»å­¦ä¼šâ€œæ¬ºéª—â€æµè§ˆå™¨ï¼š**è®©å®ƒä»¥ä¸ºæˆ‘ä»¬åªåœ¨å¤„ç†ä¸€å°æ®µè§†é¢‘ï¼Œè€Œå®é™…ä¸Šæˆ‘ä»¬åœ¨æ“ä½œä¸€ä¸ªåºå¤§çš„æ•°æ®é›†ã€‚**

è¿™å°±æ˜¯**å†…å­˜è™šæ‹ŸåŒ–**ä¸**æ»‘åŠ¨çª—å£**çš„æ•…äº‹ã€‚

> ğŸŒŸ **å…³äºæœ¬é¡¹ç›®**
> Screen Recorder Studio æ˜¯ä¸€ä¸ªåŸºäº Web æŠ€æœ¯çš„å¼€æºè§†é¢‘å½•åˆ¶ä¸ç¼–è¾‘å·¥å…·ã€‚å¦‚æœä½ å¯¹å…¶ä¸­çš„æŠ€æœ¯å®ç°æ„Ÿå…´è¶£ï¼Œæ¬¢è¿è®¿é—®æˆ‘ä»¬çš„ [GitHub](https://github.com/screen-recorder-studio/screen-recorder) æˆ–ç›´æ¥åœ¨ [Chrome å•†åº—](https://chromewebstore.google.com/detail/screen-recorder-studio-fo/bondbeldfibfmdjlcnomlaooklacmfpa) ä½“éªŒã€‚

---

## 1. "æ»‘åŠ¨çª—å£" æ¶æ„è®¾è®¡

ä¸ºäº†è§£å†³ä¸Šè¿°é—®é¢˜ï¼Œæˆ‘ä»¬è®¾è®¡äº†**æ»‘åŠ¨çª—å£ï¼ˆSliding Windowï¼‰**æœºåˆ¶ã€‚

### æ ¸å¿ƒæ¦‚å¿µ
æƒ³è±¡ä½ åœ¨æ¼†é»‘çš„å¤œæ™šï¼Œæ‹¿ç€æ‰‹ç”µç­’èµ°è¿‡ä¸€æ¡é•¿é•¿çš„ç”»å»Šã€‚
- **å…¨å±€æ—¶é—´è½´**ï¼šæ•´æ¡ç”»å»Šï¼ˆæ¯”å¦‚ 1 å°æ—¶çš„è§†é¢‘æ–‡ä»¶ï¼Œé™é™èººåœ¨ OPFS ç¡¬ç›˜ä¸­ï¼‰ã€‚
- **å½“å‰çª—å£**ï¼šæ‰‹ç”µç­’ç…§äº®çš„åŒºåŸŸï¼ˆRAM ä¸­å®é™…åŠ è½½çš„ 2-4 ç§’è§†é¢‘å—ï¼‰ã€‚
- **è§†å£ï¼ˆViewportï¼‰**ï¼šç”¨æˆ·åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„å½“å‰å¸§ã€‚

æ— è®ºè§†é¢‘æœ‰å¤šé•¿ï¼Œæˆ‘ä»¬å†…å­˜ä¸­æ°¸è¿œåªä¿ç•™â€œæ‰‹ç”µç­’â€ç…§äº®çš„é‚£ä¸€å°éƒ¨åˆ†æ•°æ®ã€‚å½“ç”¨æˆ·æ‹–åŠ¨æ—¶é—´è½´æ—¶ï¼Œæˆ‘ä»¬å¹¶ä¸ç§»åŠ¨åºå¤§çš„è§†é¢‘æ–‡ä»¶ï¼Œè€Œæ˜¯ç§»åŠ¨é‚£ä¸ªè½»é‡çš„â€œæ‰‹ç”µç­’â€ã€‚

```mermaid
graph LR
    Total[å…¨å±€è§†é¢‘æ–‡ä»¶ (OPFS Disk)]
    Window[å†…å­˜çª—å£ (RAM ArrayBuffer)]
    Player[æ’­æ”¾å™¨/è§£ç å™¨]

    Total -- "Seek 00:15" --> Window
    subgraph "æ»‘åŠ¨çª—å£ (Sliding Window)"
    Window -- "åŠ è½½ [00:13 ~ 00:17]" --> Player
    end
    
    style Window fill:#f9f,stroke:#333,stroke-width:2px
```

### çŠ¶æ€å®šä¹‰
åœ¨ `@src/routes/studio/+page.svelte` ä¸­ï¼Œæˆ‘ä»¬å®šä¹‰äº†é©±åŠ¨è¿™ä¸€æœºåˆ¶çš„æ ¸å¿ƒçŠ¶æ€ï¼š

```typescript
// æ—¶é—´è½´ä¸çª—å£çŠ¶æ€ï¼ˆæ¯«ç§’ï¼‰
let durationMs = $state(0);       // è§†é¢‘æ€»æ—¶é•¿
let windowStartMs = $state(0);    // å½“å‰çª—å£çš„èµ·å§‹æ—¶é—´
let windowEndMs = $state(0);      // å½“å‰çª—å£çš„ç»“æŸæ—¶é—´

// å…¨å±€å¸§ç´¢å¼•
let globalTotalFrames = $state(0); // æ€»å¸§æ•°
let windowStartIndex = $state(0);  // å½“å‰çª—å£ç¬¬ä¸€å¸§åœ¨å…¨å±€çš„ç´¢å¼•
```

## 2. æ ¸å¿ƒç®—æ³•ï¼šæ™ºèƒ½çª—å£è®¡ç®—

å¦‚ä½•å†³å®šçª—å£è¯¥â€œåˆ‡â€å“ªä¸€éƒ¨åˆ†ï¼Ÿæˆ‘ä»¬åœ¨ `computeFrameWindow` å‡½æ•°ä¸­å®ç°äº†è¿™ä¸€é€»è¾‘ã€‚å®ƒä¸ä»…ä»…æ˜¯ç®€å•çš„â€œå‰åå„å– 2 ç§’â€ï¼Œè€Œæ˜¯åŒ…å«äº†ä¸€å¥—åŸºäºç”¨æˆ·è¡Œä¸ºçš„é¢„æµ‹ç­–ç•¥ã€‚

å®é™…å®ç°ä¸­ï¼Œ`framesBefore` / `framesAfter` ä¼šå…ˆæ ¹æ®ä¼ å…¥çš„ `beforeMs` / `afterMs` å’Œæ¨æ–­å‡ºçš„æºè§†é¢‘ FPS æ¢ç®—æˆå¸§æ•°ï¼Œå†ç»“åˆæœ€å°/æœ€å¤§çª—å£å¤§å°åšè£å‰ªï¼Œè¿™é‡Œåªä¿ç•™æ ¸å¿ƒæ€è·¯ï¼Œæ–¹ä¾¿é˜…è¯»ã€‚

### ç­–ç•¥åŒºåˆ†
1.  **Seek æ¨¡å¼ï¼ˆè·³è½¬ï¼‰**ï¼šç”¨æˆ·ç‚¹å‡»äº†æ—¶é—´è½´çš„æŸä¸€ç‚¹ã€‚
    - ç­–ç•¥ï¼šä»¥ç‚¹å‡»ç‚¹ä¸ºä¸­å¿ƒï¼Œå‰åå„åŠ è½½ä¸€éƒ¨åˆ†ï¼ˆä¾‹å¦‚ `before=1.5s`, `after=1.5s`ï¼‰ã€‚ä¿è¯ç”¨æˆ·æ—¢èƒ½çœ‹åˆ°å½“å‰å¸§ï¼Œä¹Ÿèƒ½ç«‹å³è¿›è¡Œå°å¹…åº¦çš„å‰åå¾®è°ƒã€‚
2.  **Play æ¨¡å¼ï¼ˆæ’­æ”¾ï¼‰**ï¼šè§†é¢‘æ­£åœ¨è¿ç»­æ’­æ”¾ã€‚
    - ç­–ç•¥ï¼š**æ¿€è¿›çš„åå‘åŠ è½½**ã€‚æˆ‘ä»¬ä¸éœ€è¦åŠ è½½â€œè¿‡å»â€çš„å¸§ï¼Œè€Œæ˜¯å°†èµ„æºå…¨éƒ¨ç”¨äºåŠ è½½â€œæœªæ¥â€çš„å¸§ã€‚æ£€æµ‹åˆ°æ’­æ”¾å¤´æ¥è¿‘çª—å£è¾¹ç¼˜æ—¶ï¼Œé™é»˜è§¦å‘ä¸‹ä¸€ä¸ªçª—å£çš„é¢„å–ã€‚

### ä»£ç è§£æ
è¿™æ˜¯ `computeFrameWindow` çš„ç®€åŒ–é€»è¾‘ï¼š

```typescript
function computeFrameWindow(params: FrameWindowParams): FrameWindowResult {
  const { centerMs, beforeMs, afterMs, fps, mode } = params;
  
  // 1. è®¡ç®—ç›®æ ‡å¸§ç´¢å¼•
  const targetFrameIndex = Math.floor((centerMs / 1000) * fps);
  
  // 2. æ ¹æ®æ¨¡å¼è°ƒæ•´çª—å£èŒƒå›´
  // å¦‚æœæ˜¯é¢„å– (prefetch)ï¼Œæˆ‘ä»¬åªå…³å¿ƒæœªæ¥çš„æ•°æ®
  const minWindowFrames = mode === 'prefetch' ? fps : fps * 2;
  
  // 3. å…³é”®å¸§å¯¹é½ (Keyframe Alignment) - æå…¶é‡è¦ï¼
  // æˆ‘ä»¬ä¸èƒ½éšæ„ä»ç¬¬ N å¸§å¼€å§‹åˆ‡ï¼Œå¿…é¡»æ‰¾åˆ°ç¬¬ N å¸§ä¹‹å‰çš„æœ€è¿‘å…³é”®å¸§ (I-Frame)
  // å¦åˆ™è§£ç å™¨ä¼šå› ä¸ºç¼ºå°‘å‚è€ƒå¸§è€ŒèŠ±å±
  let startFrame = targetFrameIndex - framesBefore;
  
  if (keyframeInfo) {
     // å›æº¯åˆ°æœ€è¿‘çš„å…³é”®å¸§
     startFrame = findNearestKeyframe(keyframeInfo, startFrame);
  }

  return { startFrame, frameCount, ... };
}
```

## 3. æ•°æ®æµä¸ Svelte 5 å“åº”å¼é©±åŠ¨

Screen Recorder Studio å…¨é¢é‡‡ç”¨äº† **Svelte 5 Runes** (`$state`, `$derived`, `$effect`) æ¥ç®¡ç†è¿™å¥—å¤æ‚çš„æ•°æ®æµã€‚

### ä¸ºä»€ä¹ˆé€‰æ‹© Svelte 5ï¼Ÿ
åœ¨å¤„ç†é«˜é¢‘è§¦å‘çš„è§†é¢‘äº‹ä»¶ï¼ˆ60fps æ›´æ–°ï¼‰æ—¶ï¼ŒReact çš„ Virtual DOM Diff æˆ– Vue çš„ä¾èµ–è¿½è¸ªå¯èƒ½ä¼šå¸¦æ¥ä¸å¿…è¦çš„å¼€é”€ã€‚Svelte 5 çš„ç»†ç²’åº¦å“åº”å¼è®©æˆ‘ä»¬èƒ½ç²¾ç¡®æ§åˆ¶æ›´æ–°èŒƒå›´ã€‚

### è°ƒåº¦æµç¨‹
1.  **è§¦å‘**ï¼š`VideoPreviewComposite` ç»„ä»¶æ£€æµ‹åˆ°éœ€è¦æ•°æ®ï¼ˆä¾‹å¦‚æ’­æ”¾åˆ°äº†çª—å£è¾¹ç¼˜ï¼‰ï¼Œå›è°ƒ `onRequestWindow`ã€‚
2.  **è®¡ç®—**ï¼šä¸»çº¿ç¨‹è°ƒç”¨ `computeFrameWindow` è®¡ç®—å‡ºæ–°çš„ `startFrame` å’Œ `count`ã€‚
3.  **é€šä¿¡**ï¼šé€šè¿‡ `postMessage` å‘ `opfs-reader-worker` å‘é€æŒ‡ä»¤ã€‚
4.  **æ¥æ”¶ä¸æ›¿æ¢**ï¼š
    Worker ä» OPFS è¯»å–äºŒè¿›åˆ¶æ•°æ®å¹¶è¿”å›ã€‚ä¸»çº¿ç¨‹æ¥æ”¶åˆ°æ•°æ®åï¼Œ**ç›´æ¥æ›¿æ¢**æ•´ä¸ª `workerEncodedChunks` æ•°ç»„ã€‚

    ```typescript
    // opfs-reader-worker.ts è¿”å›æ•°æ®
    readerWorker.onmessage = (ev) => {
      if (type === "range") {
        // æ ¸å¿ƒï¼šæ—§æ•°ç»„è¢«ä¸¢å¼ƒï¼Œæ–°æ•°ç»„æ¥ç®¡ã€‚
        // JS å¼•æ“çš„ GC ä¼šè´Ÿè´£å›æ”¶æ—§æ•°ç»„çš„å†…å­˜ã€‚
        workerEncodedChunks = chunks; 
        windowStartIndex = start;
        // ...æ›´æ–°çŠ¶æ€ï¼Œé€šçŸ¥ UI é‡ç»˜
      }
    }
    ```

## 4. æ€§èƒ½ä¼˜åŒ–çš„ä¸¤ä¸ªå…³é”®ç‚¹

åœ¨å®ç°æ»‘åŠ¨çª—å£æ—¶ï¼Œæˆ‘ä»¬å‘ç°äº†ä¸¤ä¸ªå†³å®šæˆè´¥çš„æ€§èƒ½ç»†èŠ‚ã€‚

### 4.1 å†…å­˜ç­–ç•¥ï¼š"æ•´çª—æ›¿æ¢" vs "è¿½åŠ ç¼“å†²"
åœ¨**æ•°æ®å±‚ï¼ˆCompressed Chunksï¼‰**ï¼Œæˆ‘ä»¬é€‰æ‹©äº†**æ•´çª—æ›¿æ¢**ç­–ç•¥ã€‚
- **è¿½åŠ ç¼“å†² (Ring Buffer)**ï¼šè™½ç„¶å¬èµ·æ¥æ›´â€œå¤ç”¨â€ï¼Œä½†åœ¨ Web Worker é—´é¢‘ç¹ä¼ é€’å°å—æ•°æ®å¹¶ç»´æŠ¤å¤æ‚çš„ç¯å½¢æŒ‡é’ˆææ˜“å‡ºé”™ï¼ˆOff-by-one errorï¼‰ï¼Œä¸”å®¹æ˜“äº§ç”Ÿå†…å­˜ç¢ç‰‡ã€‚
- **æ•´çª—æ›¿æ¢**ï¼šç®€å•ç²—æš´ã€‚æ¯æ¬¡çª—å£åˆ‡æ¢ï¼Œæ—§çš„ `ArrayBuffer` å¼•ç”¨ä¸¢å¤±ï¼Œæ–°çš„ `ArrayBuffer` è¿›åœºã€‚
- **ä¼˜åŠ¿**ï¼šåˆ©ç”¨æµè§ˆå™¨é«˜æ•ˆçš„åƒåœ¾å›æ”¶ï¼ˆGCï¼‰æœºåˆ¶ï¼Œé¿å…äº†æ‰‹åŠ¨å†…å­˜ç®¡ç†çš„å¤æ‚æ€§ã€‚åªè¦æˆ‘ä»¬ä¸åœ¨æ­¤ä¹‹å¤–æŒæœ‰å¯¹æ—§ Chunk çš„å¼•ç”¨ï¼Œå†…å­˜å°±èƒ½å§‹ç»ˆä¿æŒåœ¨ä¸€ä¸ªå¹³ç¨³çš„æ°´ä½ï¼ˆä¾‹å¦‚å§‹ç»ˆåªæœ‰ 100MBï¼‰ã€‚

> **æ³¨**ï¼šåœ¨**è§£ç å±‚ï¼ˆVideoFramesï¼‰**ï¼Œç”±äº `VideoFrame` å¯¹è±¡æŒæœ‰æ˜¾å­˜èµ„æºä¸”å¿…é¡»æ‰‹åŠ¨ `close()`ï¼Œæˆ‘ä»¬åœ¨ Worker å†…éƒ¨ä¾ç„¶ç»´æŠ¤äº†ä¸€ä¸ªä¸¥æ ¼é™åˆ¶å¤§å°çš„é˜Ÿåˆ—ï¼ˆä¾‹å¦‚æœ€å¤š 150 å¸§ï¼‰ï¼Œè¿™ä¸æ•°æ®å±‚çš„ç­–ç•¥æœ‰æ‰€ä¸åŒã€‚

### 4.2 I/O ç­–ç•¥ï¼šæ‰¹é‡è¯»å– (Batch Read)
è¿™æ˜¯æˆ‘ä»¬åœ¨æ€§èƒ½åˆ†æä¸­å‘ç°çš„ P0 çº§ä¼˜åŒ–ç‚¹ã€‚
æœ€åˆï¼Œæˆ‘ä»¬çš„é€»è¾‘æ˜¯â€œè¦ 100 å¸§ï¼Œå°±å¾ªç¯ 100 æ¬¡ `FileHandle.slice()`â€ã€‚ç»“æœå‘ç°æ‹–åŠ¨æ—¶é—´è½´æ—¶ I/O å»¶è¿Ÿå·¨å¤§ã€‚

**ä¼˜åŒ–å**ï¼šæˆ‘ä»¬å…ˆè®¡ç®—çª—å£çš„å­—èŠ‚èŒƒå›´ã€‚
1. æ‰¾åˆ°ç¬¬ 1 å¸§çš„ `offset`ã€‚
2. æ‰¾åˆ°ç¬¬ 100 å¸§çš„ `offset + size`ã€‚
3. **åªæ‰§è¡Œä¸€æ¬¡** `blob.slice(start, end)` è¯»å–æ•´ä¸ª 10MB çš„äºŒè¿›åˆ¶å—ã€‚
4. åœ¨å†…å­˜ä¸­æ ¹æ® `index.jsonl` åˆ‡å‰²å‡º 100 ä¸ªå°å—ã€‚

```typescript
// src/lib/workers/opfs-reader-worker.ts
// âŒ Old: 100 IOPS
// chunks.forEach(c => file.slice(...))

// âœ… New: 1 IOPS
const totalSlice = file.slice(startOffset, endOffset); 
const totalBuf = await totalSlice.arrayBuffer();
// In-memory slicing...
```

è¿™ä¸€æ”¹åŠ¨å°† I/O è€—æ—¶ä» **50ms+** é™ä½åˆ°äº† **2ms** å·¦å³ã€‚

## 5. æ€»ç»“ä¸æ‚¬å¿µ

é€šè¿‡**æ»‘åŠ¨çª—å£æœºåˆ¶**ä¸**æ‰¹é‡ I/O ä¼˜åŒ–**ï¼ŒScreen Recorder Studio æˆåŠŸåœ°å°†â€œå¯¹æ–‡ä»¶å¤§å°çš„ä¾èµ–â€è½¬åŒ–ä¸ºäº†â€œå¯¹æ—¶é—´åˆ‡ç‰‡å¤§å°çš„ä¾èµ–â€ã€‚
- ä¸ç®¡ä½ å½•åˆ¶äº† 10 åˆ†é’Ÿè¿˜æ˜¯ 10 å°æ—¶ï¼Œå…¸å‹åœºæ™¯ä¸‹ç¼–è¾‘å™¨çš„å³°å€¼å†…å­˜å ç”¨éƒ½ç¨³å®šåœ¨**å‡ ç™¾ MB å†…**ï¼Œè€Œä¸æ˜¯éšå½•åˆ¶æ—¶é•¿çº¿æ€§å¢é•¿ã€‚
- é…åˆ Svelte 5 çš„é«˜æ€§èƒ½è°ƒåº¦ï¼Œå®ç°äº†åª²ç¾åŸç”Ÿåº”ç”¨çš„ä¸æ»‘å‰ªè¾‘ä½“éªŒã€‚

**ä½†æ˜¯ï¼Œè§£å†³äº†â€œå­˜ä¸ä¸‹â€çš„é—®é¢˜ï¼Œç´§æ¥ç€å°±æ˜¯â€œæ‰¾ä¸åˆ°â€çš„é—®é¢˜ã€‚**

å½“ç”¨æˆ·ç‚¹å‡»æ—¶é—´è½´ä¸Šçš„ `05:20` æ—¶ï¼Œæˆ‘ä»¬å¦‚ä½•åœ¨å‡  GB çš„æ–‡ä»¶ä¸­ï¼Œç¬é—´æ‰¾åˆ°é‚£è¿™ç¡®åˆ‡çš„ä¸€å¸§ï¼Ÿå¦‚æœæ‰¾é”™äº†ä½ç½®ï¼Œè§£ç å‡ºçš„ç”»é¢ä¼šä¸ä¼šèŠ±å±ï¼Ÿ

åœ¨ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†æ·±å…¥â€œå¿ƒè„â€éƒ¨ä½ï¼Œæ­ç§˜**åŸºäº OPFS ä¸ GOP çš„å¸§çº§ç²¾å‡†å®šä½**æŠ€æœ¯ã€‚

---

> **ä¸Šä¸€ç¯‡**ï¼š(æ— )
> **ä¸‹ä¸€ç¯‡**ï¼š[Web è§†é¢‘å‰ªè¾‘å¼•æ“ (2)ï¼šåŸºäº OPFS ä¸ GOP çš„å¸§çº§ç²¾å‡†å®šä½](./05-editor-seeking-gop-alignment.md)
