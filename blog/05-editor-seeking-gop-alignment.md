# Web è§†é¢‘å‰ªè¾‘å¼•æ“ (2)ï¼šåŸºäº OPFS ä¸ GOP çš„å¸§çº§ç²¾å‡†å®šä½

> ğŸŒŸ å¼€æºä¸æ˜“ï¼Œè§‰å¾—å¥½ç”¨è¯·ç»™ä¸ª Star æ”¯æŒä¸€ä¸‹ï¼š[GitHub](https://github.com/screen-recorder-studio/screen-recorder)
>
> ğŸš€ ç«‹å³å» Chrome å•†åº—å…è´¹ä½“éªŒï¼š[Chrome Web Store](https://chromewebstore.google.com/detail/screen-recorder-studio-fo/bondbeldfibfmdjlcnomlaooklacmfpa)

---

## 1. å¼•è¨€ï¼šä»â€œè™šæ‹Ÿå†…å­˜â€åˆ°â€œç²¾å‡†å¯¼èˆªâ€

åœ¨[ä¸Šä¸€ç¯‡æ–‡ç« ](./04-editor-memory-sliding-window.md)ä¸­ï¼Œæˆ‘ä»¬æˆåŠŸæ„å»ºäº†ä¸€å¥—â€œæ»‘åŠ¨çª—å£â€æœºåˆ¶ï¼Œåƒæ‰“åœ°é“æˆ˜ä¸€æ ·ï¼Œè®©æµè§ˆå™¨åœ¨æ¯«ä¸çŸ¥æƒ…çš„æƒ…å†µä¸‹å¤„ç†äº†å‡ ä¸ª GB çš„è§†é¢‘æ–‡ä»¶ã€‚å†…å­˜å´©æºƒçš„å±æœºè§£é™¤äº†ã€‚

ä½†æ˜¯ï¼Œæ–°çš„æŒ‘æˆ˜éšä¹‹è€Œæ¥ã€‚

è¯•æƒ³ä¸€ä¸‹ï¼Œç”¨æˆ·éšæ‰‹å°†è¿›åº¦æ¡æ‹–åˆ°äº† `05:20` çš„ä½ç½®ã€‚å¯¹äºä¸€ä¸ª 1GB å¤§å°çš„æ–‡ä»¶ï¼Œ`05:20` å¯¹åº”çš„æ˜¯ç¬¬å‡ å­—èŠ‚ï¼Ÿç¬¬ 100MBï¼Ÿè¿˜æ˜¯ç¬¬ 500MBï¼Ÿ

è¿™å°±åƒåœ¨æŸ¥ä¸€æœ¬æ²¡æœ‰é¡µç çš„å­—å…¸ã€‚å¦‚æœæˆ‘ä»¬ç®€å•åœ°æ ¹æ®â€œå¹³å‡æ¯”ç‰¹ç‡â€å»ä¼°ç®—ä½ç½®ï¼ˆæ¯”å¦‚ 1GB è§†é¢‘ 10åˆ†é’Ÿï¼Œé‚£ä¸­é—´å°±æ˜¯ 500MBï¼‰ï¼Œç»“æœå¾€å¾€æ˜¯ç¾éš¾æ€§çš„ï¼š**ç”¨æˆ·çœ‹åˆ°çš„ç”»é¢å¯èƒ½ä¼šèŠ±å±ï¼Œæˆ–è€…æ—¶é—´é”™ä¹±ã€‚**

ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥ Screen Recorder Studio çš„å­˜å‚¨ä¸è¯»å–å¼•æ“ï¼ˆ`opfs-reader-worker.ts`ï¼‰ï¼Œæ­ç§˜å¦‚ä½•å®ç°**å¸§çº§ç²¾å‡†ï¼ˆFrame-Accurateï¼‰**çš„å®šä½ã€‚

## 2. è§†é¢‘çš„ç‰©ç†å®šå¾‹ï¼šGOP ä¸ä¾èµ–é“¾

è¦ç†è§£æˆ‘ä»¬çš„ä»£ç é€»è¾‘ï¼Œé¦–å…ˆå¾—ç†è§£è§†é¢‘ç¼–ç çš„ä¸€ä¸ªç‰©ç†å®šå¾‹ï¼š**ä¸æ˜¯æ¯ä¸€å¸§éƒ½æ˜¯ç‹¬ç«‹çš„**ã€‚

ç°ä»£è§†é¢‘ç¼–ç ï¼ˆH.264, VP9, AV1ï¼‰ä¸ºäº†æè‡´å‹ç¼©ï¼Œå°†è§†é¢‘åˆ‡åˆ†ä¸ºä¸€ä¸ªä¸ª **GOP (Group of Pictures)**ã€‚

```mermaid
graph LR
    I1[I-Frame #0] --> P1[P-Frame #1]
    P1 --> P2[P-Frame #2]
    P2 --> P3[P-Frame #3]
    P3 --> I2[I-Frame #4]
    I2 --> P4[P-Frame #5]
    
    style I1 fill:#f96,stroke:#333,stroke-width:2px
    style I2 fill:#f96,stroke:#333,stroke-width:2px
    style P1 fill:#9cf,stroke:#333
    style P2 fill:#9cf,stroke:#333
    style P3 fill:#9cf,stroke:#333
    style P4 fill:#9cf,stroke:#333
```

- **I å¸§ï¼ˆå…³é”®å¸§ / Keyframeï¼‰**ï¼šä¸€å¼ å®Œæ•´çš„å›¾ç‰‡ï¼Œä¸ä¾èµ–ä»»ä½•äººã€‚å°±åƒâ€œå­˜æ¡£ç‚¹â€ã€‚
- **P/B å¸§ï¼ˆDelta å¸§ï¼‰**ï¼šåªè®°å½•ç›¸å¯¹äºå‰ä¸€å¸§çš„â€œå˜åŒ–é‡â€ã€‚å°±åƒâ€œä¸‹ä¸€é¡µâ€çš„æŒ‡ä»¤ã€‚

**è¿™æ„å‘³ç€ï¼š**
å¦‚æœä½ ç›´æ¥è¯»å–ç¬¬ 3 å¸§ï¼ˆP å¸§ï¼‰çš„æ•°æ®å–‚ç»™è§£ç å™¨ï¼Œè§£ç å™¨ä¼šä¸€è„¸èŒ«ç„¶ï¼šâ€œå˜åŒ–é‡ï¼ŸåŸºäºè°çš„å˜åŒ–ï¼Ÿâ€ç»“æœå°±æ˜¯**èŠ±å±ï¼ˆArtifactsï¼‰**ã€‚

**ç”±æ­¤å¼•å‡ºæˆ‘ä»¬çš„æ ¸å¿ƒç®—æ³•é“å¾‹ï¼š**
> **æ— è®ºç”¨æˆ·è¯·æ±‚å“ªä¸€å¸§ï¼Œè¯»å–æ“ä½œéƒ½å¿…é¡»â€œå›æº¯â€åˆ°è¯¥å¸§æ‰€å± GOP çš„å¼€å¤´ï¼ˆI å¸§ï¼‰ã€‚**

## 3. ç»˜åˆ¶åœ°å›¾ï¼š`index.jsonl`

ä¸ºäº†åœ¨èŒ«èŒ«äºŒè¿›åˆ¶æ•°æ®ä¸­å¿«é€Ÿå¯¼èˆªï¼Œæˆ‘ä»¬åœ¨å½•åˆ¶é˜¶æ®µå°±ç»˜åˆ¶äº†ä¸€å¼ â€œåœ°å›¾â€ã€‚

æ‰“å¼€ OPFS ä¸­çš„å½•åˆ¶ç›®å½•ï¼Œä½ ä¼šå‘ç°ä¸€ä¸ª `index.jsonl` æ–‡ä»¶ã€‚ä¸åŒäº MP4 å¤æ‚çš„ Atom æ ‘ç»“æ„ï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ä¸€ç§æç®€çš„ã€æµå¼çš„ç´¢å¼•æ ¼å¼ï¼š

```json
{"offset":0,"size":4502,"timestamp":0,"type":"key"}
{"offset":4502,"size":120,"timestamp":33333,"type":"delta"}
{"offset":4622,"size":105,"timestamp":66666,"type":"delta"}
...
```

åœ¨ `opfs-reader-worker.ts` åˆå§‹åŒ–æ—¶ï¼Œæˆ‘ä»¬ä¼šå°†è¿™ä¸ªè½»é‡çº§çš„ç´¢å¼•åŠ è½½è¿›å†…å­˜ã€‚è¿™å°±æ˜¯æˆ‘ä»¬çš„**å¯¼èˆªä»ª**ã€‚

## 4. æ ¸å¿ƒç®—æ³•ï¼šç²¾å‡†å®šä½ä¸‰æ­¥èµ°

å½“ UI çº¿ç¨‹è¯·æ±‚ `centerMs: 5000`ï¼ˆ5ç§’å¤„ï¼‰çš„æ•°æ®æ—¶ï¼ŒWorker å†…éƒ¨å‘ç”Ÿäº†ä¸€åœºç²¾å¯†çš„æ‰‹æœ¯ï¼š

### ç¬¬ä¸€æ­¥ï¼šäºŒåˆ†æŸ¥æ‰¾ (Binary Search)
è§†é¢‘å¹¶éæ€»æ˜¯å®Œç¾çš„ 30fpsã€‚ç½‘ç»œæ³¢åŠ¨ã€CPU è´Ÿè½½éƒ½å¯èƒ½å¯¼è‡´**å¯å˜å¸§ç‡ (VFR)**ã€‚ç¬¬ 150 å¸§æœªå¿…åœ¨ 5.00 ç§’ã€‚

å› æ­¤ï¼Œæˆ‘ä»¬ä¸èƒ½ç”¨ç®€å•çš„æ•°å­¦å…¬å¼è®¡ç®—ä½ç½®ï¼Œå¿…é¡»æŸ¥è¡¨ã€‚æˆ‘ä»¬åœ¨ `indexEntries` æ•°ç»„ä¸Šæ‰§è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼š

```typescript
// opfs-reader-worker.ts
function idxByRelativeTimeMs(relativeMs: number): number {
  // ...äºŒåˆ†æŸ¥æ‰¾é€»è¾‘...
  // æ‰¾åˆ°æ—¶é—´æˆ³ <= ç›®æ ‡æ—¶é—´çš„æœ€åä¸€ä¸ªç´¢å¼•
  while (lo <= hi) {
    const mid = (lo + hi) >> 1;
    // ...
  }
  return foundIndex;
}
```

### ç¬¬äºŒæ­¥ï¼šGOP å›æº¯ (Backtracking)
å‡è®¾äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°äº† 5ç§’å¤„å¯¹åº”çš„ç´¢å¼•æ˜¯ `Frame #150`ã€‚ä½†è¿™é€šå¸¸æ˜¯ä¸€ä¸ª Delta å¸§ã€‚
æ­¤æ—¶ï¼Œ`keyframeBefore` å‡½æ•°ç™»åœºã€‚å®ƒä» `#150` å¼€å§‹å‘å‰æ‰«æï¼Œç›´åˆ°æ‰¾åˆ°æœ€è¿‘çš„ä¸€ä¸ª `type: 'key'`ï¼š

```typescript
// opfs-reader-worker.ts
function keyframeBefore(index: number): number {
  for (let i = index; i >= 0; i--) {
    const ent = indexEntries[i];
    // ä¼˜å…ˆæ£€æŸ¥ isKeyframe æ ‡è®°ï¼Œå…¼å®¹æ€§æ›´å¥½
    if (ent.isKeyframe || ent.type === 'key') {
      return i; // æ‰¾åˆ°äº†ï¼æ¯”å¦‚æ˜¯ Frame #120
    }
  }
  return 0;
}
```

è¿™æ„å‘³ç€ï¼Œè™½ç„¶ç”¨æˆ·åªè¦ `#150`ï¼Œä½†æˆ‘ä»¬å¿…é¡»ä» `#120` å¼€å§‹è¯»å–ã€‚

### ç¬¬ä¸‰æ­¥ï¼šæ‰¹é‡è¯»å–ä¼˜åŒ– (Batch Read Optimization)
è¿™æ˜¯ä»£ç ä¸­æ ‡è®°ä¸º `ğŸš€ P0 ä¼˜åŒ–` çš„å…³é”®éƒ¨åˆ†ã€‚

å¦‚æœæˆ‘ä»¬ä» `#120` åˆ° `#150` å¾ªç¯è°ƒç”¨ 30 æ¬¡ `file.slice()`ï¼Œæµè§ˆå™¨çš„ I/O å¼€é”€ä¼šæå…¶å·¨å¤§ã€‚
æˆ‘ä»¬çš„åšæ³•æ˜¯ï¼š**è®¡ç®—å‡ºçš„æ€»å­—èŠ‚èŒƒå›´ï¼Œä¸€æ¬¡æ€§è¯»å–**ã€‚

```typescript
// opfs-reader-worker.ts
// 1. è®¡ç®—ç‰©ç†åç§»é‡
const startOffset = indexEntries[startIdx].offset;
const endOffset = indexEntries[endIdx].offset + indexEntries[endIdx].size;

// 2. ä¸€æ¬¡æ€§ I/O (One Shot)
const totalSlice = file.slice(startOffset, endOffset);
const totalBuf = await totalSlice.arrayBuffer();

// 3. å†…å­˜åˆ‡å‰²
for (let i = startIdx; i < endIdx; i++) {
   // åœ¨å†…å­˜ä¸­ sliceï¼Œé€Ÿåº¦æå¿«
   const chunkData = totalBuf.slice(relativeOffset, ...);
   chunks.push(chunkData);
}
```

è¿™ç§ä¼˜åŒ–å°† I/O æ¬¡æ•°ä» N æ¬¡é™ä½åˆ°äº† 1 æ¬¡ï¼Œåœ¨ HDD æˆ–ä½é€Ÿ SSD ä¸Šæ€§èƒ½æå‡å°¤ä¸ºæ˜æ˜¾ã€‚

## 5. ä»£ä»·ä¸æŒ‘æˆ˜ï¼šè§£ç å™¨çš„â€œæ—¶é—´é­”æ³•â€

### 5.1 ç²¾å‡†çš„ä»£ä»·
GOP å¯¹é½è™½ç„¶ä¿è¯äº†ç”»é¢ä¸èŠ±ï¼Œä½†ä¹Ÿå¸¦æ¥äº†è®¡ç®—æˆæœ¬ã€‚
**æç«¯æƒ…å†µ**ï¼šå¦‚æœä¸€ä¸ª GOP é•¿è¾¾ 10 ç§’ï¼ˆæ¯”å¦‚å½•åˆ¶é™æ€ç”»é¢æ—¶ï¼‰ï¼Œç”¨æˆ·åªæ˜¯æƒ³çœ‹ç¬¬ 9.9 ç§’çš„ä¸€å¸§ï¼Œæˆ‘ä»¬ä¾ç„¶å¿…é¡»è¯»å–å¹¶è§£ç å‰ 9.9 ç§’çš„æ‰€æœ‰æ•°æ®ã€‚
è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨ä¸‹ä¸€ç¯‡â€œæ¸²æŸ“æµæ°´çº¿â€ä¸­éœ€è¦å¼•å…¥å¤æ‚çš„**å¸§ç¼“å†²ï¼ˆFrame Bufferï¼‰**æœºåˆ¶â€”â€”è§£ç è¿‡çš„å¸§å¿…é¡»ç¼“å­˜èµ·æ¥ï¼Œä¸èƒ½ç”¨å®Œå³å¼ƒã€‚

### 5.2 å¾®ç§’ vs æ¯«ç§’çš„å½’ä¸€åŒ–
- **WebCodecs å†…æ ¸**ï¼šä¸¥æ ¼ä½¿ç”¨ **å¾®ç§’ (Î¼s)** (`timestamp`)ã€‚å½•åˆ¶å‡ºçš„æ—¶é—´æˆ³é€šå¸¸æ˜¯ç›¸å¯¹äºâ€œç³»ç»Ÿå¯åŠ¨æ—¶é—´â€çš„å•è°ƒé€’å¢å€¼ï¼ˆä¾‹å¦‚ `13948200000`ï¼‰ã€‚
- **UI æ˜¾ç¤º**ï¼šä½¿ç”¨ **æ¯«ç§’ (ms)**ï¼Œä¸”å¿…é¡»ä» `00:00` å¼€å§‹ã€‚

åœ¨ `opfs-reader-worker.ts` ä¸­ï¼Œæˆ‘ä»¬åœ¨è¿”å›æ•°æ®å‰æ‰§è¡Œäº†**æ—¶é—´å½’ä¸€åŒ–**ï¼š

```typescript
const relativeMs = (chunk.timestamp - firstTimestamp) / 1000;
```

è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼Œæ— è®ºå½•åˆ¶æ—¶çš„ç³»ç»Ÿæ—¶é—´æ˜¯å¤šå°‘ï¼Œåœ¨ç¼–è¾‘å™¨é‡Œï¼Œç¬¬ä¸€å¸§æ°¸è¿œæ˜¯ `00:00.000`ï¼Œä¿è¯äº†æ—¶é—´è½´æ˜¾ç¤ºçš„æ•´æ´ä¸ä¸€è‡´ã€‚

## 6. æ€»ç»“ä¸æ‚¬å¿µ

é€šè¿‡ **index.jsonl ç´¢å¼•**ã€**äºŒåˆ†æŸ¥æ‰¾**ã€**å…³é”®å¸§å›æº¯** å’Œ **æ‰¹é‡è¯»å–ä¼˜åŒ–**ï¼ŒScreen Recorder Studio å®ç°äº†å¯¹ OPFS æ–‡ä»¶çš„æ¯«ç§’çº§éšæœºè®¿é—®ã€‚

è¿™å¥—æœºåˆ¶ä¿è¯äº†ï¼š
1.  **å¿«**ï¼šI/O æ“ä½œè¢«åˆå¹¶åˆ°æœ€å°‘ã€‚
2.  **å‡†**ï¼šå¤„ç† VFR è§†é¢‘æ—¶ä¸ä¾èµ–çŒœæµ‹ã€‚
3.  **ç¨³**ï¼šä¸¥æ ¼éµå¾ª GOP è§„åˆ™ï¼Œç»ä¸ç»™è§£ç å™¨å–‚â€œåŠæˆªâ€æ•°æ®ã€‚

**ä½†æ˜¯ï¼Œåˆ«é«˜å…´å¾—å¤ªæ—©ã€‚**

ç°åœ¨æˆ‘ä»¬æ‰‹é‡Œæœ‰äº†ä¸€å †ç²¾å‡†çš„ `Uint8Array` æ ¼å¼çš„è§†é¢‘æ•°æ®ã€‚ä½†è¿™å¯¹ç”¨æˆ·æ¥è¯´åªæ˜¯ä¸€å †ä¹±ç ã€‚

å¦‚ä½•å°†è¿™äº›æ¯ç‡¥çš„äºŒè¿›åˆ¶æµï¼Œå˜æˆç”¨æˆ·çœ¼å‰æµç•…çš„ã€å¸¦æœ‰èƒŒæ™¯æ¨¡ç³Šã€åœ†è§’é˜´å½±å’Œç¼©æ”¾åŠ¨æ•ˆçš„ 60fps ç”»é¢ï¼Ÿå¦‚æœæ¯ä¸€å¸§éƒ½å»æ“ä½œ DOMï¼Œæµè§ˆå™¨ä¼šå¡æ­»å—ï¼Ÿ

ä¸‹ä¸€ç¯‡ï¼Œæˆ‘ä»¬å°†è¿›å…¥æœ€ç»ˆç« ï¼Œè§£æ **[Web è§†é¢‘å‰ªè¾‘å¼•æ“ (3)ï¼šç¦»å±æ¸²æŸ“æµæ°´çº¿ä¸å³æ—¶åˆæˆæŠ€æœ¯](./06-editor-rendering-pipeline.md)**ã€‚

---

> **ä¸Šä¸€ç¯‡**ï¼š[Web è§†é¢‘å‰ªè¾‘å¼•æ“ (1)ï¼šå†…å­˜è™šæ‹ŸåŒ–ä¸æ»‘åŠ¨çª—å£æœºåˆ¶](./04-editor-memory-sliding-window.md)
> **ä¸‹ä¸€ç¯‡**ï¼š[Web è§†é¢‘å‰ªè¾‘å¼•æ“ (3)ï¼šç¦»å±æ¸²æŸ“æµæ°´çº¿ä¸å³æ—¶åˆæˆæŠ€æœ¯](./06-editor-rendering-pipeline.md)
