# Web è§†é¢‘å‰ªè¾‘å¼•æ“ (3)ï¼šç¦»å±æ¸²æŸ“æµæ°´çº¿ä¸å³æ—¶åˆæˆæŠ€æœ¯

åœ¨ Web å‰ç«¯å¼€å‘ä¸­ï¼Œå¦‚æœè¯´å¤„ç†å¤§é‡ DOM æ˜¯â€œé‡ä½“åŠ›æ´»â€ï¼Œé‚£ä¹ˆå®æ—¶è§†é¢‘æ¸²æŸ“å°±æ˜¯ä¸€åœºâ€œç²¾ç»†çš„å¤–ç§‘æ‰‹æœ¯â€ã€‚

åœ¨[ä¸Šä¸€ç¯‡æ–‡ç« ](./05-editor-seeking-gop-alignment.md)ä¸­ï¼Œæˆ‘ä»¬è§£å†³äº†æ•°æ®â€œè¯»å¾—å‡†â€çš„é—®é¢˜ã€‚ç°åœ¨çš„æŒ‘æˆ˜æ˜¯ï¼š**å¦‚ä½•æŠŠè¿™äº›æ¯ç‡¥çš„äºŒè¿›åˆ¶æ•°æ®ï¼Œå˜æˆç”¨æˆ·çœ¼å‰æµç•…ã€ç²¾ç¾ã€å¸¦æœ‰ç‰¹æ•ˆçš„ç”»é¢ï¼Ÿ**

æƒ³è±¡ä¸€ä¸‹è¿™æ ·çš„åœºæ™¯ï¼šç”¨æˆ·æ­£åœ¨æ‹–åŠ¨æ—¶é—´è½´ï¼ˆSeekï¼‰ï¼Œç”»é¢ä¸Šä¸ä»…æœ‰ 4K è§†é¢‘ï¼Œè¿˜æœ‰èƒŒæ™¯æ¨¡ç³Šã€åœ†è§’ã€é˜´å½±ï¼Œç”šè‡³æ­£åœ¨åšä¸€ä¸ªç¼©æ”¾ï¼ˆZoomï¼‰åŠ¨ç”»ã€‚å¦‚æœè¿™ä¸€åˆ‡éƒ½åœ¨ä¸»çº¿ç¨‹ï¼ˆMain Threadï¼‰ä¸Šè¿›è¡Œï¼Œç»“æœåªæœ‰ä¸€ä¸ªï¼š**UI å¡é¡¿**ã€‚æŒ‰é’®ç‚¹ä¸åŠ¨ï¼Œæ»šåŠ¨æ‰å¸§ï¼Œç”¨æˆ·ä½“éªŒç¾éš¾ã€‚

ä»Šå¤©ï¼Œæˆ‘ä»¬å°†æ·±å…¥ Screen Recorder Studio çš„è§†è§‰ä¸­æ¢â€”â€”**æ¸²æŸ“æµæ°´çº¿ï¼ˆRendering Pipelineï¼‰**ï¼Œçœ‹çœ‹å®ƒæ˜¯å¦‚ä½•åˆ©ç”¨ `OffscreenCanvas` å’Œ `Worker` å®ç° 60fps ä¸æ»‘é¢„è§ˆçš„ã€‚

> ğŸŒŸ **å…³äºæœ¬é¡¹ç›®**
> Screen Recorder Studio æ˜¯ä¸€ä¸ªåŸºäº Web æŠ€æœ¯çš„å¼€æºè§†é¢‘å½•åˆ¶ä¸ç¼–è¾‘å·¥å…·ã€‚å¦‚æœä½ å¯¹å…¶ä¸­çš„æŠ€æœ¯å®ç°æ„Ÿå…´è¶£ï¼Œæ¬¢è¿è®¿é—®æˆ‘ä»¬çš„ [GitHub](https://github.com/screen-recorder-studio/screen-recorder) æˆ–ç›´æ¥åœ¨ [Chrome å•†åº—](https://chromewebstore.google.com/detail/screen-recorder-studio-fo/bondbeldfibfmdjlcnomlaooklacmfpa) ä½“éªŒã€‚

---

## 1. æ¶æ„å†³ç­–ï¼šé€ƒç¦»ä¸»çº¿ç¨‹

æµè§ˆå™¨çš„ UI çº¿ç¨‹ï¼ˆMain Threadï¼‰éå¸¸å¿™ç¢Œã€‚å®ƒè¦å“åº”ç‚¹å‡»ã€æ»šåŠ¨ï¼Œè¿˜è¦æ‰§è¡Œ JavaScript é€»è¾‘ã€é‡æ’ï¼ˆReflowï¼‰å’Œé‡ç»˜ï¼ˆRepaintï¼‰ã€‚

å¦‚æœåœ¨ä¸»çº¿ç¨‹ä¸Šè§£ç ä¸€å¸§ 4K è§†é¢‘å¹¶å°†å…¶ç»˜åˆ¶åˆ° Canvas ä¸Šï¼Œä»…è¿™ä¸€æ­¥å°±å¯èƒ½æ¶ˆè€— 20ms ä»¥ä¸Šã€‚è¿™æ„å‘³ç€ä½ çš„ FPS ç¬é—´æ‰åˆ° 50 ä»¥ä¸‹ã€‚å¦‚æœå†åŠ ä¸Šæ»¤é•œå’Œåˆæˆï¼Œå¡é¡¿åœ¨æ‰€éš¾å…ã€‚

**æˆ‘ä»¬çš„è§£å†³æ–¹æ¡ˆï¼šå…¨å‘˜ Worker åŒ–ã€‚**

Screen Recorder Studio é‡‡ç”¨äº†å½»åº•çš„**ç¦»å±æ¸²æŸ“**æ¶æ„ï¼š
1.  **è§£ç  (Decode)**ï¼šåœ¨ Worker ä¸­è¿è¡Œ `VideoDecoder`ã€‚
2.  **ç¼“å†² (Buffer)**ï¼šç»´æŠ¤è§£ç åçš„ `VideoFrame` é˜Ÿåˆ—ã€‚
3.  **æ¸²æŸ“ (Render)**ï¼šåœ¨ Worker ä¸­ä½¿ç”¨ `OffscreenCanvas`ã€‚
4.  **ä¸Šå± (Commit)**ï¼šé€šè¿‡ `ImageBitmap` é›¶æ‹·è´ä¼ è¾“å›ä¸»çº¿ç¨‹æ˜¾ç¤ºã€‚

ä¸»çº¿ç¨‹åªåšä¸€ä»¶äº‹ï¼š**å‘å·æ–½ä»¤**ã€‚

## 2. å…³é”®ä¸­é—´ä»¶ï¼šå¸§ç¼“å†²åŒº (Frame Buffer)

åœ¨è¿›å…¥æ¸²æŸ“å¾ªç¯å‰ï¼Œæˆ‘ä»¬éœ€è¦å¡«è¡¥ä¸Šä¸€ç¯‡æ–‡ç« ç•™ä¸‹çš„å‘ï¼š**GOP è§£ç çš„é«˜æˆæœ¬**ã€‚

å¦‚æœç”¨æˆ·æƒ³æ’­æ”¾ 1 ç§’é’Ÿçš„è§†é¢‘ï¼Œè€Œè¿™ 1 ç§’æ°å¥½åœ¨ä¸€ä¸ªé•¿è¾¾ 10 ç§’çš„ GOP å°¾éƒ¨ï¼Œè§£ç å™¨å¿…é¡»å…ˆæ‹¼å‘½â€œåƒæ‰â€å‰ 9 ç§’çš„æ•°æ®ã€‚ä¸ºäº†ä¸è®©æ¸²æŸ“çº¿ç¨‹â€œç­‰ç±³ä¸‹é”…â€ï¼Œæˆ‘ä»¬åœ¨ `composite-worker` ä¸­å®ç°äº†ä¸€ä¸ª**ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å‹**ï¼š

- **ç”Ÿäº§è€…ï¼ˆè§£ç å™¨ï¼‰**ï¼šå…¨é€Ÿè§£ç ï¼Œå°†äº§å‡ºçš„ `VideoFrame` å¯¹è±¡æ¨å…¥ `decodedFrames` é˜Ÿåˆ—ã€‚
- **æ¶ˆè´¹è€…ï¼ˆæ¸²æŸ“å™¨ï¼‰**ï¼šæŒ‰ç…§ 60fps çš„èŠ‚å¥ï¼Œä»é˜Ÿåˆ—å¤´éƒ¨å–å‡ºå¸§è¿›è¡Œç»˜åˆ¶ã€‚

```typescript
// ç®€å•çš„ç¼“å†²ç­–ç•¥ç¤ºæ„
const FRAME_BUFFER_LIMITS = {
  maxDecodedFrames: 150, // çº¦ 5 ç§’çš„ 30fps è§†é¢‘
  lowWatermark: 30       // å‰©ä½™ä¸è¶³ 1 ç§’æ—¶è§¦å‘é¢„å–
};
```

è¿™ä¸ªç¼“å†²åŒºä¸ä»…å¹³æ»‘äº†ç½‘ç»œ/ç£ç›˜ I/O çš„æŠ–åŠ¨ï¼Œè¿˜ä¸ºâ€œæ— ç¼å¾ªç¯æ’­æ”¾â€æä¾›äº†åŸºç¡€â€”â€”å½“æ’­æ”¾æŒ‡é’ˆå³å°†åˆ°è¾¾å½“å‰çª—å£æœ«å°¾æ—¶ï¼Œåå°å·²ç»æ‚„æ‚„å¼€å§‹è§£ç ä¸‹ä¸€ä¸ªçª—å£çš„æ•°æ®å¹¶å¡«å…¥ `nextDecoded` ç¼“å†²äº†ã€‚

## 3. æ¸²æŸ“å¾ªç¯ï¼šWorker é‡Œçš„å¿ƒè·³

åœ¨ `composite-worker/index.ts` ä¸­ï¼Œæˆ‘ä»¬æ²¡æœ‰è¢«åŠ¨ç­‰å¾…æŒ‡ä»¤ï¼Œè€Œæ˜¯å»ºç«‹äº†ä¸€ä¸ªä¸»åŠ¨çš„**æ¸²æŸ“å¾ªç¯ (Render Loop)**ã€‚

```typescript
function playFrame() {
  if (!isPlaying) return;

  const now = performance.now();
  if (now - lastFrameTime >= frameInterval) {
     // 1. ä»ç¼“å†²åŒºè·å–ä¸‹ä¸€å¸§
     const frame = decodedFrames[currentFrameIndex];
     
     // 2. æ‰§è¡Œåˆæˆç®¡çº¿ (Pipeline)
     const bitmap = renderCompositeFrame(frame, ...);
     
     // 3. å‘é€ç»™ä¸»çº¿ç¨‹
     self.postMessage({ type: 'frame', data: { bitmap } }, [bitmap]);
     
     currentFrameIndex++;
  }
  
  // Worker ä¸­ä¹Ÿæœ‰ requestAnimationFrameï¼
  animationId = self.requestAnimationFrame(playFrame);
}
```

è¿™ä¸ªè®¾è®¡ä¿è¯äº†å³ä½¿ä¸»çº¿ç¨‹å¶å°”å› ä¸ºç¹é‡çš„ DOM æ“ä½œå¡é¡¿ï¼ŒWorker é‡Œçš„è§†é¢‘ç”Ÿæˆé€»è¾‘ä¾ç„¶æŒ‰éƒ¨å°±ç­åœ°ä»¥ 60fps è¿è¡Œã€‚

## 4. åˆæˆæµæ°´çº¿ï¼šåƒ Photoshop ä¸€æ ·ç»˜å›¾

`renderCompositeFrame` å‡½æ•°æ˜¯æˆ‘ä»¬çš„æ ¸å¿ƒç”»å¸ˆã€‚å®ƒä¸åƒç®€å•çš„ `<video>` æ ‡ç­¾é‚£æ ·â€œæŠŠè§†é¢‘è´´ä¸Šå»â€ï¼Œè€Œæ˜¯åƒ Photoshop å›¾å±‚ä¸€æ ·ï¼Œä¸€æ­¥æ­¥åˆæˆç”»é¢ã€‚

### ç¬¬ä¸€æ­¥ï¼šèƒŒæ™¯å±‚ (Background Layer)
ç”¨æˆ·å¯èƒ½è®¾ç½®äº†æ¸å˜è‰²ã€çº¯è‰²ï¼Œæˆ–è€…æ˜¯å½“å‰è§†é¢‘å¸§çš„é«˜æ–¯æ¨¡ç³Šç‰ˆæœ¬ä½œä¸ºèƒŒæ™¯ã€‚
```typescript
if (config.type === 'gradient') {
  const gradient = createGradient(ctx, config.gradient);
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, width, height);
}
```

### ç¬¬äºŒæ­¥ï¼šåŠ¨æ€å¸ƒå±€ (Dynamic Layout) â€”â€” Zoom çš„ç§˜å¯†
è¿™æ˜¯æœ€å¤æ‚çš„ä¸€æ­¥ã€‚ç”¨æˆ·å¯èƒ½æ­£åœ¨åšä¸€ä¸ª **Zoomï¼ˆå±€éƒ¨æ”¾å¤§ï¼‰** åŠ¨ä½œã€‚
æˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨ CSS åŠ¨ç”»ï¼Œè€Œæ˜¯å®Œå…¨ç”±**æ—¶é—´é©±åŠ¨**è®¡ç®—å¸ƒå±€ã€‚

1.  **æ—¶é—´æ’å€¼**ï¼šæ ¹æ®å½“å‰å¸§åœ¨å…¨å±€æ—¶é—´è½´ä¸Šçš„é€»è¾‘æ—¶é—´ï¼ˆç”±â€œå…¨å±€å¸§åºå· + å¸§ç‡â€æ¨å¯¼ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨åº•å±‚ç¼–ç æ—¶é—´æˆ³ï¼‰ï¼Œé€šè¿‡ç¼“åŠ¨å‡½æ•°ï¼ˆå¦‚ `easeInOutCubic`ï¼‰è®¡ç®—å‡ºå½“å‰çš„ `zoomScale` å’Œ `focusPoint`ã€‚
2.  **åæ ‡æ˜ å°„**ï¼šè®¡ç®—è§†é¢‘å¸§åœ¨ Canvas ä¸Šçš„ç›®æ ‡çŸ©å½¢ `destX, destY, destW, destH`ã€‚

è¿™ç§åŸºäºæ—¶é—´çš„æ¸²æŸ“ä¿è¯äº† Zoom åŠ¨ç”»ä¸è§†é¢‘å†…å®¹çš„**ç»å¯¹åŒæ­¥**â€”â€”å³ä½¿è§†é¢‘æš‚åœã€æ…¢æ”¾æˆ–å¿«è¿›ï¼ŒZoom åŠ¨ç”»ä¹Ÿä¼šç²¾å‡†åœ°åœç•™åœ¨å¯¹åº”çš„çŠ¶æ€ï¼Œç»ä¸ä¼šâ€œæ»‘æ­¥â€ã€‚

### ç¬¬ä¸‰æ­¥ï¼šè£…é¥°å±‚ (Decoration Layer)
ä¸ºäº†å®ç°åœ†è§’å’Œé˜´å½±ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† **Path Clippingï¼ˆè·¯å¾„è£å‰ªï¼‰** æŠ€æœ¯ï¼š

```typescript
// 1. ç»˜åˆ¶é˜´å½±ï¼ˆåœ¨è§†é¢‘ä¸‹æ–¹ï¼‰
if (config.shadow) {
  ctx.shadowBlur = config.shadow.blur;
  // ...ç»˜åˆ¶ä¸€ä¸ªä¸è§†é¢‘åŒå¤§çš„çŸ©å½¢...
}

// 2. åˆ›å»ºåœ†è§’è·¯å¾„ (ä½¿ç”¨ quadraticCurveTo å®ç°å¹³æ»‘åœ†è§’)
createRoundedRectPath(ctx, layout.x, layout.y, layout.w, layout.h, radius);
ctx.clip(); // å…³é”®ï¼åç»­æ‰€æœ‰ç»˜åˆ¶éƒ½ä¼šè¢«é™åˆ¶åœ¨è¿™ä¸ªåœ†è§’çŸ©å½¢å†…

// 3. ç»˜åˆ¶è§†é¢‘å¸§ (9å‚æ•° drawImage å®ç°ç¼©æ”¾ä¸è£å‰ª)
ctx.drawImage(videoFrame, srcX, srcY, srcW, srcH, destX, destY, destW, destH);
```

## 5. é›¶æ‹·è´ï¼šæ‰“é€šä»»ç£äºŒè„‰

ç°åœ¨ï¼Œæˆ‘ä»¬åœ¨ Worker çš„ `OffscreenCanvas` ä¸Šç”»å¥½äº†ä¸€å¸§ç²¾ç¾çš„ç”»é¢ã€‚æ€ä¹ˆæŠŠå®ƒé€åˆ°ä¸»çº¿ç¨‹çš„å±å¹•ä¸Šï¼Ÿ

å¦‚æœä½¿ç”¨ `postMessage(pixelData)`ï¼Œè¿™æ¶‰åŠåˆ°å·¨å¤§çš„ CPU å†…å­˜æ‹·è´ã€‚å¯¹äº 4K è§†é¢‘ï¼Œè¿™è¶³ä»¥è®©æµè§ˆå™¨å´©æºƒã€‚

æˆ‘ä»¬ä½¿ç”¨äº† **Transferable Objects** æŠ€æœ¯ã€‚

```typescript
// Worker ç«¯
const bitmap = offscreenCanvas.transferToImageBitmap();
self.postMessage({ type: 'frame', data: { bitmap } }, [bitmap]); // [bitmap] è¡¨ç¤ºè½¬ç§»æ‰€æœ‰æƒ

// ä¸»çº¿ç¨‹ç«¯
worker.onmessage = (e) => {
  const { bitmap } = e.data;
  // ä½¿ç”¨ ImageBitmapRenderingContextï¼Œæ•ˆç‡æé«˜
  // Pro Tip: è®¾ç½® alpha: false å¯ä»¥è¿›ä¸€æ­¥ä¼˜åŒ–æ€§èƒ½
  canvasContext.transferFromImageBitmap(bitmap);
}
```

é€šè¿‡ `transferToImageBitmap`ï¼ŒGPU ä¸­çš„çº¹ç†å¼•ç”¨è¢«ç›´æ¥â€œè¿‡æˆ·â€ç»™äº†ä¸»çº¿ç¨‹ã€‚**æ²¡æœ‰åƒç´ è¢«æ‹·è´**ï¼Œåªæœ‰æŒ‡é’ˆåœ¨ç§»åŠ¨ã€‚è¿™ä½¿å¾— 4K 60fps çš„è·¨çº¿ç¨‹ä¼ è¾“å˜å¾—è½»è€Œæ˜“ä¸¾ã€‚

## 6. å…¨å‰§ç»ˆï¼šWeb è§†é¢‘ç¼–è¾‘çš„æœªæ¥

è‡³æ­¤ï¼Œæˆ‘ä»¬çš„ **Screen Recorder Studio æŠ€æœ¯æ­ç§˜ä¸‰éƒ¨æ›²** å°±å‘Šä¸€æ®µè½äº†ã€‚

éœ€è¦ç‰¹åˆ«è¯´æ˜çš„ä¸€ç‚¹æ˜¯ï¼šæ–‡ç« ä¸­ä»‹ç»çš„è¿™æ•´æ¡ç¦»å±åˆæˆæµæ°´çº¿ï¼Œå¹¶ä¸åªæœåŠ¡é¢„è§ˆã€‚MP4 / WebM / GIF å¯¼å‡ºæ—¶ï¼Œå¯¼å‡º Worker ä¼šå¤ç”¨åŒä¸€ä¸ª `video-composite-worker`ï¼ŒæŠŠä¸ä½ åœ¨ Studio ä¸­çœ‹åˆ°å®Œå…¨ç›¸åŒçš„èƒŒæ™¯ã€è£å‰ªã€åœ†è§’ã€é˜´å½±å’Œ Zoom é…ç½®åº”ç”¨åˆ°æ¯ä¸€å¸§ä¸Šï¼Œå†äº¤ç»™ç¼–ç å™¨è¿›è¡Œå†™å‡ºã€‚å› æ­¤ï¼Œåœ¨è§†è§‰ä¸Šå¯ä»¥ç†è§£ä¸º**â€œé¢„è§ˆæ‰€è§ï¼Œå³å¯¼å‡ºæ‰€å¾—â€**ã€‚

å›é¡¾è¿™æ®µæ—…ç¨‹ï¼Œæˆ‘ä»¬å…¶å®ä¸€ç›´åœ¨åšä¸€ä»¶äº‹ï¼š**å°†åŸç”Ÿåº”ç”¨ï¼ˆNative Appï¼‰çš„èƒ½åŠ›æ¬è¿åˆ°æµè§ˆå™¨ä¸­ã€‚**

1.  **å†…å­˜ç¯‡**ï¼šç”¨â€œæ»‘åŠ¨çª—å£â€æ‰“ç ´äº† V8 å¼•æ“å¯¹å¤§æ–‡ä»¶çš„å†…å­˜é™åˆ¶ã€‚
2.  **è¯»å–ç¯‡**ï¼šç”¨â€œGOP ç´¢å¼•â€æ‰“ç ´äº†çº¿æ€§æµå¯¹éšæœºè®¿é—®çš„æ€§èƒ½é™åˆ¶ã€‚
3.  **æ¸²æŸ“ç¯‡**ï¼šç”¨â€œç¦»å±æ¸²æŸ“â€æ‰“ç ´äº† UI çº¿ç¨‹å¯¹é«˜å¸§ç‡åˆæˆçš„æ€§èƒ½é™åˆ¶ã€‚

è¿™ä¸‰å—åŸºçŸ³ï¼Œå…±åŒæ”¯æ’‘èµ·äº† Screen Recorder Studio è¿™æ ·ä¸€ä¸ªçº¯æµè§ˆå™¨ç«¯çš„ä¸“ä¸šçº§è§†é¢‘å·¥å…·ã€‚

æˆ‘ä»¬åšä¿¡ï¼Œéšç€ WebCodecsã€WebGPU å’Œ OPFS çš„æˆç†Ÿï¼Œæµè§ˆå™¨å°†ä¸ä»…ä»…æ˜¯å†…å®¹çš„æ¶ˆè´¹ç«¯ï¼Œæ›´æ˜¯å†…å®¹çš„**ç”Ÿäº§ç«¯**ã€‚å¸Œæœ›è¿™ä¸€ç³»åˆ—æ–‡ç« èƒ½ä¸ºä½ æ¢ç´¢ Web éŸ³è§†é¢‘é¢†åŸŸæä¾›ä¸€äº›å¯å‘ã€‚

---

> **ä¸Šä¸€ç¯‡**ï¼š[Web è§†é¢‘å‰ªè¾‘å¼•æ“ (2)ï¼šåŸºäº OPFS ä¸ GOP çš„å¸§çº§ç²¾å‡†å®šä½](./05-editor-seeking-gop-alignment.md)
