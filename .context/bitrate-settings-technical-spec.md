# ç ç‡è®¾ç½®å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›è§†é¢‘å½•åˆ¶ç ç‡è®¾ç½®åŠŸèƒ½çš„å®Œæ•´æŠ€æœ¯å®ç°æ–¹æ¡ˆï¼ŒåŒ…æ‹¬UIè®¾è®¡ã€æ•°æ®æµã€å­˜å‚¨æ–¹æ¡ˆå’Œä»£ç å®ç°ã€‚

---

## ğŸ¯ åŠŸèƒ½ç›®æ ‡

### ç”¨æˆ·éœ€æ±‚
- **æ™®é€šç”¨æˆ·ï¼ˆ70%ï¼‰**ï¼šä¸€é”®å½•åˆ¶ï¼Œè‡ªåŠ¨é€‰æ‹©æœ€ä½³è´¨é‡
- **è¿›é˜¶ç”¨æˆ·ï¼ˆ20%ï¼‰**ï¼šé€šè¿‡ç®€å•é¢„è®¾æ§åˆ¶è´¨é‡å’Œæ–‡ä»¶å¤§å°
- **ä¸“ä¸šç”¨æˆ·ï¼ˆ10%ï¼‰**ï¼šç²¾ç¡®æ§åˆ¶ç ç‡ã€ç¼–è§£ç å™¨ç­‰å‚æ•°

### æŠ€æœ¯ç›®æ ‡
- æä¾›3ä¸ªè´¨é‡é¢„è®¾ï¼ˆèŠ‚çœç©ºé—´ã€å¹³è¡¡ã€é«˜è´¨é‡ï¼‰
- æ”¯æŒè‡ªå®šä¹‰ç ç‡ï¼ˆ2-25 Mbpsï¼‰
- æ”¯æŒç¼–è§£ç å™¨é€‰æ‹©ï¼ˆH.264ã€VP9ã€VP8ï¼‰
- å®æ—¶æ˜¾ç¤ºé¢„ä¼°æ–‡ä»¶å¤§å°
- æŒä¹…åŒ–ç”¨æˆ·è®¾ç½®

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### ç³»ç»Ÿæ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Popup UI (æ§åˆ¶é¢æ¿)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ è´¨é‡é¢„è®¾    â”‚  â”‚ é«˜çº§é€‰é¡¹     â”‚  â”‚ è®¾ç½®é¡µé¢       â”‚ â”‚
â”‚  â”‚ ä¸‹æ‹‰æ¡†      â”‚  â”‚ (å¯æŠ˜å )     â”‚  â”‚ (ç‹¬ç«‹è·¯ç”±)     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Settings Manager (è®¾ç½®ç®¡ç†å™¨)               â”‚
â”‚  â€¢ åŠ è½½/ä¿å­˜è®¾ç½® (chrome.storage.local)                 â”‚
â”‚  â€¢ è´¨é‡é¢„è®¾æ˜ å°„                                          â”‚
â”‚  â€¢ å‚æ•°éªŒè¯                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Quality Config Generator (é…ç½®ç”Ÿæˆå™¨)          â”‚
â”‚  â€¢ æ ¹æ®é¢„è®¾ç”Ÿæˆç¼–ç é…ç½®                                  â”‚
â”‚  â€¢ è®¡ç®—ç ç‡ (BPPç®—æ³•)                                    â”‚
â”‚  â€¢ é€‰æ‹©ç¼–è§£ç å™¨                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Recording Engine (å½•åˆ¶å¼•æ“)                 â”‚
â”‚  â€¢ Offscreen (Tab/Window/Screen)                        â”‚
â”‚  â€¢ Content Script (Area/Element)                        â”‚
â”‚  â€¢ WebCodecs Worker                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®æµ

```
ç”¨æˆ·é€‰æ‹©è´¨é‡é¢„è®¾
    â†“
ä¿å­˜åˆ° chrome.storage.local
    â†“
å¼€å§‹å½•åˆ¶æ—¶è¯»å–è®¾ç½®
    â†“
ç”Ÿæˆç¼–ç é…ç½® (codec, bitrate, gop, etc.)
    â†“
ä¼ é€’ç»™ WebCodecs Worker
    â†“
åº”ç”¨é…ç½®å¹¶å¼€å§‹ç¼–ç 
```

---

## ğŸ“Š è´¨é‡é¢„è®¾å®šä¹‰

### é¢„è®¾é…ç½®è¡¨

| é¢„è®¾ | BPP | ç¼–è§£ç å™¨ | GOP | ç ç‡æ¨¡å¼ | 1080p@30fps<br>ç ç‡ | 10åˆ†é’Ÿ<br>æ–‡ä»¶å¤§å° |
|------|-----|---------|-----|---------|-------------------|------------------|
| ğŸ’¾ èŠ‚çœç©ºé—´ | 0.06 | VP9ä¼˜å…ˆ | 3ç§’ | VBR | 3.7 Mbps | 225 MB |
| âš–ï¸ å¹³è¡¡ | 0.09 | H.264 | 2ç§’ | VBR | 5.6 Mbps | 375 MB |
| â­ é«˜è´¨é‡ | 0.15 | H.264 | 1ç§’ | VBR | 9.3 Mbps | 600 MB |
| ğŸ”§ è‡ªå®šä¹‰ | ç”¨æˆ·æŒ‡å®š | ç”¨æˆ·é€‰æ‹© | ç”¨æˆ·é€‰æ‹© | ç”¨æˆ·é€‰æ‹© | ç”¨æˆ·æŒ‡å®š | è®¡ç®—æ˜¾ç¤º |

### æŠ€æœ¯å‚æ•°æ˜ å°„

```typescript
// src/lib/utils/quality-presets.ts

export type QualityPreset = 'space-saver' | 'balanced' | 'high-quality' | 'custom'

export interface QualityConfig {
  bpp: number
  codec: 'auto' | 'h264' | 'vp9-first' | 'vp8'
  gopSeconds: number
  bitrateMode: 'constant' | 'variable'
  hardwareAcceleration: 'prefer-hardware' | 'prefer-software' | 'no-preference'
  latencyMode: 'realtime' | 'quality'
}

export const QUALITY_PRESETS: Record<QualityPreset, QualityConfig> = {
  'space-saver': {
    bpp: 0.06,
    codec: 'vp9-first',
    gopSeconds: 3,
    bitrateMode: 'variable',
    hardwareAcceleration: 'prefer-hardware',
    latencyMode: 'quality'
  },
  
  'balanced': {
    bpp: 0.09,
    codec: 'auto',
    gopSeconds: 2,
    bitrateMode: 'variable',
    hardwareAcceleration: 'prefer-hardware',
    latencyMode: 'realtime'
  },
  
  'high-quality': {
    bpp: 0.15,
    codec: 'auto',
    gopSeconds: 1,
    bitrateMode: 'variable',
    hardwareAcceleration: 'no-preference',
    latencyMode: 'quality'
  },
  
  'custom': {
    bpp: 0.09,  // é»˜è®¤å€¼ï¼Œä¼šè¢«ç”¨æˆ·è®¾ç½®è¦†ç›–
    codec: 'auto',
    gopSeconds: 2,
    bitrateMode: 'variable',
    hardwareAcceleration: 'prefer-hardware',
    latencyMode: 'realtime'
  }
}
```

---

## ğŸ’¾ æ•°æ®å­˜å‚¨æ–¹æ¡ˆ

### å­˜å‚¨ç»“æ„

```typescript
// chrome.storage.local å­˜å‚¨ç»“æ„

interface StoredSettings {
  settings: {
    // å€’è®¡æ—¶è®¾ç½®ï¼ˆå·²æœ‰ï¼‰
    countdownSeconds?: number
    
    // è´¨é‡è®¾ç½®ï¼ˆæ–°å¢ï¼‰
    qualityPreset: QualityPreset
    
    // è‡ªå®šä¹‰è®¾ç½®ï¼ˆå½“ qualityPreset === 'custom' æ—¶ä½¿ç”¨ï¼‰
    customSettings?: {
      bitrate?: number          // Mbps (2-25)
      codec?: 'auto' | 'h264' | 'vp9' | 'vp8'
      gopSeconds?: number       // 0.5-10
      bitrateMode?: 'constant' | 'variable'
      hardwareAcceleration?: 'prefer-hardware' | 'prefer-software' | 'no-preference'
      latencyMode?: 'realtime' | 'quality'
    }
  }
}

// é»˜è®¤å€¼
const DEFAULT_SETTINGS: StoredSettings = {
  settings: {
    countdownSeconds: 3,
    qualityPreset: 'balanced',
    customSettings: {
      bitrate: 8,
      codec: 'auto',
      gopSeconds: 2,
      bitrateMode: 'variable',
      hardwareAcceleration: 'prefer-hardware',
      latencyMode: 'realtime'
    }
  }
}
```

### å­˜å‚¨æ“ä½œ

```typescript
// src/lib/utils/settings-manager.ts

export class SettingsManager {
  private static STORAGE_KEY = 'settings'
  
  // åŠ è½½è®¾ç½®
  static async load(): Promise<StoredSettings['settings']> {
    try {
      const result = await chrome.storage.local.get([this.STORAGE_KEY])
      return result[this.STORAGE_KEY] || DEFAULT_SETTINGS.settings
    } catch (error) {
      console.error('Failed to load settings:', error)
      return DEFAULT_SETTINGS.settings
    }
  }
  
  // ä¿å­˜è®¾ç½®
  static async save(settings: Partial<StoredSettings['settings']>): Promise<void> {
    try {
      const current = await this.load()
      const updated = { ...current, ...settings }
      await chrome.storage.local.set({ [this.STORAGE_KEY]: updated })
    } catch (error) {
      console.error('Failed to save settings:', error)
      throw error
    }
  }
  
  // ä¿å­˜è´¨é‡é¢„è®¾
  static async saveQualityPreset(preset: QualityPreset): Promise<void> {
    await this.save({ qualityPreset: preset })
  }
  
  // ä¿å­˜è‡ªå®šä¹‰è®¾ç½®
  static async saveCustomSettings(custom: StoredSettings['settings']['customSettings']): Promise<void> {
    await this.save({ customSettings: custom })
  }
  
  // é‡ç½®ä¸ºé»˜è®¤
  static async reset(): Promise<void> {
    await chrome.storage.local.set({ [this.STORAGE_KEY]: DEFAULT_SETTINGS.settings })
  }
}
```

---

## ğŸ¨ UIå®ç°æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šPopupå†…åµŒï¼ˆç®€åŒ–ç‰ˆï¼‰

**ä½ç½®**ï¼š`src/routes/popup/+page.svelte`

**å¸ƒå±€**ï¼šåœ¨å€’è®¡æ—¶è®¾ç½®ä¸‹æ–¹æ·»åŠ è´¨é‡é€‰æ‹©

```svelte
<script lang="ts">
  import { onMount } from 'svelte'
  import { Sparkles, Info, Settings as SettingsIcon } from 'lucide-svelte'
  import { SettingsManager } from '$lib/utils/settings-manager'
  import type { QualityPreset } from '$lib/utils/quality-presets'
  
  let qualityPreset: QualityPreset = 'balanced'
  let showAdvanced = false
  
  // è‡ªå®šä¹‰è®¾ç½®
  let customBitrate = 8
  let customCodec: 'auto' | 'h264' | 'vp9' | 'vp8' = 'auto'
  
  // åŠ è½½è®¾ç½®
  onMount(async () => {
    const settings = await SettingsManager.load()
    qualityPreset = settings.qualityPreset || 'balanced'
    
    if (settings.customSettings) {
      customBitrate = settings.customSettings.bitrate || 8
      customCodec = settings.customSettings.codec || 'auto'
    }
  })
  
  // ä¿å­˜è´¨é‡é¢„è®¾
  async function handleQualityChange() {
    await SettingsManager.saveQualityPreset(qualityPreset)
    if (qualityPreset === 'custom') {
      showAdvanced = true
    }
  }
  
  // ä¿å­˜è‡ªå®šä¹‰è®¾ç½®
  async function handleCustomChange() {
    await SettingsManager.saveCustomSettings({
      bitrate: customBitrate,
      codec: customCodec
    })
  }
  
  // é¢„ä¼°æ–‡ä»¶å¤§å°
  function estimateFileSize(preset: QualityPreset): string {
    const sizes = {
      'space-saver': '225 MB',
      'balanced': '375 MB',
      'high-quality': '600 MB',
      'custom': `${Math.round(customBitrate * 60 * 10 / 8)} MB`
    }
    return sizes[preset] || '375 MB'
  }
  
  // è·å–æè¿°
  function getDescription(preset: QualityPreset): string {
    const descriptions = {
      'space-saver': 'æ–‡ä»¶æ›´å°ï¼Œé€‚åˆé•¿æ—¶é—´å½•åˆ¶',
      'balanced': 'æ¨èè®¾ç½®ï¼Œè´¨é‡å’Œå¤§å°å¹³è¡¡',
      'high-quality': 'æœ€ä½³è´¨é‡ï¼Œé€‚åˆæ–‡å­—å¯†é›†å†…å®¹',
      'custom': 'è‡ªå®šä¹‰å‚æ•°ï¼Œæ»¡è¶³ç‰¹æ®Šéœ€æ±‚'
    }
    return descriptions[preset] || ''
  }
</script>

<!-- è´¨é‡è®¾ç½® -->
<div class="flex flex-col gap-2 mt-3 p-3 bg-white border border-gray-200 rounded-lg">
  <div class="flex items-center gap-2">
    <Sparkles class="w-4 h-4 text-purple-500" />
    <label class="text-sm font-medium text-gray-700">å½•åˆ¶è´¨é‡</label>
  </div>
  
  <select 
    bind:value={qualityPreset}
    on:change={handleQualityChange}
    class="w-full text-sm border border-gray-300 rounded-md px-3 py-2 focus:ring-2 focus:ring-purple-500 focus:border-transparent"
  >
    <option value="space-saver">ğŸ’¾ èŠ‚çœç©ºé—´</option>
    <option value="balanced">âš–ï¸ å¹³è¡¡ï¼ˆæ¨èï¼‰</option>
    <option value="high-quality">â­ é«˜è´¨é‡</option>
    <option value="custom">ğŸ”§ è‡ªå®šä¹‰...</option>
  </select>
  
  <!-- æç¤ºä¿¡æ¯ -->
  <div class="flex items-start gap-2 text-xs text-gray-600 bg-gray-50 p-2 rounded">
    <Info class="w-3 h-3 mt-0.5 flex-shrink-0" />
    <div class="flex-1">
      <div>{getDescription(qualityPreset)}</div>
      <div class="text-gray-500 mt-1">
        é¢„è®¡ 10åˆ†é’Ÿ â‰ˆ {estimateFileSize(qualityPreset)} (1080p@30fps)
      </div>
    </div>
  </div>
  
  <!-- é«˜çº§é€‰é¡¹ï¼ˆè‡ªå®šä¹‰æ—¶æ˜¾ç¤ºï¼‰ -->
  {#if qualityPreset === 'custom'}
  <div class="mt-2 pt-2 border-t border-gray-200 space-y-3">
    <!-- ç ç‡æ»‘å— -->
    <div>
      <label class="text-xs font-medium text-gray-600 flex items-center justify-between">
        <span>ç ç‡</span>
        <span class="text-purple-600">{customBitrate} Mbps</span>
      </label>
      <input 
        type="range" 
        min="2" 
        max="25" 
        step="1"
        bind:value={customBitrate}
        on:change={handleCustomChange}
        class="w-full mt-1"
      />
      <div class="flex justify-between text-xs text-gray-500 mt-1">
        <span>2 Mbps</span>
        <span>25 Mbps</span>
      </div>
    </div>
    
    <!-- ç¼–è§£ç å™¨ -->
    <div>
      <label class="text-xs font-medium text-gray-600">ç¼–è§£ç å™¨</label>
      <select 
        bind:value={customCodec}
        on:change={handleCustomChange}
        class="w-full text-xs mt-1 border border-gray-300 rounded px-2 py-1"
      >
        <option value="auto">è‡ªåŠ¨é€‰æ‹©ï¼ˆæ¨èï¼‰</option>
        <option value="h264">H.264ï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰</option>
        <option value="vp9">VP9ï¼ˆæ–‡ä»¶æ›´å°ï¼‰</option>
        <option value="vp8">VP8ï¼ˆå…¼å®¹æ€§å¥½ï¼‰</option>
      </select>
    </div>
  </div>
  {/if}
</div>
```

### æ–¹æ¡ˆ2ï¼šç‹¬ç«‹è®¾ç½®é¡µé¢ï¼ˆå®Œæ•´ç‰ˆï¼‰

**æ–°å¢è·¯ç”±**ï¼š`src/routes/settings/+page.svelte`

**å¯¼èˆª**ï¼šåœ¨popupä¸­æ·»åŠ è®¾ç½®æŒ‰é’®

```svelte
<!-- src/routes/popup/+page.svelte -->

<script lang="ts">
  function openSettings() {
    chrome.tabs.create({ url: chrome.runtime.getURL('settings.html') })
  }
</script>

<!-- åœ¨popupé¡¶éƒ¨æ·»åŠ è®¾ç½®æŒ‰é’® -->
<div class="flex items-center justify-between p-3 border-b">
  <h1 class="text-lg font-semibold">Video Recorder</h1>
  <button 
    on:click={openSettings}
    class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
    title="è®¾ç½®"
  >
    <SettingsIcon class="w-5 h-5 text-gray-600" />
  </button>
</div>
```

**è®¾ç½®é¡µé¢å®Œæ•´å®ç°**ï¼š

```svelte
<!-- src/routes/settings/+page.svelte -->

<script lang="ts">
  import { onMount } from 'svelte'
  import { 
    ArrowLeft, Save, RotateCcw, Info, 
    Video, Sliders, Cpu, Zap 
  } from 'lucide-svelte'
  import { SettingsManager } from '$lib/utils/settings-manager'
  import type { QualityPreset } from '$lib/utils/quality-presets'
  
  // çŠ¶æ€
  let qualityPreset: QualityPreset = 'balanced'
  let customBitrate = 8
  let customCodec: 'auto' | 'h264' | 'vp9' | 'vp8' = 'auto'
  let customGopSeconds = 2
  let customBitrateMode: 'constant' | 'variable' = 'variable'
  let customHardwareAccel: 'prefer-hardware' | 'prefer-software' | 'no-preference' = 'prefer-hardware'
  let customLatencyMode: 'realtime' | 'quality' = 'realtime'
  
  let saveStatus: 'idle' | 'saving' | 'saved' | 'error' = 'idle'
  
  // åŠ è½½è®¾ç½®
  onMount(async () => {
    const settings = await SettingsManager.load()
    qualityPreset = settings.qualityPreset || 'balanced'
    
    if (settings.customSettings) {
      customBitrate = settings.customSettings.bitrate || 8
      customCodec = settings.customSettings.codec || 'auto'
      customGopSeconds = settings.customSettings.gopSeconds || 2
      customBitrateMode = settings.customSettings.bitrateMode || 'variable'
      customHardwareAccel = settings.customSettings.hardwareAcceleration || 'prefer-hardware'
      customLatencyMode = settings.customSettings.latencyMode || 'realtime'
    }
  })
  
  // ä¿å­˜è®¾ç½®
  async function saveSettings() {
    saveStatus = 'saving'
    try {
      await SettingsManager.saveQualityPreset(qualityPreset)
      
      if (qualityPreset === 'custom') {
        await SettingsManager.saveCustomSettings({
          bitrate: customBitrate,
          codec: customCodec,
          gopSeconds: customGopSeconds,
          bitrateMode: customBitrateMode,
          hardwareAcceleration: customHardwareAccel,
          latencyMode: customLatencyMode
        })
      }
      
      saveStatus = 'saved'
      setTimeout(() => { saveStatus = 'idle' }, 2000)
    } catch (error) {
      console.error('Failed to save settings:', error)
      saveStatus = 'error'
      setTimeout(() => { saveStatus = 'idle' }, 2000)
    }
  }
  
  // é‡ç½®ä¸ºé»˜è®¤
  async function resetToDefaults() {
    if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰è®¾ç½®ä¸ºé»˜è®¤å€¼å—ï¼Ÿ')) {
      await SettingsManager.reset()
      location.reload()
    }
  }
  
  // è¿”å›
  function goBack() {
    window.close()
  }
  
  // é¢„ä¼°æ–‡ä»¶å¤§å°
  function estimateFileSize(): string {
    const bitrate = qualityPreset === 'custom' ? customBitrate : 
                    qualityPreset === 'space-saver' ? 3 :
                    qualityPreset === 'high-quality' ? 8 : 5
    return `${Math.round(bitrate * 60 * 10 / 8)} MB`
  }
</script>

<div class="min-h-screen bg-gray-50">
  <!-- å¤´éƒ¨ -->
  <header class="bg-white border-b sticky top-0 z-10">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <button 
          on:click={goBack}
          class="p-2 hover:bg-gray-100 rounded-lg transition-colors"
        >
          <ArrowLeft class="w-5 h-5" />
        </button>
        <h1 class="text-xl font-semibold">å½•åˆ¶è®¾ç½®</h1>
      </div>
      
      <div class="flex items-center gap-2">
        <button
          on:click={resetToDefaults}
          class="px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2"
        >
          <RotateCcw class="w-4 h-4" />
          é‡ç½®
        </button>
        
        <button
          on:click={saveSettings}
          disabled={saveStatus === 'saving'}
          class="px-4 py-2 text-sm bg-purple-600 text-white hover:bg-purple-700 rounded-lg transition-colors flex items-center gap-2 disabled:opacity-50"
        >
          <Save class="w-4 h-4" />
          {saveStatus === 'saving' ? 'ä¿å­˜ä¸­...' : 
           saveStatus === 'saved' ? 'å·²ä¿å­˜' : 
           saveStatus === 'error' ? 'ä¿å­˜å¤±è´¥' : 'ä¿å­˜'}
        </button>
      </div>
    </div>
  </header>
  
  <!-- ä¸»å†…å®¹ -->
  <main class="max-w-4xl mx-auto px-4 py-8">
    <!-- è´¨é‡é¢„è®¾ -->
    <section class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <Video class="w-5 h-5 text-purple-600" />
        <h2 class="text-lg font-semibold">è§†é¢‘è´¨é‡</h2>
      </div>
      
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <label class="relative cursor-pointer">
          <input 
            type="radio" 
            bind:group={qualityPreset} 
            value="space-saver"
            class="peer sr-only"
          />
          <div class="border-2 border-gray-200 peer-checked:border-purple-600 peer-checked:bg-purple-50 rounded-lg p-4 transition-all">
            <div class="text-2xl mb-2">ğŸ’¾</div>
            <div class="font-medium mb-1">èŠ‚çœç©ºé—´</div>
            <div class="text-sm text-gray-600">æ–‡ä»¶æ›´å°ï¼Œé€‚åˆé•¿æ—¶é—´å½•åˆ¶</div>
            <div class="text-xs text-gray-500 mt-2">~225 MB / 10åˆ†é’Ÿ</div>
          </div>
        </label>
        
        <label class="relative cursor-pointer">
          <input 
            type="radio" 
            bind:group={qualityPreset} 
            value="balanced"
            class="peer sr-only"
          />
          <div class="border-2 border-gray-200 peer-checked:border-purple-600 peer-checked:bg-purple-50 rounded-lg p-4 transition-all">
            <div class="text-2xl mb-2">âš–ï¸</div>
            <div class="font-medium mb-1">å¹³è¡¡ï¼ˆæ¨èï¼‰</div>
            <div class="text-sm text-gray-600">è´¨é‡å’Œå¤§å°å¹³è¡¡</div>
            <div class="text-xs text-gray-500 mt-2">~375 MB / 10åˆ†é’Ÿ</div>
          </div>
        </label>
        
        <label class="relative cursor-pointer">
          <input 
            type="radio" 
            bind:group={qualityPreset} 
            value="high-quality"
            class="peer sr-only"
          />
          <div class="border-2 border-gray-200 peer-checked:border-purple-600 peer-checked:bg-purple-50 rounded-lg p-4 transition-all">
            <div class="text-2xl mb-2">â­</div>
            <div class="font-medium mb-1">é«˜è´¨é‡</div>
            <div class="text-sm text-gray-600">æœ€ä½³è´¨é‡ï¼Œæ–‡ä»¶è¾ƒå¤§</div>
            <div class="text-xs text-gray-500 mt-2">~600 MB / 10åˆ†é’Ÿ</div>
          </div>
        </label>
      </div>
      
      <label class="relative cursor-pointer block mt-4">
        <input 
          type="radio" 
          bind:group={qualityPreset} 
          value="custom"
          class="peer sr-only"
        />
        <div class="border-2 border-gray-200 peer-checked:border-purple-600 peer-checked:bg-purple-50 rounded-lg p-4 transition-all">
          <div class="flex items-center gap-2">
            <div class="text-2xl">ğŸ”§</div>
            <div>
              <div class="font-medium">è‡ªå®šä¹‰</div>
              <div class="text-sm text-gray-600">æ‰‹åŠ¨é…ç½®æ‰€æœ‰å‚æ•°</div>
            </div>
          </div>
        </div>
      </label>
    </section>
    
    <!-- è‡ªå®šä¹‰è®¾ç½®ï¼ˆä»…åœ¨é€‰æ‹©è‡ªå®šä¹‰æ—¶æ˜¾ç¤ºï¼‰ -->
    {#if qualityPreset === 'custom'}
    <section class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <Sliders class="w-5 h-5 text-purple-600" />
        <h2 class="text-lg font-semibold">è‡ªå®šä¹‰å‚æ•°</h2>
      </div>
      
      <div class="space-y-6">
        <!-- ç ç‡ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            ç ç‡
            <span class="text-purple-600 font-semibold ml-2">{customBitrate} Mbps</span>
          </label>
          <input 
            type="range" 
            min="2" 
            max="25" 
            step="0.5"
            bind:value={customBitrate}
            class="w-full"
          />
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>2 Mbps (ä½)</span>
            <span>25 Mbps (é«˜)</span>
          </div>
          <div class="mt-2 p-3 bg-blue-50 rounded-lg text-sm text-gray-700">
            <Info class="w-4 h-4 inline mr-1" />
            é¢„è®¡æ–‡ä»¶å¤§å°ï¼š{estimateFileSize()} / 10åˆ†é’Ÿ (1080p@30fps)
          </div>
        </div>
        
        <!-- ç¼–è§£ç å™¨ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç¼–è§£ç å™¨</label>
          <select 
            bind:value={customCodec}
            class="w-full border border-gray-300 rounded-lg px-3 py-2"
          >
            <option value="auto">è‡ªåŠ¨é€‰æ‹©ï¼ˆæ¨èï¼‰</option>
            <option value="h264">H.264ï¼ˆå…¼å®¹æ€§æœ€å¥½ï¼‰</option>
            <option value="vp9">VP9ï¼ˆæ–‡ä»¶æ›´å°ï¼‰</option>
            <option value="vp8">VP8ï¼ˆå…¼å®¹æ€§å¥½ï¼‰</option>
          </select>
        </div>
        
        <!-- GOPé—´éš” -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">
            å…³é”®å¸§é—´éš”
            <span class="text-purple-600 font-semibold ml-2">{customGopSeconds} ç§’</span>
          </label>
          <input 
            type="range" 
            min="0.5" 
            max="10" 
            step="0.5"
            bind:value={customGopSeconds}
            class="w-full"
          />
          <div class="flex justify-between text-xs text-gray-500 mt-1">
            <span>0.5ç§’ (é¢‘ç¹)</span>
            <span>10ç§’ (ç¨€ç–)</span>
          </div>
          <div class="mt-2 text-xs text-gray-600">
            æ›´çŸ­çš„é—´éš”å¯ä»¥æ›´ç²¾ç¡®å®šä½ï¼Œä½†æ–‡ä»¶æ›´å¤§
          </div>
        </div>
        
        <!-- ç ç‡æ¨¡å¼ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç ç‡æ¨¡å¼</label>
          <div class="grid grid-cols-2 gap-3">
            <label class="cursor-pointer">
              <input 
                type="radio" 
                bind:group={customBitrateMode} 
                value="variable"
                class="peer sr-only"
              />
              <div class="border-2 border-gray-200 peer-checked:border-purple-600 peer-checked:bg-purple-50 rounded-lg p-3 transition-all">
                <div class="font-medium text-sm">å¯å˜ç ç‡ (VBR)</div>
                <div class="text-xs text-gray-600 mt-1">è´¨é‡æ›´ç¨³å®šï¼Œæ–‡ä»¶æ›´å°</div>
              </div>
            </label>
            
            <label class="cursor-pointer">
              <input 
                type="radio" 
                bind:group={customBitrateMode} 
                value="constant"
                class="peer sr-only"
              />
              <div class="border-2 border-gray-200 peer-checked:border-purple-600 peer-checked:bg-purple-50 rounded-lg p-3 transition-all">
                <div class="font-medium text-sm">æ’å®šç ç‡ (CBR)</div>
                <div class="text-xs text-gray-600 mt-1">æ–‡ä»¶å¤§å°å¯é¢„æµ‹</div>
              </div>
            </label>
          </div>
        </div>
      </div>
    </section>
    
    <!-- ç¼–ç å™¨è®¾ç½® -->
    <section class="bg-white rounded-lg shadow-sm p-6 mb-6">
      <div class="flex items-center gap-2 mb-4">
        <Cpu class="w-5 h-5 text-purple-600" />
        <h2 class="text-lg font-semibold">ç¼–ç å™¨</h2>
      </div>
      
      <div class="space-y-4">
        <!-- ç¡¬ä»¶åŠ é€Ÿ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">ç¡¬ä»¶åŠ é€Ÿ</label>
          <select 
            bind:value={customHardwareAccel}
            class="w-full border border-gray-300 rounded-lg px-3 py-2"
          >
            <option value="prefer-hardware">ä¼˜å…ˆç¡¬ä»¶ï¼ˆæ¨èï¼‰</option>
            <option value="prefer-software">ä¼˜å…ˆè½¯ä»¶</option>
            <option value="no-preference">æ— åå¥½</option>
          </select>
          <div class="mt-2 text-xs text-gray-600">
            ç¡¬ä»¶åŠ é€Ÿæ›´å¿«ä½†è´¨é‡å¯èƒ½ç•¥ä½
          </div>
        </div>
        
        <!-- å»¶è¿Ÿæ¨¡å¼ -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">å»¶è¿Ÿæ¨¡å¼</label>
          <select 
            bind:value={customLatencyMode}
            class="w-full border border-gray-300 rounded-lg px-3 py-2"
          >
            <option value="realtime">å®æ—¶ï¼ˆä½å»¶è¿Ÿï¼‰</option>
            <option value="quality">è´¨é‡ï¼ˆé«˜å»¶è¿Ÿï¼‰</option>
          </select>
        </div>
      </div>
    </section>
    {/if}
  </main>
</div>

<style>
  /* è‡ªå®šä¹‰æ»‘å—æ ·å¼ */
  input[type="range"] {
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    border-radius: 3px;
    background: #e5e7eb;
    outline: none;
  }
  
  input[type="range"]::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #9333ea;
    cursor: pointer;
  }
  
  input[type="range"]::-moz-range-thumb {
    width: 18px;
    height: 18px;
    border-radius: 50%;
    background: #9333ea;
    cursor: pointer;
    border: none;
  }
</style>
```

---

## ğŸ”§ é…ç½®ç”Ÿæˆå™¨å®ç°

```typescript
// src/lib/utils/quality-config-generator.ts

import { QUALITY_PRESETS, type QualityPreset, type QualityConfig } from './quality-presets'
import { computeBitrate } from './webcodecs-config'

export interface EncodingConfig {
  codec: string
  width: number
  height: number
  framerate: number
  bitrate: number
  bitrateMode: 'constant' | 'variable'
  hardwareAcceleration: 'prefer-hardware' | 'prefer-software' | 'no-preference'
  latencyMode: 'realtime' | 'quality'
  gopFrames: number
}

export class QualityConfigGenerator {
  /**
   * æ ¹æ®è´¨é‡é¢„è®¾ç”Ÿæˆç¼–ç é…ç½®
   */
  static generate(
    preset: QualityPreset,
    width: number,
    height: number,
    framerate: number,
    customSettings?: Partial<QualityConfig>
  ): EncodingConfig {
    // è·å–é¢„è®¾é…ç½®
    const config = preset === 'custom' && customSettings
      ? { ...QUALITY_PRESETS.custom, ...customSettings }
      : QUALITY_PRESETS[preset]
    
    // è®¡ç®—ç ç‡
    const bitrate = customSettings?.bpp
      ? Math.floor(width * height * framerate * customSettings.bpp)
      : Math.floor(width * height * framerate * config.bpp)
    
    // é™åˆ¶ç ç‡èŒƒå›´
    const clampedBitrate = Math.max(2_000_000, Math.min(bitrate, 25_000_000))
    
    // è®¡ç®—GOPå¸§æ•°
    const gopFrames = Math.max(framerate, Math.round(framerate * config.gopSeconds))
    
    return {
      codec: config.codec,
      width,
      height,
      framerate,
      bitrate: clampedBitrate,
      bitrateMode: config.bitrateMode,
      hardwareAcceleration: config.hardwareAcceleration,
      latencyMode: config.latencyMode,
      gopFrames
    }
  }
  
  /**
   * é¢„ä¼°æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰
   */
  static estimateFileSize(
    bitrate: number,
    durationSeconds: number
  ): number {
    return Math.floor(bitrate * durationSeconds / 8)
  }
  
  /**
   * æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
   */
  static formatFileSize(bytes: number): string {
    if (bytes < 1024 * 1024) {
      return `${Math.round(bytes / 1024)} KB`
    } else if (bytes < 1024 * 1024 * 1024) {
      return `${(bytes / 1024 / 1024).toFixed(1)} MB`
    } else {
      return `${(bytes / 1024 / 1024 / 1024).toFixed(2)} GB`
    }
  }
}
```

---

## ğŸ”„ é›†æˆåˆ°å½•åˆ¶æµç¨‹

### Offscreenå½•åˆ¶é›†æˆ

```typescript
// src/extensions/offscreen-main.ts

import { SettingsManager } from '../lib/utils/settings-manager'
import { QualityConfigGenerator } from '../lib/utils/quality-config-generator'

async function startRecording(options) {
  // ... ç°æœ‰ä»£ç 
  
  // è·å–è´¨é‡è®¾ç½®
  const settings = await SettingsManager.load()
  const qualityPreset = settings.qualityPreset || 'balanced'
  
  // ç”Ÿæˆç¼–ç é…ç½®
  const encodingConfig = QualityConfigGenerator.generate(
    qualityPreset,
    width,
    height,
    framerate,
    settings.customSettings
  )
  
  // é…ç½®WebCodecs Worker
  wcWorker.postMessage({
    type: 'configure',
    config: {
      width: encodingConfig.width,
      height: encodingConfig.height,
      framerate: encodingConfig.framerate,
      bitrate: encodingConfig.bitrate,
      codec: encodingConfig.codec,
      bitrateMode: encodingConfig.bitrateMode,
      hardwareAcceleration: encodingConfig.hardwareAcceleration,
      latencyMode: encodingConfig.latencyMode
    }
  })
  
  // ä½¿ç”¨GOPé…ç½®
  const keyEvery = encodingConfig.gopFrames
  
  // ... å…¶ä½™ä»£ç 
}
```

### Content Scriptå½•åˆ¶é›†æˆ

```typescript
// src/extensions/content.ts

import { SettingsManager } from '../lib/utils/settings-manager'
import { QualityConfigGenerator } from '../lib/utils/quality-config-generator'

async function startCapture() {
  // ... ç°æœ‰ä»£ç 
  
  // è·å–è´¨é‡è®¾ç½®
  const settings = await SettingsManager.load()
  const qualityPreset = settings.qualityPreset || 'balanced'
  
  // ç”Ÿæˆç¼–ç é…ç½®
  const encodingConfig = QualityConfigGenerator.generate(
    qualityPreset,
    width,
    height,
    framerate,
    settings.customSettings
  )
  
  // é…ç½®Encoder Worker
  state.worker.postMessage({
    type: 'configure',
    codec: encodingConfig.codec,
    width: encodingConfig.width,
    height: encodingConfig.height,
    framerate: encodingConfig.framerate,
    bitrate: encodingConfig.bitrate
  })
  
  // ä½¿ç”¨GOPé…ç½®
  const keyEvery = encodingConfig.gopFrames
  
  // ... å…¶ä½™ä»£ç 
}
```

---

## ğŸ“ å®æ–½æ¸…å•

### é˜¶æ®µ1ï¼šåŸºç¡€åŠŸèƒ½ï¼ˆ3.5å°æ—¶ï¼‰

- [ ] åˆ›å»º `src/lib/utils/quality-presets.ts`
- [ ] åˆ›å»º `src/lib/utils/settings-manager.ts`
- [ ] åˆ›å»º `src/lib/utils/quality-config-generator.ts`
- [ ] ä¿®æ”¹ `src/routes/popup/+page.svelte` æ·»åŠ è´¨é‡é€‰æ‹©
- [ ] ä¿®æ”¹ `src/extensions/offscreen-main.ts` é›†æˆè´¨é‡è®¾ç½®
- [ ] ä¿®æ”¹ `src/extensions/content.ts` é›†æˆè´¨é‡è®¾ç½®
- [ ] æµ‹è¯•3ä¸ªé¢„è®¾çš„å½•åˆ¶æ•ˆæœ

### é˜¶æ®µ2ï¼šç‹¬ç«‹è®¾ç½®é¡µé¢ï¼ˆ8å°æ—¶ï¼‰

- [ ] åˆ›å»º `src/routes/settings/+page.svelte`
- [ ] æ·»åŠ è®¾ç½®é¡µé¢è·¯ç”±é…ç½®
- [ ] åœ¨popupæ·»åŠ è®¾ç½®æŒ‰é’®
- [ ] å®ç°å®Œæ•´çš„è‡ªå®šä¹‰å‚æ•°UI
- [ ] å®ç°ä¿å­˜/é‡ç½®åŠŸèƒ½
- [ ] æµ‹è¯•æ‰€æœ‰è‡ªå®šä¹‰å‚æ•°

### é˜¶æ®µ3ï¼šä¼˜åŒ–å’Œæµ‹è¯•ï¼ˆ4å°æ—¶ï¼‰

- [ ] æ·»åŠ æ–‡ä»¶å¤§å°å®æ—¶é¢„ä¼°
- [ ] æ·»åŠ å‚æ•°éªŒè¯å’Œé”™è¯¯æç¤º
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆä¸åŒé¢„è®¾çš„å®é™…æ•ˆæœï¼‰
- [ ] ç”¨æˆ·ä½“éªŒä¼˜åŒ–
- [ ] æ–‡æ¡£æ›´æ–°

---

## ğŸ¯ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæå‡

- âœ… æ™®é€šç”¨æˆ·ï¼šä¸€é”®é€‰æ‹©è´¨é‡ï¼Œæ— éœ€ç†è§£æŠ€æœ¯ç»†èŠ‚
- âœ… è¿›é˜¶ç”¨æˆ·ï¼šé€šè¿‡é¢„è®¾å¿«é€Ÿè°ƒæ•´è´¨é‡å’Œæ–‡ä»¶å¤§å°
- âœ… ä¸“ä¸šç”¨æˆ·ï¼šå®Œå…¨æ§åˆ¶æ‰€æœ‰ç¼–ç å‚æ•°
- âœ… æ‰€æœ‰ç”¨æˆ·ï¼šæ¸…æ™°çš„æ–‡ä»¶å¤§å°é¢„ä¼°

### æŠ€æœ¯æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡ | éªŒè¯æ–¹æ³• |
|------|------|---------|
| è®¾ç½®åŠ è½½æ—¶é—´ | < 50ms | Performance API |
| è®¾ç½®ä¿å­˜æ—¶é—´ | < 100ms | Performance API |
| UIå“åº”æ—¶é—´ | < 16ms | ç”¨æˆ·æ„ŸçŸ¥ |
| é…ç½®ç”Ÿæˆæ—¶é—´ | < 10ms | Performance API |
| å­˜å‚¨ç©ºé—´å ç”¨ | < 1KB | chrome.storage.local |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [VIDEO-ENCODING-ANALYSIS.md](./VIDEO-ENCODING-ANALYSIS.md) - è§†é¢‘ç¼–ç æ·±åº¦åˆ†æ
- [BITRATE-SETTINGS-PROPOSAL.md](./BITRATE-SETTINGS-PROPOSAL.md) - ç ç‡è®¾ç½®æ–¹æ¡ˆå»ºè®®
- [OPFS-RECORDING-EVALUATION.md](./OPFS-RECORDING-EVALUATION.md) - OPFSå½•åˆ¶è¯„ä¼°
- [OPFS-OPTIMIZATION-PLAN.md](./OPFS-OPTIMIZATION-PLAN.md) - OPFSä¼˜åŒ–è®¡åˆ’

