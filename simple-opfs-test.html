<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple OPFS Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        button { padding: 10px 20px; margin: 10px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; }
        .error { background: #ffe6e6; color: #d00; }
        .success { background: #e6ffe6; color: #080; }
    </style>
</head>
<body>
    <h1>Simple OPFS Test</h1>
    
    <button onclick="testBasicOpfs()">Test Basic OPFS</button>
    <button onclick="testSyncAccessHandle()">Test SyncAccessHandle</button>
    <button onclick="clearLogs()">Clear Logs</button>
    
    <div id="logs"></div>

    <script>
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logs.appendChild(div);
            console.log(message);
        }

        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
        }

        async function testBasicOpfs() {
            try {
                log('Testing basic OPFS functionality...');
                
                if (!navigator.storage?.getDirectory) {
                    log('OPFS not supported', 'error');
                    return;
                }
                
                const root = await navigator.storage.getDirectory();
                log('‚úÖ Got OPFS root directory', 'success');
                
                // Create a test file
                const fileHandle = await root.getFileHandle('test.txt', { create: true });
                log('‚úÖ Created file handle', 'success');
                
                // Write to file using createWritable
                const writable = await fileHandle.createWritable();
                await writable.write('Hello OPFS!');
                await writable.close();
                log('‚úÖ Wrote data using createWritable', 'success');
                
                // Read back the file
                const file = await fileHandle.getFile();
                const text = await file.text();
                log(`‚úÖ Read back: "${text}" (${file.size} bytes)`, 'success');
                
            } catch (error) {
                log(`‚ùå Basic OPFS test failed: ${error.message}`, 'error');
            }
        }

        async function testSyncAccessHandle() {
            try {
                log('Testing SyncAccessHandle in worker...');
                
                const worker = new Worker(`
                    self.onmessage = async (e) => {
                        try {
                            const root = await navigator.storage.getDirectory();
                            self.postMessage({ type: 'log', message: '‚úÖ Worker got OPFS root' });
                            
                            const fileHandle = await root.getFileHandle('sync-test.bin', { create: true });
                            self.postMessage({ type: 'log', message: '‚úÖ Worker created file handle' });
                            
                            if (typeof fileHandle.createSyncAccessHandle === 'function') {
                                const syncHandle = await fileHandle.createSyncAccessHandle();
                                self.postMessage({ type: 'log', message: '‚úÖ Worker created SyncAccessHandle' });
                                
                                // Test write
                                const testData = new TextEncoder().encode('Hello from SyncAccessHandle!');
                                const written = syncHandle.write(testData, { at: 0 });
                                self.postMessage({ type: 'log', message: \`‚úÖ Worker wrote \${written} bytes\` });
                                
                                // Test flush
                                syncHandle.flush();
                                self.postMessage({ type: 'log', message: '‚úÖ Worker flushed data' });
                                
                                // Test read
                                const size = syncHandle.getSize();
                                const buffer = new Uint8Array(size);
                                const read = syncHandle.read(buffer, { at: 0 });
                                const readText = new TextDecoder().decode(buffer);
                                self.postMessage({ type: 'log', message: \`‚úÖ Worker read \${read} bytes: "\${readText}"\` });
                                
                                // Close
                                syncHandle.close();
                                self.postMessage({ type: 'log', message: '‚úÖ Worker closed SyncAccessHandle' });
                                
                                self.postMessage({ type: 'success' });
                            } else {
                                self.postMessage({ type: 'error', message: 'SyncAccessHandle not available' });
                            }
                        } catch (error) {
                            self.postMessage({ type: 'error', message: error.message });
                        }
                    };
                `, { type: 'module' });
                
                worker.onmessage = (e) => {
                    const { type, message } = e.data;
                    if (type === 'log') {
                        log(message, 'info');
                    } else if (type === 'success') {
                        log('üéâ SyncAccessHandle test completed successfully!', 'success');
                        worker.terminate();
                    } else if (type === 'error') {
                        log(`‚ùå SyncAccessHandle test failed: ${message}`, 'error');
                        worker.terminate();
                    }
                };
                
                worker.onerror = (error) => {
                    log(`‚ùå Worker error: ${error.message}`, 'error');
                };
                
                worker.postMessage({ type: 'start' });
                
            } catch (error) {
                log(`‚ùå SyncAccessHandle test failed: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>
