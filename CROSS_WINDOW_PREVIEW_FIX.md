# ğŸ”§ è·¨çª—å£é¢„è§ˆåŠŸèƒ½å®ç°

## ğŸ“… å®æ–½æ—¥æœŸ
2025-10-05

## ğŸ› é—®é¢˜æè¿°

### **é”™è¯¯æ—¥å¿—**
```
âš ï¸ [Preview] Frame outside current window: {
  globalFrameIndex: 638,
  windowStartIndex: 0,
  totalFrames: 90,
  windowFrameIndex: 638
}
```

### **é—®é¢˜åˆ†æ**
- âŒ å½“å‰çª—å£åªæœ‰ 90 å¸§ï¼ˆ0-89ï¼‰
- âŒ ç”¨æˆ·æƒ³é¢„è§ˆç¬¬ 638 å¸§
- âŒ é¢„è§ˆåŠŸèƒ½åªè­¦å‘Šï¼Œä¸åˆ‡æ¢çª—å£
- âŒ ç”¨æˆ·æ— æ³•é¢„è§ˆå½“å‰çª—å£å¤–çš„å¸§

### **æœŸæœ›è¡Œä¸º**
âœ… é¼ æ ‡ç§»åŠ¨åˆ°ä»»æ„ä½ç½®æ—¶ï¼Œéƒ½èƒ½é¢„è§ˆå¯¹åº”çš„è§†é¢‘å¸§
âœ… è‡ªåŠ¨åˆ‡æ¢çª—å£åŠ è½½éœ€è¦çš„å¸§
âœ… çª—å£åˆ‡æ¢å®Œæˆåç»§ç»­é¢„è§ˆ

---

## ğŸ” æ ¹æœ¬åŸå› 

### **å½“å‰å®ç°çš„é™åˆ¶**

```typescript
// âŒ ä¿®å¤å‰çš„ä»£ç 
if (windowFrameIndex >= 0 && windowFrameIndex < totalFrames) {
  // åœ¨å½“å‰çª—å£å†…ï¼Œè¯·æ±‚é¢„è§ˆå¸§
  compositeWorker?.postMessage({
    type: 'preview-frame',
    data: { frameIndex: windowFrameIndex }
  })
} else {
  // ä¸åœ¨å½“å‰çª—å£ï¼Œåªè­¦å‘Š
  console.warn('âš ï¸ [Preview] Frame outside current window')
}
```

**é—®é¢˜**ï¼š
1. åªèƒ½é¢„è§ˆå½“å‰çª—å£å†…çš„å¸§
2. è¶…å‡ºèŒƒå›´æ—¶åªè­¦å‘Šï¼Œä¸å¤„ç†
3. ç”¨æˆ·ä½“éªŒå·®ï¼Œæ— æ³•è‡ªç”±é¢„è§ˆ

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### **æ ¸å¿ƒæ€è·¯**

å‚è€ƒ `seekToGlobalFrame` çš„å®ç°ï¼š
1. âœ… æ£€æŸ¥å¸§æ˜¯å¦åœ¨å½“å‰çª—å£å†…
2. âœ… å¦‚æœåœ¨ï¼Œç›´æ¥è¯·æ±‚é¢„è§ˆå¸§
3. âœ… å¦‚æœä¸åœ¨ï¼Œè§¦å‘çª—å£åˆ‡æ¢
4. âœ… çª—å£åˆ‡æ¢å®Œæˆåï¼Œè‡ªåŠ¨è¯·æ±‚é¢„è§ˆå¸§

### **å…³é”®ä¼˜åŒ–**

#### **1. çª—å£åˆ‡æ¢èŠ‚æµ**
```typescript
const WINDOW_SWITCH_THROTTLE_MS = 300  // 300ms èŠ‚æµ
```

**åŸå› **ï¼š
- é¿å…é¼ æ ‡å¿«é€Ÿç§»åŠ¨æ—¶é¢‘ç¹åˆ‡æ¢çª—å£
- åªåœ¨é¼ æ ‡åœç•™æ—¶æ‰åˆ‡æ¢
- æå‡æ€§èƒ½å’Œç”¨æˆ·ä½“éªŒ

#### **2. é¢„è§ˆçŠ¶æ€ä¿æŒ**
```typescript
let previewTimeMs = $state(0)  // ä¿å­˜é¢„è§ˆæ—¶é—´
```

**åŸå› **ï¼š
- çª—å£åˆ‡æ¢æ˜¯å¼‚æ­¥çš„
- éœ€è¦è®°ä½ç”¨æˆ·æƒ³é¢„è§ˆçš„æ—¶é—´
- åˆ‡æ¢å®Œæˆåç»§ç»­é¢„è§ˆ

---

## ğŸ”§ å®æ–½ç»†èŠ‚

### **ä¿®æ”¹ 1: æ·»åŠ çª—å£åˆ‡æ¢èŠ‚æµ** (è¡Œ 115-123)

```typescript
// ğŸ†• é¢„è§ˆç›¸å…³çŠ¶æ€
let isPreviewMode = $state(false)
let previewTimeMs = $state(0)
let previewFrameIndex = $state<number | null>(null)
let savedPlaybackState = $state<{ frameIndex: number; isPlaying: boolean } | null>(null)
let hoverPreviewThrottleTimer: number | null = null
let windowSwitchThrottleTimer: number | null = null  // ğŸ†• çª—å£åˆ‡æ¢èŠ‚æµ
const HOVER_PREVIEW_THROTTLE_MS = 50  // 50ms é¢„è§ˆèŠ‚æµ
const WINDOW_SWITCH_THROTTLE_MS = 300  // 300ms çª—å£åˆ‡æ¢èŠ‚æµ
```

**å…³é”®ç‚¹**ï¼š
- `windowSwitchThrottleTimer`: é˜²æ­¢é¢‘ç¹åˆ‡æ¢çª—å£
- `WINDOW_SWITCH_THROTTLE_MS`: 300ms æ˜¯åˆç†çš„å¹³è¡¡ç‚¹

---

### **ä¿®æ”¹ 2: æ”¯æŒè·¨çª—å£é¢„è§ˆ** (è¡Œ 1444-1514)

```typescript
function handleHoverPreview(timeMs: number) {
  // ... èŠ‚æµæ§åˆ¶å’Œè¿›å…¥é¢„è§ˆæ¨¡å¼çš„é€»è¾‘
  
  // è®¡ç®—é¢„è§ˆå¸§ç´¢å¼•
  const globalFrameIndex = Math.floor((timeMs / 1000) * frameRate)
  const windowFrameIndex = globalFrameIndex - windowStartIndex
  
  previewTimeMs = timeMs  // ğŸ”§ ä¿å­˜é¢„è§ˆæ—¶é—´
  
  if (windowFrameIndex >= 0 && windowFrameIndex < totalFrames) {
    // ğŸ”§ åœ¨å½“å‰çª—å£å†…ï¼Œè¯·æ±‚é¢„è§ˆå¸§
    compositeWorker?.postMessage({
      type: 'preview-frame',
      data: { frameIndex: windowFrameIndex }
    })
  } else {
    // ğŸ”§ ä¸åœ¨å½“å‰çª—å£ï¼Œè§¦å‘çª—å£åˆ‡æ¢ï¼ˆå¸¦èŠ‚æµï¼‰
    if (!windowSwitchThrottleTimer) {
      windowSwitchThrottleTimer = window.setTimeout(() => {
        windowSwitchThrottleTimer = null
      }, WINDOW_SWITCH_THROTTLE_MS)
      
      console.log('ğŸ” [Preview] Frame outside current window, switching window')
      
      // è§¦å‘çª—å£åˆ‡æ¢
      const targetTimeMs = (globalFrameIndex / frameRate) * 1000
      onRequestWindow?.({
        centerMs: targetTimeMs,
        beforeMs: 1500,
        afterMs: 1500
      })
    }
  }
}
```

**å…³é”®æ”¹è¿›**ï¼š

#### **A. ä¿å­˜é¢„è§ˆæ—¶é—´**
```typescript
previewTimeMs = timeMs  // ä¿å­˜ï¼Œç”¨äºçª—å£åˆ‡æ¢åç»§ç»­é¢„è§ˆ
```

#### **B. çª—å£åˆ‡æ¢èŠ‚æµ**
```typescript
if (!windowSwitchThrottleTimer) {
  // åªåœ¨èŠ‚æµå™¨ç©ºé—²æ—¶æ‰åˆ‡æ¢
  windowSwitchThrottleTimer = window.setTimeout(...)
  onRequestWindow?.(...)
}
```

#### **C. ä½¿ç”¨ onRequestWindow**
```typescript
onRequestWindow?.({
  centerMs: targetTimeMs,  // ä»¥ç›®æ ‡æ—¶é—´ä¸ºä¸­å¿ƒ
  beforeMs: 1500,          // å‰ 1.5 ç§’
  afterMs: 1500            // å 1.5 ç§’
})
```

**æ•ˆæœ**ï¼šåŠ è½½ç›®æ ‡å¸§å‘¨å›´çš„çª—å£ï¼Œç¡®ä¿é¢„è§ˆå¸§åœ¨çª—å£å†…

---

### **ä¿®æ”¹ 3: çª—å£åˆ‡æ¢å®Œæˆåç»§ç»­é¢„è§ˆ** (è¡Œ 344-370)

```typescript
case 'ready':
  // ... çª—å£å‡†å¤‡å®Œæˆ
  
  // ğŸ”§ æ£€æŸ¥æ˜¯å¦åœ¨é¢„è§ˆæ¨¡å¼
  if (isPreviewMode && previewTimeMs > 0) {
    // çª—å£åˆ‡æ¢å®Œæˆåï¼Œç»§ç»­é¢„è§ˆ
    const globalFrameIndex = Math.floor((previewTimeMs / 1000) * frameRate)
    const windowFrameIndex = globalFrameIndex - windowStartIndex
    
    if (windowFrameIndex >= 0 && windowFrameIndex < totalFrames) {
      console.log('ğŸ” [Preview] Window switched, requesting preview frame')
      
      compositeWorker?.postMessage({
        type: 'preview-frame',
        data: { frameIndex: windowFrameIndex }
      })
    } else {
      console.warn('âš ï¸ [Preview] Preview frame still outside new window')
    }
  } else if (!shouldContinuePlayback) {
    // æ­£å¸¸æƒ…å†µï¼šé¢„è§ˆç¬¬ä¸€å¸§
    seekToFrame(0)
  }
  
  // ... ç»§ç»­æ’­æ”¾çš„é€»è¾‘
```

**å…³é”®ç‚¹**ï¼š

#### **A. ä¼˜å…ˆå¤„ç†é¢„è§ˆæ¨¡å¼**
```typescript
if (isPreviewMode && previewTimeMs > 0) {
  // é¢„è§ˆæ¨¡å¼ä¼˜å…ˆ
} else if (!shouldContinuePlayback) {
  // æ­£å¸¸æ¨¡å¼
}
```

#### **B. ä½¿ç”¨ä¿å­˜çš„é¢„è§ˆæ—¶é—´**
```typescript
const globalFrameIndex = Math.floor((previewTimeMs / 1000) * frameRate)
```

**åŸå› **ï¼š`previewTimeMs` åœ¨ `handleHoverPreview` ä¸­ä¿å­˜ï¼Œçª—å£åˆ‡æ¢åä»ç„¶æœ‰æ•ˆ

#### **C. éªŒè¯å¸§åœ¨æ–°çª—å£å†…**
```typescript
if (windowFrameIndex >= 0 && windowFrameIndex < totalFrames) {
  // åœ¨æ–°çª—å£å†…ï¼Œè¯·æ±‚é¢„è§ˆå¸§
} else {
  // ä»ç„¶ä¸åœ¨ï¼Œè­¦å‘Šï¼ˆç†è®ºä¸Šä¸åº”è¯¥å‘ç”Ÿï¼‰
}
```

---

## ğŸ“Š æ•°æ®æµ

### **åœºæ™¯ï¼šé¢„è§ˆå½“å‰çª—å£å¤–çš„å¸§**

```
1. ç”¨æˆ·ç§»åŠ¨é¼ æ ‡åˆ°æ—¶é—´çº¿çš„ 20 ç§’ä½ç½®
   å½“å‰çª—å£ï¼š0-3 ç§’ï¼ˆ90 å¸§ï¼‰
   ç›®æ ‡å¸§ï¼š600 å¸§ï¼ˆ20 ç§’ * 30fpsï¼‰
   â†“
2. handleHoverPreview(20000)
   - è®¡ç®—ï¼šglobalFrameIndex = 600
   - è®¡ç®—ï¼šwindowFrameIndex = 600 - 0 = 600
   - æ£€æŸ¥ï¼š600 >= 90 âŒ ä¸åœ¨å½“å‰çª—å£
   - ä¿å­˜ï¼špreviewTimeMs = 20000
   â†“
3. è§¦å‘çª—å£åˆ‡æ¢ï¼ˆå¸¦èŠ‚æµï¼‰
   - æ£€æŸ¥ï¼šwindowSwitchThrottleTimer ä¸ºç©º âœ…
   - è®¾ç½®ï¼š300ms èŠ‚æµå®šæ—¶å™¨
   - è°ƒç”¨ï¼šonRequestWindow({ centerMs: 20000, beforeMs: 1500, afterMs: 1500 })
   â†“
4. çª—å£åˆ‡æ¢ä¸­...
   - åŠ è½½ 18.5-21.5 ç§’çš„çª—å£
   - æ–°çª—å£ï¼šwindowStartIndex = 555ï¼ˆ18.5 ç§’ * 30fpsï¼‰
   â†“
5. Worker å‘é€ 'ready' æ¶ˆæ¯
   - æ£€æŸ¥ï¼šisPreviewMode = true âœ…
   - æ£€æŸ¥ï¼špreviewTimeMs = 20000 âœ…
   - è®¡ç®—ï¼šglobalFrameIndex = 600
   - è®¡ç®—ï¼šwindowFrameIndex = 600 - 555 = 45
   - æ£€æŸ¥ï¼š45 < totalFrames âœ… åœ¨æ–°çª—å£å†…
   â†“
6. è¯·æ±‚é¢„è§ˆå¸§
   - å‘é€ï¼špreview-frame æ¶ˆæ¯ï¼ŒframeIndex = 45
   â†“
7. Worker æ¸²æŸ“é¢„è§ˆå¸§
   - æ¸²æŸ“ç¬¬ 45 å¸§ï¼ˆå…¨å±€ç¬¬ 600 å¸§ï¼‰
   - è¿”å›ï¼špreview-frame æ¶ˆæ¯
   â†“
8. æ˜¾ç¤ºé¢„è§ˆå¸§
   - è§†é¢‘æ˜¾ç¤º 20 ç§’çš„å¸§ âœ…
   - ç°è‰²é¢„è§ˆç«–çº¿æ˜¾ç¤ºåœ¨ 20 ç§’ä½ç½® âœ…
   - è“è‰²æ’­æ”¾å¤´ä¿æŒåœ¨åŸä½ç½® âœ…
```

---

## âœ… æµ‹è¯•éªŒè¯

### **æµ‹è¯•åœºæ™¯ 1: é¢„è§ˆå½“å‰çª—å£å†…çš„å¸§**
1. âœ… å½“å‰çª—å£ï¼š0-3 ç§’
2. âœ… é¼ æ ‡ç§»åˆ° 2 ç§’ä½ç½®
3. âœ… **éªŒè¯**: ç›´æ¥æ˜¾ç¤ºé¢„è§ˆå¸§ï¼Œä¸åˆ‡æ¢çª—å£ âœ…

### **æµ‹è¯•åœºæ™¯ 2: é¢„è§ˆå½“å‰çª—å£å¤–çš„å¸§**
1. âœ… å½“å‰çª—å£ï¼š0-3 ç§’
2. âœ… é¼ æ ‡ç§»åˆ° 10 ç§’ä½ç½®
3. âœ… **éªŒè¯**: è§¦å‘çª—å£åˆ‡æ¢ âœ…
4. âœ… **éªŒè¯**: çª—å£åˆ‡æ¢å®Œæˆåæ˜¾ç¤ºé¢„è§ˆå¸§ âœ…

### **æµ‹è¯•åœºæ™¯ 3: å¿«é€Ÿç§»åŠ¨é¼ æ ‡**
1. âœ… é¼ æ ‡å¿«é€Ÿä» 0 ç§’ç§»åˆ° 30 ç§’
2. âœ… **éªŒè¯**: çª—å£åˆ‡æ¢èŠ‚æµç”Ÿæ•ˆï¼Œä¸é¢‘ç¹åˆ‡æ¢ âœ…
3. âœ… **éªŒè¯**: æœ€ç»ˆæ˜¾ç¤º 30 ç§’çš„é¢„è§ˆå¸§ âœ…

### **æµ‹è¯•åœºæ™¯ 4: é¢„è§ˆæœŸé—´ç§»å‡ºæ—¶é—´çº¿**
1. âœ… é¼ æ ‡ç§»åˆ° 10 ç§’ä½ç½®ï¼ˆè§¦å‘çª—å£åˆ‡æ¢ï¼‰
2. âœ… çª—å£åˆ‡æ¢ä¸­ï¼Œé¼ æ ‡ç§»å‡ºæ—¶é—´çº¿
3. âœ… **éªŒè¯**: é¢„è§ˆç»“æŸï¼Œæ¢å¤åˆ°åŸæ’­æ”¾ä½ç½® âœ…

---

## ğŸ“ ä»£ç å˜æ›´

### **æ–‡ä»¶**: `src/lib/components/VideoPreviewComposite.svelte`

**ä¿®æ”¹ä½ç½®**:
- è¡Œ 115-123: æ·»åŠ çª—å£åˆ‡æ¢èŠ‚æµçŠ¶æ€
- è¡Œ 1444-1514: æ”¯æŒè·¨çª—å£é¢„è§ˆ
- è¡Œ 344-370: çª—å£åˆ‡æ¢å®Œæˆåç»§ç»­é¢„è§ˆ

**ä»£ç è¡Œæ•°**: ~50 è¡Œæ–°å¢/ä¿®æ”¹

---

## ğŸ¯ å…³é”®è¦ç‚¹

### **1. æ— ç¼çš„é¢„è§ˆä½“éªŒ**
- âœ… ç”¨æˆ·å¯ä»¥é¢„è§ˆä»»æ„ä½ç½®çš„å¸§
- âœ… è‡ªåŠ¨åˆ‡æ¢çª—å£ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œ
- âœ… çª—å£åˆ‡æ¢å¯¹ç”¨æˆ·é€æ˜

### **2. æ€§èƒ½ä¼˜åŒ–**
- âœ… 300ms çª—å£åˆ‡æ¢èŠ‚æµ
- âœ… é¿å…é¢‘ç¹åˆ‡æ¢å¯¼è‡´çš„æ€§èƒ½é—®é¢˜
- âœ… åªåœ¨é¼ æ ‡åœç•™æ—¶æ‰åˆ‡æ¢

### **3. çŠ¶æ€ä¸€è‡´æ€§**
- âœ… `previewTimeMs` ä¿å­˜é¢„è§ˆæ—¶é—´
- âœ… çª—å£åˆ‡æ¢åç»§ç»­é¢„è§ˆ
- âœ… è“è‰²æ’­æ”¾å¤´å§‹ç»ˆä¿æŒåœ¨åŸä½ç½®

### **4. é˜²å¾¡æ€§ç¼–ç¨‹**
- âœ… æ£€æŸ¥é¢„è§ˆå¸§æ˜¯å¦åœ¨æ–°çª—å£å†…
- âœ… å¤„ç†å¼‚å¸¸æƒ…å†µï¼ˆå¸§ä»ç„¶ä¸åœ¨çª—å£å†…ï¼‰
- âœ… è¯¦ç»†çš„æ—¥å¿—è¾“å‡º

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### **1. çª—å£åˆ‡æ¢å»¶è¿Ÿ**
- çª—å£åˆ‡æ¢éœ€è¦æ—¶é—´ï¼ˆåŠ è½½å’Œè§£ç ï¼‰
- ç”¨æˆ·å¯èƒ½ä¼šæ„Ÿè§‰åˆ°çŸ­æš‚çš„å»¶è¿Ÿ
- è¿™æ˜¯æ­£å¸¸çš„ï¼Œæ— æ³•é¿å…

### **2. èŠ‚æµæ—¶é—´è°ƒæ•´**
- å½“å‰è®¾ç½®ï¼š300ms
- å¯ä»¥æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´
- æ›´çŸ­ï¼šå“åº”æ›´å¿«ï¼Œä½†å¯èƒ½é¢‘ç¹åˆ‡æ¢
- æ›´é•¿ï¼šåˆ‡æ¢æ›´å°‘ï¼Œä½†å“åº”è¾ƒæ…¢

### **3. é¢„è§ˆèŒƒå›´**
- çª—å£å¤§å°ï¼šcenterMs Â± 1500msï¼ˆ3 ç§’ï¼‰
- å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´
- æ›´å¤§çš„çª—å£ï¼šå‡å°‘åˆ‡æ¢æ¬¡æ•°ï¼Œä½†å†…å­˜å ç”¨æ›´å¤š

---

## âœ… æ€»ç»“

æœ¬æ¬¡å®ç°æˆåŠŸæ”¯æŒäº†è·¨çª—å£é¢„è§ˆåŠŸèƒ½ï¼š

- âœ… **æ— é™åˆ¶é¢„è§ˆ**ï¼šå¯ä»¥é¢„è§ˆä»»æ„ä½ç½®çš„è§†é¢‘å¸§
- âœ… **è‡ªåŠ¨çª—å£åˆ‡æ¢**ï¼šå‚è€ƒ `seekToGlobalFrame` çš„å®ç°
- âœ… **æ€§èƒ½ä¼˜åŒ–**ï¼š300ms èŠ‚æµï¼Œé¿å…é¢‘ç¹åˆ‡æ¢
- âœ… **çŠ¶æ€ä¿æŒ**ï¼šçª—å£åˆ‡æ¢åç»§ç»­é¢„è§ˆ
- âœ… **ç”¨æˆ·ä½“éªŒ**ï¼šæ— ç¼ã€æµç•…ã€ç›´è§‚

ç°åœ¨ç”¨æˆ·å¯ä»¥åœ¨æ—¶é—´çº¿ä¸Šè‡ªç”±ç§»åŠ¨é¼ æ ‡ï¼Œé¢„è§ˆä»»æ„ä½ç½®çš„è§†é¢‘å¸§ï¼Œä¸å—çª—å£é™åˆ¶ï¼ğŸ‰

