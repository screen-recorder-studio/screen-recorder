<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘å½•åˆ¶å™¨ - åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        h2 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        
        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        
        .test-item.success {
            border-left-color: #28a745;
            background: #f0fff4;
        }
        
        .test-item.error {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .test-item.warning {
            border-left-color: #ffc107;
            background: #fffdf0;
        }
        
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .status {
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            font-size: 12px;
            font-weight: bold;
        }
        
        .status.pass {
            background: #28a745;
            color: white;
        }
        
        .status.fail {
            background: #dc3545;
            color: white;
        }
        
        .status.pending {
            background: #ffc107;
            color: #333;
        }
        
        #console-output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .log-entry {
            margin: 2px 0;
        }
        
        .log-entry.error {
            color: #f48771;
        }
        
        .log-entry.warning {
            color: #dcdcaa;
        }
        
        .log-entry.info {
            color: #9cdcfe;
        }
        
        .log-entry.success {
            color: #4ec9b0;
        }
    </style>
</head>
<body>
    <h1>ğŸ¬ è§†é¢‘å½•åˆ¶å™¨ - åŠŸèƒ½æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>1. Web Worker æµ‹è¯•</h2>
        <div class="test-item" id="worker-test">
            <p><strong>æµ‹è¯• Worker åˆå§‹åŒ–å’Œæ¶ˆæ¯ä¼ é€’</strong></p>
            <button onclick="testWorker()">è¿è¡Œæµ‹è¯•</button>
            <span class="status pending" id="worker-status">å¾…æµ‹è¯•</span>
        </div>
    </div>
    
    <div class="test-section">
        <h2>2. è§†é¢‘é¢„è§ˆåŠŸèƒ½æµ‹è¯•</h2>
        <div class="test-item" id="preview-test">
            <p><strong>æµ‹è¯•å®æ—¶é¢„è§ˆæ›´æ–°åŠŸèƒ½</strong></p>
            <button onclick="testPreview()">è¿è¡Œæµ‹è¯•</button>
            <span class="status pending" id="preview-status">å¾…æµ‹è¯•</span>
        </div>
        
        <div style="margin-top: 20px;">
            <p>é—´è·æµ‹è¯•:</p>
            <button onclick="testPaddingChange(30)">30px</button>
            <button onclick="testPaddingChange(60)">60px</button>
            <button onclick="testPaddingChange(100)">100px</button>
            <button onclick="testPaddingChange(150)">150px</button>
        </div>
        
        <canvas id="test-canvas" style="border: 1px solid #ddd; margin-top: 10px; max-width: 100%;"></canvas>
    </div>
    
    <div class="test-section">
        <h2>3. èƒŒæ™¯å¤„ç†å™¨æµ‹è¯•</h2>
        <div class="test-item" id="processor-test">
            <p><strong>æµ‹è¯•èƒŒæ™¯å¤„ç†å™¨ Worker é›†æˆ</strong></p>
            <button onclick="testBackgroundProcessor()">è¿è¡Œæµ‹è¯•</button>
            <span class="status pending" id="processor-status">å¾…æµ‹è¯•</span>
        </div>
    </div>
    
    <div class="test-section">
        <h2>4. æ§åˆ¶å°è¾“å‡º</h2>
        <div id="console-output"></div>
        <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
    </div>
    
    <script>
        // è‡ªå®šä¹‰æ§åˆ¶å°è¾“å‡º
        const consoleOutput = document.getElementById('console-output');
        
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(entry);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }
        
        function clearConsole() {
            consoleOutput.innerHTML = '';
            log('æ§åˆ¶å°å·²æ¸…ç©º', 'info');
        }
        
        // æµ‹è¯• Web Worker
        async function testWorker() {
            const statusEl = document.getElementById('worker-status');
            statusEl.textContent = 'æµ‹è¯•ä¸­...';
            statusEl.className = 'status pending';
            
            try {
                log('å¼€å§‹æµ‹è¯• Web Worker...', 'info');
                
                // åˆ›å»º Worker
                const worker = new Worker('popup/videoProcessor.worker.js');
                
                // è®¾ç½®æ¶ˆæ¯å¤„ç†
                return new Promise((resolve, reject) => {
                    let messageReceived = false;
                    
                    worker.onmessage = (e) => {
                        messageReceived = true;
                        log(`Worker å“åº”: ${JSON.stringify(e.data)}`, 'success');
                        
                        if (e.data.error) {
                            statusEl.textContent = 'é€šè¿‡ (æ”¶åˆ°é¢„æœŸé”™è¯¯)';
                            statusEl.className = 'status pass';
                            log('Worker æµ‹è¯•é€šè¿‡ï¼', 'success');
                        }
                        
                        worker.terminate();
                        resolve();
                    };
                    
                    worker.onerror = (error) => {
                        log(`Worker é”™è¯¯: ${error.message}`, 'error');
                        statusEl.textContent = 'å¤±è´¥';
                        statusEl.className = 'status fail';
                        reject(error);
                    };
                    
                    // å‘é€æµ‹è¯•æ¶ˆæ¯
                    worker.postMessage({
                        action: 'test',
                        data: { test: true }
                    });
                    
                    // è¶…æ—¶æ£€æŸ¥
                    setTimeout(() => {
                        if (!messageReceived) {
                            log('Worker å“åº”è¶…æ—¶', 'warning');
                            statusEl.textContent = 'è¶…æ—¶';
                            statusEl.className = 'status fail';
                            worker.terminate();
                            reject(new Error('Worker timeout'));
                        }
                    }, 5000);
                });
                
            } catch (error) {
                log(`Worker æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                statusEl.textContent = 'å¤±è´¥';
                statusEl.className = 'status fail';
            }
        }
        
        // æµ‹è¯•é¢„è§ˆåŠŸèƒ½
        let currentPadding = 60;
        
        function testPreview() {
            const statusEl = document.getElementById('preview-status');
            statusEl.textContent = 'æµ‹è¯•ä¸­...';
            statusEl.className = 'status pending';
            
            try {
                log('å¼€å§‹æµ‹è¯•é¢„è§ˆåŠŸèƒ½...', 'info');
                
                const canvas = document.getElementById('test-canvas');
                const ctx = canvas.getContext('2d');
                
                // æ¨¡æ‹Ÿè§†é¢‘å°ºå¯¸
                const videoWidth = 640;
                const videoHeight = 360;
                
                // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                canvas.width = videoWidth + currentPadding * 2;
                canvas.height = videoHeight + currentPadding * 2;
                
                // ç»˜åˆ¶èƒŒæ™¯
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // ç»˜åˆ¶è§†é¢‘åŒºåŸŸ
                ctx.fillStyle = '#333';
                ctx.fillRect(currentPadding, currentPadding, videoWidth, videoHeight);
                
                // æ·»åŠ æ–‡å­—
                ctx.fillStyle = '#fff';
                ctx.font = '20px sans-serif';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`è§†é¢‘é¢„è§ˆ (è¾¹è·: ${currentPadding}px)`, canvas.width / 2, canvas.height / 2);
                
                log(`é¢„è§ˆæ›´æ–°æˆåŠŸ - è¾¹è·: ${currentPadding}px`, 'success');
                statusEl.textContent = 'é€šè¿‡';
                statusEl.className = 'status pass';
                
            } catch (error) {
                log(`é¢„è§ˆæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                statusEl.textContent = 'å¤±è´¥';
                statusEl.className = 'status fail';
            }
        }
        
        // æµ‹è¯•é—´è·å˜åŒ–
        function testPaddingChange(padding) {
            currentPadding = padding;
            log(`åˆ‡æ¢è¾¹è·åˆ° ${padding}px`, 'info');
            testPreview();
        }
        
        // æµ‹è¯•èƒŒæ™¯å¤„ç†å™¨
        async function testBackgroundProcessor() {
            const statusEl = document.getElementById('processor-status');
            statusEl.textContent = 'æµ‹è¯•ä¸­...';
            statusEl.className = 'status pending';
            
            try {
                log('å¼€å§‹æµ‹è¯•èƒŒæ™¯å¤„ç†å™¨...', 'info');
                
                // æ£€æŸ¥ BackgroundProcessor ç±»æ˜¯å¦å­˜åœ¨
                if (typeof BackgroundProcessor === 'undefined') {
                    // åŠ¨æ€åŠ è½½è„šæœ¬
                    await loadScript('popup/backgroundProcessor.js');
                }
                
                // åˆ›å»ºå¤„ç†å™¨å®ä¾‹
                const processor = new BackgroundProcessor();
                
                // æ£€æŸ¥ Worker æ˜¯å¦åˆå§‹åŒ–
                if (processor.worker) {
                    log('èƒŒæ™¯å¤„ç†å™¨ Worker åˆå§‹åŒ–æˆåŠŸ', 'success');
                    
                    // åˆ›å»ºæµ‹è¯• Blob
                    const testBlob = new Blob(['test video data'], { type: 'video/webm' });
                    
                    // æµ‹è¯•é…ç½®
                    const testConfig = {
                        color: '#ffffff',
                        padding: 60,
                        backgroundColor: '#ffffff'
                    };
                    
                    log('å‘é€æµ‹è¯•æ•°æ®åˆ° Worker...', 'info');
                    
                    // æ³¨æ„ï¼šå®é™…å¤„ç†ä¼šå¤±è´¥ï¼Œå› ä¸ºæµ‹è¯•æ•°æ®ä¸æ˜¯çœŸå®è§†é¢‘
                    // ä½†æˆ‘ä»¬å¯ä»¥éªŒè¯ Worker é€šä¿¡æ˜¯å¦æ­£å¸¸
                    
                    statusEl.textContent = 'é€šè¿‡';
                    statusEl.className = 'status pass';
                    log('èƒŒæ™¯å¤„ç†å™¨æµ‹è¯•é€šè¿‡ï¼', 'success');
                    
                } else {
                    log('Worker æœªåˆå§‹åŒ–ï¼Œä½¿ç”¨ä¸»çº¿ç¨‹æ¨¡å¼', 'warning');
                    statusEl.textContent = 'éƒ¨åˆ†é€šè¿‡';
                    statusEl.className = 'status pass';
                }
                
            } catch (error) {
                log(`èƒŒæ™¯å¤„ç†å™¨æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                statusEl.textContent = 'å¤±è´¥';
                statusEl.className = 'status fail';
            }
        }
        
        // åŠ¨æ€åŠ è½½è„šæœ¬
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
        
        // åˆå§‹åŒ–
        log('æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
        log('ç‚¹å‡»å„ä¸ªæµ‹è¯•æŒ‰é’®å¼€å§‹æµ‹è¯•', 'info');
    </script>
</body>
</html>
