<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†é¢‘è½¬GIF - é«˜çº§ç‰ˆæœ¬</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        h1 {
            color: #333;
            margin-bottom: 30px;
            text-align: center;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 30px;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f8f9fa;
        }

        .upload-area.dragover {
            background: #e3f2fd;
            border-color: #2196F3;
        }

        .preview-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        .preview-box {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
        }

        .preview-box h3 {
            margin-bottom: 15px;
            color: #555;
        }

        video, canvas, img {
            width: 100%;
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .controls {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .control-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .control-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            color: #666;
            font-size: 0.9em;
            font-weight: 500;
        }

        input[type="range"] {
            width: 100%;
        }

        input[type="number"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1em;
        }

        .value-display {
            color: #667eea;
            font-weight: 600;
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }

        button {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #e0e0e0;
            color: #666;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .progress {
            background: #e0e0e0;
            border-radius: 10px;
            height: 30px;
            overflow: hidden;
            margin-top: 20px;
            display: none;
        }

        .progress.active {
            display: block;
        }

        .progress-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            transition: width 0.3s;
        }

        .status {
            text-align: center;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            font-weight: 500;
        }

        .status.info { background: #e3f2fd; color: #1976d2; }
        .status.success { background: #e8f5e9; color: #388e3c; }
        .status.error { background: #ffebee; color: #d32f2f; }
        .status.processing { background: #fff3e0; color: #f57c00; }

        .info-box {
            background: #f5f5f5;
            border-left: 4px solid #667eea;
            padding: 15px;
            margin-top: 20px;
            border-radius: 5px;
        }

        .info-box h4 {
            color: #667eea;
            margin-bottom: 10px;
        }

        .info-box p {
            color: #666;
            line-height: 1.6;
        }

        .frames-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }

        .frame-thumb {
            width: 100%;
            border-radius: 5px;
            border: 2px solid transparent;
            cursor: pointer;
        }

        .frame-thumb:hover {
            border-color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¬ è§†é¢‘è½¬ GIF - ä¸“ä¸šç‰ˆ</h1>

        <div class="upload-area" id="uploadArea">
            <p style="font-size: 2em; margin-bottom: 10px;">ğŸ“¹</p>
            <p>ç‚¹å‡»é€‰æ‹©è§†é¢‘æˆ–æ‹–æ‹½è§†é¢‘æ–‡ä»¶åˆ°è¿™é‡Œ</p>
            <input type="file" id="fileInput" accept="video/*" style="display: none;">
        </div>

        <div class="preview-section" id="previewSection" style="display: none;">
            <div class="preview-box">
                <h3>ğŸ“¹ åŸå§‹è§†é¢‘</h3>
                <video id="videoElement" controls></video>
                <div class="info-box">
                    <h4>è§†é¢‘ä¿¡æ¯</h4>
                    <p id="videoInfo"></p>
                </div>
            </div>
            <div class="preview-box">
                <h3>ğŸ–¼ï¸ GIF é¢„è§ˆ</h3>
                <canvas id="previewCanvas"></canvas>
                <img id="gifResult" style="display: none;">
                <div class="frames-preview" id="framesPreview"></div>
            </div>
        </div>

        <div class="controls" id="controls" style="display: none;">
            <h3 style="margin-bottom: 15px; color: #555;">â›™ï¸ è½¬æ¢è®¾ç½®</h3>
            
            <div style="margin-bottom: 20px; padding: 15px; background: #f0f8ff; border-radius: 8px;">
                <label style="font-weight: 600; color: #667eea; display: block; margin-bottom: 10px;">ğŸ¯ é¢„è®¾æ¨¡æ¿:</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px;">
                    <button class="preset-btn" data-preset="high-quality" style="padding: 10px; background: white; border: 2px solid #667eea; border-radius: 5px; cursor: pointer; transition: all 0.3s;">
                        ğŸ’ é«˜è´¨é‡
                    </button>
                    <button class="preset-btn" data-preset="balanced" style="padding: 10px; background: white; border: 2px solid #667eea; border-radius: 5px; cursor: pointer; transition: all 0.3s;">
                        âš–ï¸ å¹³è¡¡æ¨¡å¼
                    </button>
                    <button class="preset-btn" data-preset="small-size" style="padding: 10px; background: white; border: 2px solid #667eea; border-radius: 5px; cursor: pointer; transition: all 0.3s;">
                        ğŸ’¾ å°æ–‡ä»¶
                    </button>
                    <button class="preset-btn" data-preset="smooth" style="padding: 10px; background: white; border: 2px solid #667eea; border-radius: 5px; cursor: pointer; transition: all 0.3s;">
                        ğŸŒŠ æµç•…åŠ¨ç”»
                    </button>
                    <button class="preset-btn" data-preset="retro" style="padding: 10px; background: white; border: 2px solid #667eea; border-radius: 5px; cursor: pointer; transition: all 0.3s;">
                        ğŸ•¹ï¸ å¤å¤é£æ ¼
                    </button>
                </div>
            </div>
            
            <div class="control-row">
                <div class="control-item">
                    <label for="startTime">å¼€å§‹æ—¶é—´ (ç§’): <span class="value-display" id="startTimeValue">0</span></label>
                    <input type="range" id="startTime" min="0" max="60" value="0" step="0.1">
                </div>
                <div class="control-item">
                    <label for="duration">æŒç»­æ—¶é—´ (ç§’): <span class="value-display" id="durationValue">3</span></label>
                    <input type="range" id="duration" min="1" max="10" value="3" step="0.5">
                </div>
            </div>

            <div class="control-row">
                <div class="control-item">
                    <label for="frameRate">å¸§ç‡ (FPS): <span class="value-display" id="frameRateValue">10</span></label>
                    <input type="range" id="frameRate" min="5" max="30" value="10" step="1">
                </div>
                <div class="control-item">
                    <label for="quality">é‡‡æ ·è´¨é‡: <span class="value-display" id="qualityValue">10</span></label>
                    <input type="range" id="quality" min="1" max="30" value="10" step="1">
                    <small style="color: #999;">åƒç´ é‡‡æ ·é—´éš”ï¼š1=æœ€ä½³(æ…¢) | 10=å‡è¡¡ | 30=æœ€å¿«(è´¨é‡ä½)</small>
                </div>
            </div>

            <div class="control-row">
                <div class="control-item">
                    <label for="scale">ç¼©æ”¾æ¯”ä¾‹: <span class="value-display" id="scaleValue">100%</span></label>
                    <input type="range" id="scale" min="25" max="100" value="100" step="5">
                    <small style="color: #999;">ç¼©å°å°ºå¯¸å¯å‡å°æ–‡ä»¶å¤§å°</small>
                </div>
                <div class="control-item">
                    <label for="workers">å·¥ä½œçº¿ç¨‹: <span class="value-display" id="workersValue">2</span></label>
                    <input type="range" id="workers" min="1" max="8" value="2" step="1">
                </div>
            </div>

            <h4 style="margin-top: 20px; margin-bottom: 15px; color: #667eea;">ğŸ¨ é«˜çº§è®¾ç½®</h4>
            
            <div class="control-row">
                <div class="control-item">
                    <label for="repeat">é‡å¤æ¬¡æ•°: <span class="value-display" id="repeatValue">0 (æ°¸è¿œ)</span></label>
                    <input type="range" id="repeat" min="-1" max="10" value="0" step="1">
                    <small style="color: #999;">-1=ä¸é‡å¤, 0=æ°¸è¿œé‡å¤</small>
                </div>
                <div class="control-item">
                    <label for="dither">æŠ–åŠ¨ç®—æ³•:</label>
                    <select id="dither" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                        <option value="false">æ— æŠ–åŠ¨</option>
                        <option value="FloydSteinberg">Floyd-Steinberg</option>
                        <option value="FalseFloydSteinberg">False Floyd-Steinberg</option>
                        <option value="Stucki">Stucki</option>
                        <option value="Atkinson">Atkinson</option>
                        <option value="FloydSteinberg-serpentine">Floyd-Steinberg (è›‡å½¢)</option>
                    </select>
                    <small style="color: #999;">æŠ–åŠ¨å¯ä»¥æ”¹å–„é¢œè‰²è¿‡æ¸¡</small>
                </div>
            </div>

            <div class="control-row">
                <div class="control-item">
                    <label for="background">èƒŒæ™¯è‰²:</label>
                    <input type="color" id="background" value="#ffffff" style="width: 100%; height: 40px; border: 1px solid #ddd; border-radius: 5px; cursor: pointer;">
                    <small style="color: #999;">é€æ˜åŒºåŸŸçš„èƒŒæ™¯è‰²</small>
                </div>
                <div class="control-item">
                    <label for="transparent">é€æ˜è‰²:</label>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="checkbox" id="useTransparent" style="width: 20px; height: 20px;">
                        <input type="color" id="transparent" value="#00ff00" disabled style="flex: 1; height: 40px; border: 1px solid #ddd; border-radius: 5px;">
                    </div>
                    <small style="color: #999;">å‹¾é€‰åè®¾ç½®é€æ˜è‰²</small>
                </div>
            </div>

            <div class="control-row">
                <div class="control-item">
                    <label for="dispose">å¸§å¤„ç†æ–¹å¼:</label>
                    <select id="dispose" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; width: 100%;">
                        <option value="-1">è‡ªåŠ¨</option>
                        <option value="0">æ— å¤„ç†</option>
                        <option value="1">ä¸å¤„ç†</option>
                        <option value="2">æ¢å¤èƒŒæ™¯</option>
                        <option value="3">æ¢å¤å‰ä¸€å¸§</option>
                    </select>
                    <small style="color: #999;">æ§åˆ¶å¸§ä¹‹é—´çš„è¿‡æ¸¡æ–¹å¼</small>
                </div>
                <div class="control-item">
                    <label for="debug">
                        <input type="checkbox" id="debug" style="width: 20px; height: 20px; margin-right: 10px;">
                        è°ƒè¯•æ¨¡å¼
                    </label>
                    <small style="color: #999;">åœ¨æ§åˆ¶å°è¾“å‡ºè°ƒè¯•ä¿¡æ¯</small>
                </div>
            </div>

            <div class="button-group">
                <button class="btn-primary" id="extractFrames">æå–å¸§é¢„è§ˆ</button>
                <button class="btn-primary" id="convertBtn">å¼€å§‹è½¬æ¢</button>
                <button class="btn-secondary" id="downloadBtn" disabled>ä¸‹è½½ GIF</button>
            </div>
        </div>

        <div class="progress" id="progressBar">
            <div class="progress-bar" id="progressBarFill" style="width: 0%">0%</div>
        </div>

        <div class="status info" id="status">è¯·é€‰æ‹©ä¸€ä¸ªè§†é¢‘æ–‡ä»¶å¼€å§‹</div>
    </div>

    <script src="gif.js"></script>
    <script>
        class VideoToGif {
            constructor() {
                this.video = document.getElementById('videoElement');
                this.canvas = document.getElementById('previewCanvas');
                this.ctx = this.canvas.getContext('2d', { willReadFrequently: true });
                this.gifResult = document.getElementById('gifResult');
                this.framesPreview = document.getElementById('framesPreview');
                this.gifBlob = null;
                this.frames = [];
                
                this.initElements();
                this.bindEvents();
            }

            initElements() {
                this.uploadArea = document.getElementById('uploadArea');
                this.fileInput = document.getElementById('fileInput');
                this.previewSection = document.getElementById('previewSection');
                this.controls = document.getElementById('controls');
                this.status = document.getElementById('status');
                this.progressBar = document.getElementById('progressBar');
                this.progressBarFill = document.getElementById('progressBarFill');
                
                // Controls
                this.startTimeSlider = document.getElementById('startTime');
                this.durationSlider = document.getElementById('duration');
                this.frameRateSlider = document.getElementById('frameRate');
                this.qualitySlider = document.getElementById('quality');
                this.scaleSlider = document.getElementById('scale');
                this.workersSlider = document.getElementById('workers');
                
                // Advanced controls
                this.repeatSlider = document.getElementById('repeat');
                this.ditherSelect = document.getElementById('dither');
                this.backgroundInput = document.getElementById('background');
                this.transparentInput = document.getElementById('transparent');
                this.useTransparentCheckbox = document.getElementById('useTransparent');
                this.disposeSelect = document.getElementById('dispose');
                this.debugCheckbox = document.getElementById('debug');
                
                // Buttons
                this.extractBtn = document.getElementById('extractFrames');
                this.convertBtn = document.getElementById('convertBtn');
                this.downloadBtn = document.getElementById('downloadBtn');
            }

            bindEvents() {
                // File upload
                this.uploadArea.addEventListener('click', () => this.fileInput.click());
                this.fileInput.addEventListener('change', (e) => this.handleFileSelect(e.target.files[0]));
                
                // Drag and drop
                this.uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.add('dragover');
                });
                this.uploadArea.addEventListener('dragleave', () => {
                    this.uploadArea.classList.remove('dragover');
                });
                this.uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    this.uploadArea.classList.remove('dragover');
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('video/')) {
                        this.handleFileSelect(file);
                    }
                });
                
                // Sliders
                const sliders = [
                    { elem: this.startTimeSlider, display: 'startTimeValue' },
                    { elem: this.durationSlider, display: 'durationValue' },
                    { elem: this.frameRateSlider, display: 'frameRateValue' },
                    { elem: this.qualitySlider, display: 'qualityValue' },
                    { elem: this.scaleSlider, display: 'scaleValue', suffix: '%' },
                    { elem: this.workersSlider, display: 'workersValue' }
                ];
                
                // Repeat slider special handling
                this.repeatSlider.addEventListener('input', (e) => {
                    const value = parseInt(e.target.value);
                    let text = value.toString();
                    if (value === -1) text = '-1 (ä¸é‡å¤)';
                    if (value === 0) text = '0 (æ°¸è¿œ)';
                    if (value > 0) text = `${value} æ¬¡`;
                    document.getElementById('repeatValue').textContent = text;
                });
                
                // Transparent color checkbox
                this.useTransparentCheckbox.addEventListener('change', (e) => {
                    this.transparentInput.disabled = !e.target.checked;
                });
                
                sliders.forEach(({ elem, display, suffix = '' }) => {
                    elem.addEventListener('input', (e) => {
                        document.getElementById(display).textContent = e.target.value + suffix;
                    });
                });
                
                // Buttons
                this.extractBtn.addEventListener('click', () => this.extractFramesPreview());
                this.convertBtn.addEventListener('click', () => this.convertToGif());
                this.downloadBtn.addEventListener('click', () => this.downloadGif());
                
                // Preset buttons
                document.querySelectorAll('.preset-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.applyPreset(e.target.dataset.preset));
                    btn.addEventListener('mouseenter', (e) => {
                        e.target.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                        e.target.style.color = 'white';
                    });
                    btn.addEventListener('mouseleave', (e) => {
                        e.target.style.background = 'white';
                        e.target.style.color = '#333';
                    });
                });
            }

            async handleFileSelect(file) {
                if (!file || !file.type.startsWith('video/')) {
                    this.updateStatus('è¯·é€‰æ‹©ä¸€ä¸ªæœ‰æ•ˆçš„è§†é¢‘æ–‡ä»¶', 'error');
                    return;
                }
                
                const url = URL.createObjectURL(file);
                this.video.src = url;
                
                this.video.addEventListener('loadedmetadata', () => {
                    // æ˜¾ç¤ºè§†é¢‘ä¿¡æ¯
                    const info = `
                        æ–‡ä»¶å: ${file.name}<br>
                        å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB<br>
                        æ—¶é•¿: ${this.video.duration.toFixed(2)} ç§’<br>
                        å°ºå¯¸: ${this.video.videoWidth} x ${this.video.videoHeight}
                    `;
                    document.getElementById('videoInfo').innerHTML = info;
                    
                    // æ›´æ–°æ—¶é—´æ»‘å—èŒƒå›´
                    this.startTimeSlider.max = Math.floor(this.video.duration);
                    
                    // è®¾ç½®ç”»å¸ƒå°ºå¯¸
                    const scale = parseInt(this.scaleSlider.value) / 100;
                    this.canvas.width = this.video.videoWidth * scale;
                    this.canvas.height = this.video.videoHeight * scale;
                    
                    // æ˜¾ç¤ºæ§ä»¶
                    this.previewSection.style.display = 'grid';
                    this.controls.style.display = 'block';
                    
                    this.updateStatus('è§†é¢‘å·²åŠ è½½ï¼Œå¯ä»¥å¼€å§‹è½¬æ¢', 'info');
                }, { once: true });
            }

            async extractFramesPreview() {
                this.framesPreview.innerHTML = '';
                this.frames = [];
                
                const startTime = parseFloat(this.startTimeSlider.value);
                const duration = parseFloat(this.durationSlider.value);
                const fps = parseInt(this.frameRateSlider.value);
                const frameCount = Math.floor(duration * fps);
                const frameInterval = 1 / fps;
                
                this.updateStatus('æ­£åœ¨æå–å¸§...', 'processing');
                
                for (let i = 0; i < Math.min(frameCount, 10); i++) {
                    const time = startTime + i * frameInterval;
                    await this.seekToTime(time);
                    
                    const thumbCanvas = document.createElement('canvas');
                    thumbCanvas.width = 100;
                    thumbCanvas.height = 75;
                    const thumbCtx = thumbCanvas.getContext('2d');
                    thumbCtx.drawImage(this.video, 0, 0, 100, 75);
                    
                    const img = document.createElement('img');
                    img.src = thumbCanvas.toDataURL();
                    img.className = 'frame-thumb';
                    img.title = `å¸§ ${i + 1} (${time.toFixed(2)}s)`;
                    this.framesPreview.appendChild(img);
                }
                
                this.updateStatus('å¸§é¢„è§ˆå·²ç”Ÿæˆ', 'success');
            }

            async seekToTime(time) {
                return new Promise((resolve) => {
                    const onSeeked = () => {
                        this.video.removeEventListener('seeked', onSeeked);
                        setTimeout(resolve, 50); // ç»™è§†é¢‘ä¸€ç‚¹æ—¶é—´æ¸²æŸ“
                    };
                    this.video.addEventListener('seeked', onSeeked);
                    this.video.currentTime = time;
                });
            }

            async convertToGif() {
                const startTime = parseFloat(this.startTimeSlider.value);
                const duration = parseFloat(this.durationSlider.value);
                const fps = parseInt(this.frameRateSlider.value);
                const quality = parseInt(this.qualitySlider.value);
                const scale = parseInt(this.scaleSlider.value) / 100;
                const workers = parseInt(this.workersSlider.value);
                
                // Advanced options
                const repeat = parseInt(this.repeatSlider.value);
                const dither = this.ditherSelect.value === 'false' ? false : this.ditherSelect.value;
                const background = this.backgroundInput.value;
                const transparent = this.useTransparentCheckbox.checked ? 
                    this.transparentInput.value.replace('#', '0x') : null;
                const dispose = parseInt(this.disposeSelect.value);
                const debug = this.debugCheckbox.checked;
                
                const frameCount = Math.floor(duration * fps);
                const frameDelay = 1000 / fps;
                
                // æ›´æ–°ç”»å¸ƒå°ºå¯¸
                this.canvas.width = this.video.videoWidth * scale;
                this.canvas.height = this.video.videoHeight * scale;
                
                // åˆå§‹åŒ– GIF ç¼–ç å™¨ï¼ˆä½¿ç”¨æ‰€æœ‰å‚æ•°ï¼‰
                const gif = new GIF({
                    workers: workers,
                    quality: quality,
                    width: this.canvas.width,
                    height: this.canvas.height,
                    workerScript: 'gif.worker.js',
                    repeat: repeat,
                    background: background,
                    transparent: transparent,
                    dither: dither,
                    debug: debug
                });
                
                this.updateStatus(`æ­£åœ¨è½¬æ¢... æ€»å…± ${frameCount} å¸§`, 'processing');
                this.progressBar.classList.add('active');
                this.convertBtn.disabled = true;
                
                // é€å¸§æ•è·
                for (let i = 0; i < frameCount; i++) {
                    const time = startTime + (i / fps);
                    await this.seekToTime(time);
                    
                    // ç»˜åˆ¶åˆ°ç”»å¸ƒ
                    this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
                    this.ctx.drawImage(this.video, 0, 0, this.canvas.width, this.canvas.height);
                    
                    // æ·»åŠ å¸§åˆ° GIFï¼ˆä½¿ç”¨é«˜çº§é€‰é¡¹ï¼‰
                    gif.addFrame(this.ctx, {
                        copy: true,
                        delay: frameDelay,
                        dispose: dispose
                    });
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = ((i + 1) / frameCount) * 50;
                    this.updateProgress(progress);
                }
                
                // ç›‘å¬è¿›åº¦å’Œå®Œæˆäº‹ä»¶
                gif.on('progress', (p) => {
                    this.updateProgress(50 + p * 50);
                });
                
                gif.on('finished', (blob) => {
                    this.gifBlob = blob;
                    const url = URL.createObjectURL(blob);
                    this.gifResult.src = url;
                    this.gifResult.style.display = 'block';
                    this.canvas.style.display = 'none';
                    
                    this.updateStatus(`è½¬æ¢å®Œæˆ! GIF å¤§å°: ${(blob.size / 1024).toFixed(2)} KB`, 'success');
                    this.progressBar.classList.remove('active');
                    this.convertBtn.disabled = false;
                    this.downloadBtn.disabled = false;
                });
                
                // å¼€å§‹æ¸²æŸ“
                gif.render();
            }

            updateProgress(percent) {
                this.progressBarFill.style.width = percent + '%';
                this.progressBarFill.textContent = Math.round(percent) + '%';
            }

            downloadGif() {
                if (!this.gifBlob) return;
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(this.gifBlob);
                link.download = `video-to-gif-${Date.now()}.gif`;
                link.click();
            }

            updateStatus(message, type = 'info') {
                this.status.textContent = message;
                this.status.className = `status ${type}`;
            }
            
            applyPreset(preset) {
                const presets = {
                    'high-quality': {
                        quality: 1,
                        frameRate: 24,
                        scale: 100,
                        workers: 4,
                        dither: 'FloydSteinberg',
                        description: 'é«˜è´¨é‡æ¨¡å¼: æœ€ä½³ç”»è´¨ï¼Œæ–‡ä»¶è¾ƒå¤§'
                    },
                    'balanced': {
                        quality: 10,
                        frameRate: 15,
                        scale: 75,
                        workers: 2,
                        dither: 'false',
                        description: 'å¹³è¡¡æ¨¡å¼: ç”»è´¨å’Œæ–‡ä»¶å¤§å°çš„å¹³è¡¡'
                    },
                    'small-size': {
                        quality: 20,
                        frameRate: 10,
                        scale: 50,
                        workers: 2,
                        dither: 'false',
                        description: 'å°æ–‡ä»¶æ¨¡å¼: æœ€å°åŒ–æ–‡ä»¶å¤§å°'
                    },
                    'smooth': {
                        quality: 5,
                        frameRate: 30,
                        scale: 100,
                        workers: 4,
                        dither: 'Atkinson',
                        description: 'æµç•…åŠ¨ç”»: é«˜å¸§ç‡ï¼ŒåŠ¨ç”»æµç•…'
                    },
                    'retro': {
                        quality: 15,
                        frameRate: 12,
                        scale: 50,
                        workers: 2,
                        dither: 'Stucki',
                        description: 'å¤å¤é£æ ¼: ç»å…¸ GIF æ•ˆæœ'
                    }
                };
                
                const settings = presets[preset];
                if (!settings) return;
                
                // Apply settings
                this.qualitySlider.value = settings.quality;
                this.frameRateSlider.value = settings.frameRate;
                this.scaleSlider.value = settings.scale;
                this.workersSlider.value = settings.workers;
                this.ditherSelect.value = settings.dither;
                
                // Update displays
                document.getElementById('qualityValue').textContent = settings.quality;
                document.getElementById('frameRateValue').textContent = settings.frameRate;
                document.getElementById('scaleValue').textContent = settings.scale + '%';
                document.getElementById('workersValue').textContent = settings.workers;
                
                // Update canvas size if video is loaded
                if (this.video.videoWidth) {
                    const scale = settings.scale / 100;
                    this.canvas.width = this.video.videoWidth * scale;
                    this.canvas.height = this.video.videoHeight * scale;
                }
                
                this.updateStatus(`å·²åº”ç”¨é¢„è®¾: ${settings.description}`, 'success');
            }
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            new VideoToGif();
        });
    </script>
</body>
</html>