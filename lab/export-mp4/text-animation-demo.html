<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡å­—åŠ¨ç”» MP4 å¯¼å‡ºæµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            backdrop-filter: blur(10px);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 10px;
            font-size: 2.5em;
            background: linear-gradient(135deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 18px;
        }
        
        canvas {
            border: 3px solid #ddd;
            border-radius: 12px;
            display: block;
            margin: 0 auto 20px;
            background: #000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .control-group {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .control-group h3 {
            margin: 0 0 15px 0;
            color: #495057;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
            font-size: 14px;
        }
        
        select, input, textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 12px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }
        
        select:focus, input:focus, textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
        }
        
        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
        }
        
        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .export-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            font-size: 16px;
            padding: 15px 30px;
            margin: 20px auto;
            display: block;
            width: auto;
            min-width: 250px;
        }
        
        .export-btn:hover:not(:disabled) {
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .progress-container {
            margin: 20px 0;
            display: none;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 15px;
        }
        
        .progress-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 13px;
            font-weight: 600;
            color: #333;
            z-index: 1;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .video-preview {
            margin-top: 30px;
            text-align: center;
            display: none;
        }
        
        video {
            max-width: 100%;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }
        
        .download-section {
            margin-top: 20px;
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .range-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .range-container input[type="range"] {
            flex: 1;
            margin-bottom: 0;
        }
        
        .range-value {
            min-width: 60px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }
        
        .text-preview {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            color: #6c757d;
            max-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ æ–‡å­—åŠ¨ç”» MP4 å¯¼å‡º</h1>
        <p class="subtitle">åˆ›å»ºç²¾ç¾çš„æ–‡å­—åŠ¨ç”»å¹¶å¯¼å‡ºä¸ºé«˜è´¨é‡ MP4 è§†é¢‘</p>
        
        <canvas id="textCanvas" width="800" height="600"></canvas>
        
        <div class="controls">
            <div class="control-group">
                <h3>ğŸ“ æ–‡å­—å†…å®¹</h3>
                <label>ä¸»è¦æ–‡å­—:</label>
                <textarea id="mainText" placeholder="è¾“å…¥è¦æ˜¾ç¤ºçš„æ–‡å­—å†…å®¹...">Hello World!
æ¬¢è¿ä½¿ç”¨æ–‡å­—åŠ¨ç”»
Canvas to MP4
ä¸“ä¸šè§†é¢‘å¯¼å‡º</textarea>
                <div class="text-preview" id="textPreview"></div>
                
                <label>åŠ¨ç”»ç±»å‹:</label>
                <select id="animationType">
                    <option value="typewriter">æ‰“å­—æœºæ•ˆæœ</option>
                    <option value="fade-in">æ·¡å…¥æ•ˆæœ</option>
                    <option value="slide-in">æ»‘å…¥æ•ˆæœ</option>
                    <option value="scale-up">ç¼©æ”¾æ•ˆæœ</option>
                    <option value="rainbow">å½©è™¹æ–‡å­—</option>
                    <option value="bounce">å¼¹è·³æ–‡å­—</option>
                </select>
            </div>
            
            <div class="control-group">
                <h3>ğŸ¨ æ–‡å­—æ ·å¼</h3>
                <label>å­—ä½“å¤§å°:</label>
                <div class="range-container">
                    <input type="range" id="fontSize" min="20" max="120" value="48">
                    <span class="range-value" id="fontSizeValue">48px</span>
                </div>
                
                <label>å­—ä½“æ—:</label>
                <select id="fontFamily">
                    <option value="Arial">Arial</option>
                    <option value="Helvetica">Helvetica</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Georgia">Georgia</option>
                    <option value="Verdana">Verdana</option>
                    <option value="Comic Sans MS">Comic Sans MS</option>
                    <option value="Impact">Impact</option>
                    <option value="Trebuchet MS">Trebuchet MS</option>
                </select>
                
                <label>æ–‡å­—é¢œè‰²:</label>
                <input type="color" id="textColor" value="#ffffff">
                
                <label>èƒŒæ™¯é¢œè‰²:</label>
                <input type="color" id="backgroundColor" value="#000000">
            </div>
            
            <div class="control-group">
                <h3>âš™ï¸ åŠ¨ç”»è®¾ç½®</h3>
                <label>åŠ¨ç”»é€Ÿåº¦:</label>
                <div class="range-container">
                    <input type="range" id="animationSpeed" min="0.5" max="3" step="0.1" value="1">
                    <span class="range-value" id="speedValue">1.0x</span>
                </div>
                
                <label>è¡Œé—´è·:</label>
                <div class="range-container">
                    <input type="range" id="lineHeight" min="1" max="3" step="0.1" value="1.5">
                    <span class="range-value" id="lineHeightValue">1.5</span>
                </div>
                
                <button id="startAnimation">â–¶ï¸ å¼€å§‹åŠ¨ç”»</button>
                <button id="stopAnimation">â¹ï¸ åœæ­¢åŠ¨ç”»</button>
            </div>
            
            <div class="control-group">
                <h3>ğŸ¥ å¯¼å‡ºè®¾ç½®</h3>
                <label>è§†é¢‘è´¨é‡:</label>
                <select id="qualitySelect">
                    <option value="1000000">æ ‡æ¸… (1 Mbps)</option>
                    <option value="2500000" selected>é«˜æ¸… (2.5 Mbps)</option>
                    <option value="5000000">è¶…æ¸… (5 Mbps)</option>
                </select>
                
                <label>å¸§ç‡:</label>
                <select id="fpsSelect">
                    <option value="24">24 FPS</option>
                    <option value="30" selected>30 FPS</option>
                    <option value="60">60 FPS</option>
                </select>
                
                <label>å½•åˆ¶æ—¶é•¿ (ç§’):</label>
                <input type="number" id="durationInput" value="8" min="3" max="30">
            </div>
        </div>
        
        <button id="exportBtn" class="export-btn">ğŸ¬ å¯¼å‡ºæ–‡å­—åŠ¨ç”» MP4</button>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
                <div class="progress-text" id="progressText">å‡†å¤‡ä¸­...</div>
            </div>
        </div>
        
        <div id="statusContainer"></div>
        
        <div class="video-preview" id="videoPreview">
            <h3>ğŸ“º è§†é¢‘é¢„è§ˆ</h3>
            <video id="previewVideo" controls></video>
            <div class="download-section">
                <button id="downloadBtn">ğŸ“¥ ä¸‹è½½ MP4 æ–‡ä»¶</button>
                <button id="playBtn">â–¶ï¸ æ’­æ”¾é¢„è§ˆ</button>
            </div>
        </div>
    </div>

    <!-- å¼•å…¥è„šæœ¬ -->
    <script src="../../mediabunny-loader.js"></script>
    <script src="text-animations.js"></script>
    <script src="canvas-exporter.js"></script>
    <script>
        // æ–‡å­—åŠ¨ç”» MP4 å¯¼å‡ºåº”ç”¨
        class TextAnimationApp {
            constructor() {
                this.canvas = null;
                this.textAnimations = null;
                this.exporter = null;
                this.isRecording = false;

                this.initializeApp();
            }

            async initializeApp() {
                try {
                    this.showStatus('æ­£åœ¨åˆå§‹åŒ–æ–‡å­—åŠ¨ç”»ç³»ç»Ÿ...', 'info');

                    // åˆå§‹åŒ–ç»„ä»¶
                    this.canvas = document.getElementById('textCanvas');
                    this.textAnimations = new TextAnimations(this.canvas);
                    this.exporter = new CanvasToMP4Exporter();

                    // ç»‘å®šäº‹ä»¶
                    this.bindEvents();

                    // æ›´æ–°æ–‡å­—é¢„è§ˆ
                    this.updateTextPreview();

                    // å¼€å§‹é»˜è®¤åŠ¨ç”»
                    this.textAnimations.start();

                    this.showStatus('âœ… æ–‡å­—åŠ¨ç”»ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success');
                    console.log('Text Animation App åˆå§‹åŒ–å®Œæˆ');

                } catch (error) {
                    console.error('åº”ç”¨åˆå§‹åŒ–å¤±è´¥:', error);
                    this.showStatus(`âŒ åˆå§‹åŒ–å¤±è´¥: ${error.message}`, 'error');
                }
            }

            bindEvents() {
                // åŠ¨ç”»æ§åˆ¶
                document.getElementById('startAnimation').addEventListener('click', () => {
                    this.updateAnimationSettings();
                    this.textAnimations.start();
                    this.showStatus('æ–‡å­—åŠ¨ç”»å·²å¼€å§‹', 'info');
                });

                document.getElementById('stopAnimation').addEventListener('click', () => {
                    this.textAnimations.stop();
                    this.showStatus('æ–‡å­—åŠ¨ç”»å·²åœæ­¢', 'info');
                });

                // æ–‡å­—å†…å®¹å˜åŒ–
                document.getElementById('mainText').addEventListener('input', () => {
                    this.updateTextPreview();
                    this.updateAnimationSettings();
                });

                // åŠ¨ç”»ç±»å‹å˜åŒ–
                document.getElementById('animationType').addEventListener('change', () => {
                    this.updateAnimationSettings();
                });

                // æ ·å¼è®¾ç½®å˜åŒ–
                ['fontSize', 'fontFamily', 'textColor', 'backgroundColor', 'animationSpeed', 'lineHeight'].forEach(id => {
                    document.getElementById(id).addEventListener('input', () => {
                        this.updateAnimationSettings();
                        if (id === 'fontSize') {
                            document.getElementById('fontSizeValue').textContent = document.getElementById(id).value + 'px';
                        } else if (id === 'animationSpeed') {
                            document.getElementById('speedValue').textContent = parseFloat(document.getElementById(id).value).toFixed(1) + 'x';
                        } else if (id === 'lineHeight') {
                            document.getElementById('lineHeightValue').textContent = parseFloat(document.getElementById(id).value).toFixed(1);
                        }
                    });
                });

                // å¯¼å‡ºæŒ‰é’®
                document.getElementById('exportBtn').addEventListener('click', () => {
                    this.startMP4Export();
                });

                // ä¸‹è½½å’Œæ’­æ”¾æŒ‰é’®
                document.getElementById('downloadBtn').addEventListener('click', () => {
                    this.downloadVideo();
                });

                document.getElementById('playBtn').addEventListener('click', () => {
                    const video = document.getElementById('previewVideo');
                    if (video.paused) {
                        video.play();
                    } else {
                        video.pause();
                    }
                });
            }

            updateTextPreview() {
                const text = document.getElementById('mainText').value;
                const preview = document.getElementById('textPreview');
                const lines = text.split('\n').filter(line => line.trim());
                preview.textContent = `æ–‡å­—è¡Œæ•°: ${lines.length}\næ€»å­—ç¬¦æ•°: ${text.length}\né¢„è§ˆ: ${text.substring(0, 50)}${text.length > 50 ? '...' : ''}`;
            }

            updateAnimationSettings() {
                if (!this.textAnimations) return;

                const settings = {
                    text: document.getElementById('mainText').value,
                    animationType: document.getElementById('animationType').value,
                    fontSize: parseInt(document.getElementById('fontSize').value),
                    fontFamily: document.getElementById('fontFamily').value,
                    textColor: document.getElementById('textColor').value,
                    backgroundColor: document.getElementById('backgroundColor').value,
                    speed: parseFloat(document.getElementById('animationSpeed').value),
                    lineHeight: parseFloat(document.getElementById('lineHeight').value)
                };

                this.textAnimations.updateSettings(settings);
            }

            async startMP4Export() {
                if (this.isRecording) {
                    this.showStatus('æ­£åœ¨å½•åˆ¶ä¸­ï¼Œè¯·ç­‰å¾…...', 'info');
                    return;
                }

                try {
                    this.isRecording = true;

                    // è·å–è®¾ç½®
                    const bitrate = parseInt(document.getElementById('qualitySelect').value);
                    const fps = parseInt(document.getElementById('fpsSelect').value);
                    const duration = parseInt(document.getElementById('durationInput').value);

                    // éªŒè¯è®¾ç½®
                    if (duration < 3 || duration > 30) {
                        throw new Error('å½•åˆ¶æ—¶é•¿å¿…é¡»åœ¨ 3-30 ç§’ä¹‹é—´');
                    }

                    // ç¡®ä¿åŠ¨ç”»è®¾ç½®æ˜¯æœ€æ–°çš„
                    this.updateAnimationSettings();

                    // æ˜¾ç¤ºè¿›åº¦
                    this.showProgress(true);
                    this.updateProgress(0, 'å‡†å¤‡å¯¼å‡ºæ–‡å­—åŠ¨ç”» MP4...');

                    // ç¦ç”¨æ§ä»¶
                    this.setControlsEnabled(false);

                    console.log('å¼€å§‹æ–‡å­—åŠ¨ç”» MP4 å¯¼å‡ºï¼Œè®¾ç½®:', { bitrate, fps, duration });

                    // ä½¿ç”¨ MediaBunny API å¯¼å‡º
                    const blob = await this.exportWithMediaBunny({
                        codec: 'avc',
                        bitrate,
                        fps,
                        duration,
                        onProgress: (progress, message) => {
                            this.updateProgress(progress, message);
                        }
                    });

                    // ä¿å­˜ blob
                    if (!this.exporter) {
                        this.exporter = {};
                    }
                    this.exporter.exportedBlob = blob;
                    console.log('å·²ä¿å­˜æ–‡å­—åŠ¨ç”» blobï¼Œå¤§å°:', blob.size, 'bytes');

                    // æ˜¾ç¤ºé¢„è§ˆ
                    this.showVideoPreview(blob);
                    this.showStatus('ğŸ‰ æ–‡å­—åŠ¨ç”» MP4 å¯¼å‡ºæˆåŠŸï¼', 'success');

                } catch (error) {
                    console.error('æ–‡å­—åŠ¨ç”» MP4 å¯¼å‡ºå¤±è´¥:', error);
                    this.showStatus(`âŒ å¯¼å‡ºå¤±è´¥: ${error.message}`, 'error');
                } finally {
                    this.isRecording = false;
                    this.showProgress(false);
                    this.setControlsEnabled(true);

                    // é‡æ–°å¼€å§‹åŠ¨ç”»
                    this.textAnimations.start();
                }
            }

            // ä½¿ç”¨ MediaBunny API å¯¼å‡ºæ–‡å­—åŠ¨ç”»
            async exportWithMediaBunny(options = {}) {
                const {
                    codec = 'avc',
                    bitrate = 2500000,
                    fps = 30,
                    duration = 8,
                    onProgress = () => {}
                } = options;

                // ç­‰å¾… MediaBunny åŠ è½½
                let mediabunny;
                if (window.mediabunnyLoader) {
                    mediabunny = await window.mediabunnyLoader.waitForLoad();
                } else {
                    throw new Error('MediaBunny åŠ è½½å™¨ä¸å¯ç”¨');
                }

                // ç¡®ä¿åŠ¨ç”»æ­£åœ¨è¿è¡Œ
                if (!this.textAnimations.isRunning) {
                    this.textAnimations.start();
                    await new Promise(resolve => setTimeout(resolve, 200));
                }

                onProgress(0.1, 'åˆ›å»º MediaBunny è¾“å‡º...');

                // åˆ›å»º Output
                const output = new mediabunny.Output({
                    format: new mediabunny.Mp4OutputFormat(),
                    target: new mediabunny.BufferTarget()
                });

                onProgress(0.2, 'åˆ›å»º Canvas è§†é¢‘æº...');

                // åˆ›å»º Canvas è§†é¢‘æº
                const qualityValue = typeof bitrate === 'number' ? bitrate : mediabunny.QUALITY_HIGH;
                const videoSource = new mediabunny.CanvasSource(this.canvas, {
                    codec: codec,
                    bitrate: qualityValue
                });

                onProgress(0.3, 'æ·»åŠ è§†é¢‘è½¨é“...');

                // æ·»åŠ è§†é¢‘è½¨é“
                output.addVideoTrack(videoSource);

                onProgress(0.4, 'å¯åŠ¨è¾“å‡º...');

                // å¼€å§‹è¾“å‡º
                await output.start();
                console.log('MediaBunny è¾“å‡ºå·²å¯åŠ¨');

                onProgress(0.5, 'å½•åˆ¶æ–‡å­—åŠ¨ç”»å¸§...');

                // è®¡ç®—æ€»å¸§æ•°
                const totalFrames = duration * fps;
                const frameDuration = 1 / fps;

                console.log(`å°†å½•åˆ¶ ${totalFrames} å¸§æ–‡å­—åŠ¨ç”»ï¼Œæ¯å¸§æŒç»­ ${frameDuration} ç§’`);

                // æ‰‹åŠ¨æ·»åŠ æ¯ä¸€å¸§
                for (let frameIndex = 0; frameIndex < totalFrames; frameIndex++) {
                    const timestamp = frameIndex * frameDuration;

                    // è®©åŠ¨ç”»ç³»ç»Ÿæ¸²æŸ“å½“å‰å¸§
                    await new Promise(resolve => requestAnimationFrame(resolve));

                    // æ·»åŠ å¸§åˆ°è§†é¢‘æµ
                    await videoSource.add(timestamp, frameDuration);

                    // æ›´æ–°è¿›åº¦
                    const progress = 0.5 + (frameIndex / totalFrames) * 0.4;
                    onProgress(progress, `å½•åˆ¶å¸§ ${frameIndex + 1}/${totalFrames}`);

                    // æ¯10å¸§è¾“å‡ºä¸€æ¬¡æ—¥å¿—
                    if (frameIndex % 10 === 0) {
                        console.log(`å·²å½•åˆ¶æ–‡å­—åŠ¨ç”»å¸§ ${frameIndex + 1}/${totalFrames}, æ—¶é—´æˆ³: ${timestamp.toFixed(3)}s`);
                    }
                }

                console.log('æ‰€æœ‰æ–‡å­—åŠ¨ç”»å¸§å½•åˆ¶å®Œæˆ');

                onProgress(0.9, 'å®Œæˆå½•åˆ¶ï¼Œç”Ÿæˆ MP4...');

                // å®Œæˆè¾“å‡º
                await output.finalize();
                console.log('MediaBunny è¾“å‡ºå·²å®Œæˆ');

                onProgress(0.95, 'è·å–ç»“æœ...');

                // è·å–ç»“æœ
                const buffer = output.target.buffer;
                console.log('è¾“å‡º buffer å¤§å°:', buffer ? buffer.byteLength : 0, 'bytes');

                if (!buffer || buffer.byteLength === 0) {
                    throw new Error('ç”Ÿæˆçš„ MP4 buffer ä¸ºç©º');
                }

                const blob = new Blob([buffer], { type: 'video/mp4' });
                console.log('æœ€ç»ˆæ–‡å­—åŠ¨ç”» MP4 blob å¤§å°:', blob.size, 'bytes');

                onProgress(1.0, 'æ–‡å­—åŠ¨ç”» MP4 å¯¼å‡ºå®Œæˆï¼');
                return blob;
            }

            showVideoPreview(blob) {
                const previewContainer = document.getElementById('videoPreview');
                const previewVideo = document.getElementById('previewVideo');

                // æ¸…ç†ä¹‹å‰çš„ URL
                if (previewVideo.src) {
                    URL.revokeObjectURL(previewVideo.src);
                }

                // è®¾ç½®æ–°çš„è§†é¢‘æº
                previewVideo.src = URL.createObjectURL(blob);
                previewContainer.style.display = 'block';

                // æ»šåŠ¨åˆ°é¢„è§ˆåŒºåŸŸ
                previewContainer.scrollIntoView({ behavior: 'smooth' });
            }

            downloadVideo() {
                try {
                    if (!this.exporter || !this.exporter.exportedBlob) {
                        throw new Error('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
                    }

                    const animationType = document.getElementById('animationType').value;
                    const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                    const filename = `text-animation-${animationType}-${timestamp}.mp4`;

                    const url = URL.createObjectURL(this.exporter.exportedBlob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.showStatus('ğŸ“¥ æ–‡å­—åŠ¨ç”» MP4 ä¸‹è½½å·²å¼€å§‹', 'success');
                } catch (error) {
                    this.showStatus(`âŒ ä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
                }
            }

            showProgress(show) {
                const progressContainer = document.getElementById('progressContainer');
                progressContainer.style.display = show ? 'block' : 'none';
            }

            updateProgress(progress, message) {
                const progressFill = document.getElementById('progressFill');
                const progressText = document.getElementById('progressText');

                progressFill.style.width = `${progress * 100}%`;
                progressText.textContent = message;
            }

            showStatus(message, type = 'info') {
                const statusContainer = document.getElementById('statusContainer');

                statusContainer.innerHTML = '';

                const statusDiv = document.createElement('div');
                statusDiv.className = `status ${type}`;
                statusDiv.textContent = message;

                statusContainer.appendChild(statusDiv);

                if (type === 'success' || type === 'info') {
                    setTimeout(() => {
                        if (statusDiv.parentNode) {
                            statusDiv.parentNode.removeChild(statusDiv);
                        }
                    }, 5000);
                }
            }

            setControlsEnabled(enabled) {
                const controls = [
                    'mainText', 'animationType', 'fontSize', 'fontFamily',
                    'textColor', 'backgroundColor', 'animationSpeed', 'lineHeight',
                    'qualitySelect', 'fpsSelect', 'durationInput', 'exportBtn'
                ];

                controls.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.disabled = !enabled;
                    }
                });
            }
        }

        // å½“é¡µé¢åŠ è½½å®Œæˆæ—¶åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', () => {
            window.textAnimationApp = new TextAnimationApp();
        });
    </script>
</body>
</html>
