<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è°ƒè¯• Mediabunny åŠ è½½</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .log {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #007bff;
        }
        .error {
            border-left-color: #dc3545;
            background-color: #f8d7da;
        }
        .success {
            border-left-color: #28a745;
            background-color: #d4edda;
        }
        .warning {
            border-left-color: #ffc107;
            background-color: #fff3cd;
        }
    </style>
</head>
<body>
    <h1>ğŸ” Mediabunny åŠ è½½è°ƒè¯•</h1>
    <div id="logs"></div>

    <script>
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = `log ${type}`;
            div.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logsDiv.appendChild(div);
            console.log(message);
        }

        async function debugMediabunnyLoading() {
            log('ğŸ”„ å¼€å§‹è°ƒè¯• Mediabunny åŠ è½½è¿‡ç¨‹...');

            // 1. æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            try {
                log('ğŸ“ æ£€æŸ¥ libs/mediabunny.js æ–‡ä»¶æ˜¯å¦å­˜åœ¨...');
                const response = await fetch('./libs/mediabunny.js');
                if (response.ok) {
                    log('âœ… libs/mediabunny.js æ–‡ä»¶å­˜åœ¨', 'success');
                    log(`ğŸ“Š æ–‡ä»¶å¤§å°: ${response.headers.get('content-length')} bytes`);
                    log(`ğŸ“‹ Content-Type: ${response.headers.get('content-type')}`);
                } else {
                    log(`âŒ æ–‡ä»¶ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: ${response.status} ${response.statusText}`, 'error');
                    return;
                }
            } catch (error) {
                log(`âŒ æ£€æŸ¥æ–‡ä»¶æ—¶å‡ºé”™: ${error.message}`, 'error');
                return;
            }

            // 2. å°è¯•åŠ¨æ€å¯¼å…¥
            try {
                log('ğŸ”„ å°è¯•åŠ¨æ€å¯¼å…¥ Mediabunny æ¨¡å—...');
                const MediabunnyModule = await import('./libs/mediabunny.js');
                log('âœ… åŠ¨æ€å¯¼å…¥æˆåŠŸ', 'success');
                log(`ğŸ“¦ å¯¼å‡ºçš„é”®: ${Object.keys(MediabunnyModule).slice(0, 10).join(', ')}...`);
                
                // 3. æ£€æŸ¥å…³é”®ç±»
                const requiredClasses = ['Input', 'Output', 'Conversion', 'BlobSource', 'Mp4OutputFormat', 'BufferTarget'];
                let allFound = true;
                
                for (const className of requiredClasses) {
                    if (MediabunnyModule[className]) {
                        log(`âœ… ${className} ç±»å­˜åœ¨`, 'success');
                    } else {
                        log(`âŒ ${className} ç±»ä¸å­˜åœ¨`, 'error');
                        allFound = false;
                    }
                }
                
                if (allFound) {
                    // 4. è®¾ç½®å…¨å±€å˜é‡
                    window.Mediabunny = {
                        Input: MediabunnyModule.Input,
                        Output: MediabunnyModule.Output,
                        Conversion: MediabunnyModule.Conversion,
                        BlobSource: MediabunnyModule.BlobSource,
                        Mp4OutputFormat: MediabunnyModule.Mp4OutputFormat,
                        BufferTarget: MediabunnyModule.BufferTarget,
                        ALL_FORMATS: MediabunnyModule.ALL_FORMATS,
                        ...MediabunnyModule
                    };
                    
                    log('âœ… å…¨å±€ Mediabunny å¯¹è±¡å·²åˆ›å»º', 'success');
                    log(`ğŸ“Š å…¨å±€å¯¹è±¡åŒ…å« ${Object.keys(window.Mediabunny).length} ä¸ªå±æ€§`);
                    
                    // 5. æµ‹è¯•åŸºæœ¬åŠŸèƒ½
                    try {
                        log('ğŸ§ª æµ‹è¯•åŸºæœ¬åŠŸèƒ½...');
                        
                        // æµ‹è¯• Input ç±»
                        if (typeof window.Mediabunny.Input === 'function') {
                            log('âœ… Input ç±»å¯ä»¥è°ƒç”¨', 'success');
                        } else {
                            log('âŒ Input ç±»ä¸æ˜¯å‡½æ•°', 'error');
                        }
                        
                        // æµ‹è¯• Output ç±»
                        if (typeof window.Mediabunny.Output === 'function') {
                            log('âœ… Output ç±»å¯ä»¥è°ƒç”¨', 'success');
                        } else {
                            log('âŒ Output ç±»ä¸æ˜¯å‡½æ•°', 'error');
                        }
                        
                        // æµ‹è¯• Conversion ç±»
                        if (typeof window.Mediabunny.Conversion === 'function') {
                            log('âœ… Conversion ç±»å¯ä»¥è°ƒç”¨', 'success');
                        } else {
                            log('âŒ Conversion ç±»ä¸æ˜¯å‡½æ•°', 'error');
                        }
                        
                        log('ğŸ‰ Mediabunny åŠ è½½å’Œæµ‹è¯•å®Œæˆï¼', 'success');
                        
                        // è§¦å‘åŠ è½½å®Œæˆäº‹ä»¶
                        window.dispatchEvent(new CustomEvent('mediabunnyLoaded', { 
                            detail: { Mediabunny: window.Mediabunny } 
                        }));
                        log('ğŸ“¢ å·²è§¦å‘ mediabunnyLoaded äº‹ä»¶', 'success');
                        
                    } catch (testError) {
                        log(`âŒ åŸºæœ¬åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${testError.message}`, 'error');
                    }
                } else {
                    log('âŒ ç¼ºå°‘å¿…éœ€çš„ç±»ï¼Œæ— æ³•ç»§ç»­', 'error');
                }
                
            } catch (importError) {
                log(`âŒ åŠ¨æ€å¯¼å…¥å¤±è´¥: ${importError.message}`, 'error');
                log(`ğŸ“‹ é”™è¯¯è¯¦æƒ…: ${importError.stack}`, 'error');
                
                // å°è¯•å¤‡ç”¨æ–¹æ¡ˆï¼šç›´æ¥åŠ è½½ä¸ºè„šæœ¬
                log('ğŸ”„ å°è¯•å¤‡ç”¨æ–¹æ¡ˆï¼šä½œä¸ºæ™®é€šè„šæœ¬åŠ è½½...', 'warning');
                try {
                    const script = document.createElement('script');
                    script.src = './libs/mediabunny.js';
                    script.onload = () => {
                        log('âœ… ä½œä¸ºæ™®é€šè„šæœ¬åŠ è½½æˆåŠŸ', 'success');
                        if (typeof window.Mediabunny !== 'undefined') {
                            log('âœ… å…¨å±€ Mediabunny å¯¹è±¡å¯ç”¨', 'success');
                        } else {
                            log('âŒ å…¨å±€ Mediabunny å¯¹è±¡ä¸å¯ç”¨', 'error');
                        }
                    };
                    script.onerror = (error) => {
                        log(`âŒ ä½œä¸ºæ™®é€šè„šæœ¬åŠ è½½ä¹Ÿå¤±è´¥: ${error.message}`, 'error');
                    };
                    document.head.appendChild(script);
                } catch (scriptError) {
                    log(`âŒ å¤‡ç”¨æ–¹æ¡ˆä¹Ÿå¤±è´¥: ${scriptError.message}`, 'error');
                }
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåå¼€å§‹è°ƒè¯•
        window.addEventListener('load', () => {
            setTimeout(debugMediabunnyLoading, 100);
        });

        // ç›‘å¬åŠ è½½äº‹ä»¶
        window.addEventListener('mediabunnyLoaded', (event) => {
            log('ğŸ“¢ æ”¶åˆ° mediabunnyLoaded äº‹ä»¶', 'success');
            log(`ğŸ“¦ äº‹ä»¶è¯¦æƒ…: ${Object.keys(event.detail.Mediabunny).length} ä¸ªå±æ€§`);
        });
    </script>
</body>
</html>
