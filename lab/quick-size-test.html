<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«é€Ÿå°ºå¯¸æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; color: #155724; }
        .error { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
        .warning { background-color: #fff3cd; color: #856404; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background-color: #007bff;
            color: white;
            cursor: pointer;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        video {
            max-width: 100%;
            margin: 10px 0;
            border: 1px solid #ddd;
        }
        .comparison {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .video-item {
            flex: 1;
            text-align: center;
        }
        .size-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin: 5px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>âš¡ å¿«é€Ÿå°ºå¯¸æµ‹è¯•</h1>
    
    <div class="result info">
        <strong>æµ‹è¯•ç›®æ ‡ï¼š</strong>éªŒè¯ MP4 è½¬ç çš„è¾“å‡ºå°ºå¯¸æ˜¯å¦æ­£ç¡®åŒ…å«ç¼–è¾‘æ•ˆæœ
    </div>
    
    <button onclick="runQuickTest()">å¼€å§‹å¿«é€Ÿæµ‹è¯•</button>
    <button onclick="runFullTest()" id="fullTestBtn" disabled>å®Œæ•´æµ‹è¯•ï¼ˆéœ€è¦å½•åˆ¶ï¼‰</button>
    
    <div id="results"></div>
    
    <div class="comparison" id="videoComparison" style="display: none;">
        <div class="video-item">
            <h4>åŸå§‹è§†é¢‘</h4>
            <video id="originalVideo" controls></video>
            <div id="originalInfo" class="size-info"></div>
        </div>
        <div class="video-item">
            <h4>è½¬ç åè§†é¢‘</h4>
            <video id="transcodedVideo" controls></video>
            <div id="transcodedInfo" class="size-info"></div>
        </div>
    </div>

    <script src="popup/canvas-mp4-transcoder.js"></script>
    <script src="popup/backgroundProcessor.js"></script>
    <script>
        let transcoder = null;
        let backgroundProcessor = null;
        let testWebMBlob = null;

        window.onload = function() {
            transcoder = new CanvasMP4Transcoder();
            backgroundProcessor = new BackgroundProcessor();
            console.log('âš¡ å¿«é€Ÿå°ºå¯¸æµ‹è¯•å·²åŠ è½½');
        };

        // å¿«é€Ÿæµ‹è¯•ï¼ˆä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼‰
        async function runQuickTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="result info">æ­£åœ¨è¿›è¡Œå¿«é€Ÿæµ‹è¯•...</div>';

            try {
                // 1. åˆ›å»ºæ¨¡æ‹Ÿè§†é¢‘ä¿¡æ¯
                const videoInfo = {
                    width: 1280,
                    height: 720,
                    duration: 5,
                    aspectRatio: 1280 / 720
                };

                // 2. æµ‹è¯•é…ç½®
                const backgroundConfig = {
                    color: '#0066cc',
                    padding: 60,
                    outputRatio: '1:1'
                };

                console.log('ğŸ“Š æ¨¡æ‹Ÿè§†é¢‘ä¿¡æ¯:', videoInfo);
                console.log('ğŸ¨ æµ‹è¯•é…ç½®:', backgroundConfig);

                // 3. BackgroundProcessor è®¡ç®—
                const bgResult = backgroundProcessor.createCompositeCanvas(backgroundConfig, videoInfo);
                console.log('ğŸ”§ BackgroundProcessor ç»“æœ:', {
                    canvasSize: { width: bgResult.canvas.width, height: bgResult.canvas.height },
                    layout: bgResult.layout
                });

                // 4. MP4 Transcoder è®¡ç®—
                const transcoderResult = transcoder.createEditingCanvas(backgroundConfig, videoInfo);
                console.log('ğŸ”§ MP4 Transcoder ç»“æœ:', {
                    canvasSize: { width: transcoderResult.canvas.width, height: transcoderResult.canvas.height },
                    layout: transcoderResult.layout
                });

                // 5. å¯¹æ¯”ç»“æœ
                const canvasSizeMatch = bgResult.canvas.width === transcoderResult.canvas.width && 
                                       bgResult.canvas.height === transcoderResult.canvas.height;

                const expectedSize = Math.max(1280, 720) + 60 * 2; // 1:1 æ¯”ä¾‹ + è¾¹è·

                resultsDiv.innerHTML = `
                    <div class="result ${canvasSizeMatch ? 'success' : 'error'}">
                        <strong>ğŸ“ å¿«é€Ÿæµ‹è¯•ç»“æœ:</strong><br><br>
                        
                        <strong>è¾“å…¥:</strong><br>
                        â€¢ åŸå§‹è§†é¢‘: ${videoInfo.width} Ã— ${videoInfo.height}<br>
                        â€¢ èƒŒæ™¯è‰²: ${backgroundConfig.color}<br>
                        â€¢ è¾¹è·: ${backgroundConfig.padding}px<br>
                        â€¢ è¾“å‡ºæ¯”ä¾‹: ${backgroundConfig.outputRatio}<br><br>
                        
                        <strong>è®¡ç®—ç»“æœ:</strong><br>
                        â€¢ BackgroundProcessor: ${bgResult.canvas.width} Ã— ${bgResult.canvas.height}<br>
                        â€¢ MP4 Transcoder: ${transcoderResult.canvas.width} Ã— ${transcoderResult.canvas.height}<br>
                        â€¢ é¢„æœŸå°ºå¯¸: çº¦ ${expectedSize} Ã— ${expectedSize}<br><br>
                        
                        <strong>ä¸€è‡´æ€§æ£€æŸ¥:</strong><br>
                        ${canvasSizeMatch ? 'âœ… ä¸¤ç§æ–¹æ³•è®¡ç®—ç»“æœä¸€è‡´' : 'âŒ ä¸¤ç§æ–¹æ³•è®¡ç®—ç»“æœä¸ä¸€è‡´'}<br>
                        ${transcoderResult.canvas.width > videoInfo.width ? 'âœ… åŒ…å«ç¼–è¾‘æ•ˆæœ' : 'âŒ æœªåŒ…å«ç¼–è¾‘æ•ˆæœ'}
                    </div>
                `;

                // å¯ç”¨å®Œæ•´æµ‹è¯•
                document.getElementById('fullTestBtn').disabled = false;

            } catch (error) {
                resultsDiv.innerHTML = `
                    <div class="result error">
                        å¿«é€Ÿæµ‹è¯•å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // å®Œæ•´æµ‹è¯•ï¼ˆéœ€è¦å½•åˆ¶ï¼‰
        async function runFullTest() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML += '<div class="result info">å¼€å§‹å®Œæ•´æµ‹è¯•ï¼Œéœ€è¦å½•åˆ¶å±å¹•...</div>';

            try {
                // 1. å½•åˆ¶å±å¹•
                const stream = await navigator.mediaDevices.getDisplayMedia({
                    video: { width: 1280, height: 720 },
                    audio: false
                });

                const mimeType = getSupportedWebMMimeType();
                const recorder = new MediaRecorder(stream, {
                    mimeType: mimeType,
                    videoBitsPerSecond: 5000000
                });

                const chunks = [];

                recorder.ondataavailable = (e) => {
                    if (e.data.size > 0) {
                        chunks.push(e.data);
                    }
                };

                recorder.onstop = async () => {
                    testWebMBlob = new Blob(chunks, { type: mimeType });
                    
                    // æ˜¾ç¤ºåŸå§‹è§†é¢‘
                    const originalVideo = document.getElementById('originalVideo');
                    originalVideo.src = URL.createObjectURL(testWebMBlob);
                    
                    originalVideo.onloadedmetadata = async () => {
                        document.getElementById('originalInfo').innerHTML = `
                            å°ºå¯¸: ${originalVideo.videoWidth} Ã— ${originalVideo.videoHeight}<br>
                            æ—¶é•¿: ${originalVideo.duration.toFixed(2)}ç§’<br>
                            å¤§å°: ${formatFileSize(testWebMBlob.size)}
                        `;

                        // è¿›è¡Œè½¬ç 
                        await performTranscodeTest();
                    };

                    stream.getTracks().forEach(track => track.stop());
                };

                recorder.start();
                
                // 3ç§’ååœæ­¢å½•åˆ¶
                setTimeout(() => {
                    if (recorder.state === 'recording') {
                        recorder.stop();
                    }
                }, 3000);

                resultsDiv.innerHTML += '<div class="result info">ğŸ“¹ å½•åˆ¶ä¸­... (3ç§’)</div>';

            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="result error">
                        å®Œæ•´æµ‹è¯•å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // æ‰§è¡Œè½¬ç æµ‹è¯•
        async function performTranscodeTest() {
            const resultsDiv = document.getElementById('results');
            
            try {
                resultsDiv.innerHTML += '<div class="result info">æ­£åœ¨è½¬ç ...</div>';

                const result = await transcoder.transcodeToMP4(testWebMBlob, {
                    backgroundConfig: {
                        color: '#0066cc',
                        padding: 60,
                        outputRatio: '1:1'
                    },
                    quality: 'high',
                    progressCallback: (percent, message) => {
                        console.log(`è½¬ç è¿›åº¦: ${percent}% - ${message}`);
                    }
                });

                // æ˜¾ç¤ºè½¬ç åè§†é¢‘
                const transcodedVideo = document.getElementById('transcodedVideo');
                transcodedVideo.src = URL.createObjectURL(result);
                
                transcodedVideo.onloadedmetadata = () => {
                    const originalVideo = document.getElementById('originalVideo');
                    
                    document.getElementById('transcodedInfo').innerHTML = `
                        å°ºå¯¸: ${transcodedVideo.videoWidth} Ã— ${transcodedVideo.videoHeight}<br>
                        æ—¶é•¿: ${transcodedVideo.duration.toFixed(2)}ç§’<br>
                        å¤§å°: ${formatFileSize(result.size)}<br>
                        æ ¼å¼: ${result.type}
                    `;

                    // æ˜¾ç¤ºå¯¹æ¯”ç»“æœ
                    const sizeIncreased = transcodedVideo.videoWidth > originalVideo.videoWidth;
                    const isSquare = Math.abs(transcodedVideo.videoWidth - transcodedVideo.videoHeight) < 10;

                    resultsDiv.innerHTML += `
                        <div class="result ${sizeIncreased && isSquare ? 'success' : 'warning'}">
                            <strong>ğŸ¬ å®Œæ•´æµ‹è¯•ç»“æœ:</strong><br><br>
                            
                            <strong>å°ºå¯¸å˜åŒ–:</strong><br>
                            â€¢ åŸå§‹: ${originalVideo.videoWidth} Ã— ${originalVideo.videoHeight}<br>
                            â€¢ è½¬ç å: ${transcodedVideo.videoWidth} Ã— ${transcodedVideo.videoHeight}<br>
                            â€¢ å°ºå¯¸å¢åŠ : ${sizeIncreased ? 'âœ… æ˜¯' : 'âŒ å¦'}<br>
                            â€¢ 1:1 æ¯”ä¾‹: ${isSquare ? 'âœ… æ˜¯' : 'âŒ å¦'}<br><br>
                            
                            <strong>é¢„æœŸæ•ˆæœ:</strong><br>
                            â€¢ è“è‰²èƒŒæ™¯: ${result.type.includes('webm') ? 'âš ï¸ WebMæ ¼å¼' : 'âœ… åº”è¯¥æœ‰'}<br>
                            â€¢ 60px è¾¹è·: ${sizeIncreased ? 'âœ… åº”è¯¥æœ‰' : 'âŒ å¯èƒ½æ²¡æœ‰'}<br>
                            â€¢ æ­£æ–¹å½¢è¾“å‡º: ${isSquare ? 'âœ… æ­£ç¡®' : 'âŒ ä¸æ­£ç¡®'}<br><br>
                            
                            ${sizeIncreased && isSquare ? 
                                'ğŸ‰ æµ‹è¯•é€šè¿‡ï¼å°ºå¯¸è®¡ç®—æ­£ç¡®ã€‚' : 
                                'âš ï¸ æµ‹è¯•æœªå®Œå…¨é€šè¿‡ï¼Œå¯èƒ½éœ€è¦è¿›ä¸€æ­¥è°ƒè¯•ã€‚'}
                        </div>
                    `;

                    // æ˜¾ç¤ºè§†é¢‘å¯¹æ¯”
                    document.getElementById('videoComparison').style.display = 'flex';
                };

            } catch (error) {
                resultsDiv.innerHTML += `
                    <div class="result error">
                        è½¬ç æµ‹è¯•å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // è·å–æ”¯æŒçš„ WebM MIME ç±»å‹
        function getSupportedWebMMimeType() {
            const types = [
                'video/webm;codecs=vp9',
                'video/webm;codecs=vp8',
                'video/webm'
            ];

            for (const type of types) {
                if (MediaRecorder.isTypeSupported(type)) {
                    return type;
                }
            }
            return 'video/webm';
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
    </script>
</body>
</html>
